
# ------------------------- 1. ПОДГОТОВКА СРЕДЫ ---------------------------

## 1.1 Установка пакетов (выполнить один раз)
# install.packages("tidyverse")
#remotes::install_github("DTUAqua/spict/spict") # Установка SPiCT
#install.packages("TMB", type="source")

## 1.2 Загрузка библиотек
library(spict)   # Основной пакет для моделирования
library(tidyverse) # Для обработки данных и визуализации


## 1.3 Установка рабочей директории
setwd("C:/SPICT") # Укажите вашу рабочую папку


# ------------------------- 2. ЗАГРУЗКА ДАННЫХ ---------------------------

## 2.1 Вектор лет наблюдений
Year <- 2005:2024

## 2.2 Данные по вылову (тыс. тонн)
Catch <- c(5,  7,  6, 10, 14, 25, 28, 30, 32, 35, 25, 20, 15, 12, 10, 12, 10, 13, 11, 12)

## 2.3 Индекс CPUE (промысловый индекс)
CPUEIndex <- c(27.427120, 26.775958, 16.811997, 22.979653, 29.048568, 29.996072, 16.476301,
17.174455, 10.537272, 14.590435,  8.286352, 11.394168, 15.537878, 13.791166,
11.527548, 15.336093, 12.154069, 15.568450, 16.221933, 13.421132)

## 2.4 Индекс BESS (научная съемка)
BESSIndex <- c( NA, 16.270375, 20.691355, 15.141784, 18.594620, 15.975548, 13.792012,
13.328805, 11.659744, 11.753855,  9.309859,  7.104886,  7.963839,  9.161322,
10.271221,  9.822960, 10.347376, 11.703610, 13.679876, 13.413696)



# График кросс-корреляции: Catch и BESSindex (только данные без пропусков)
ccf(na.omit(Catch), na.omit(BESSIndex),
    main = "Кросс-корреляция: Уловы и BESSindex",
    xlab = "Лаг (годы)", ylab = "Корреляция")


# График кросс-корреляции: Catch и CPUEIndex (только данные без пропусков)
ccf(na.omit(Catch), na.omit(CPUEIndex),
    main = "Кросс-корреляция: Уловы и CPUEIndex",
    xlab = "Лаг (годы)", ylab = "Корреляция")



# ------------------- 3. ПОДГОТОВКА ДАННЫХ ДЛЯ SPiCT --------------------

## 3.1 Форматирование данных в список SPiCT
input_new <- list(
  timeC = Year,     # Годы вылова
  obsC = Catch,     # Значения вылова
  timeI = list(     # Временные точки для индексов:
    Year + 0.5,     #  CPUE - середина года (июль)
    Year + 0.75     #  BESS - 3/4 года (октябрь)
  ),
  obsI = list(
    CPUEIndex,      # Значения индекса CPUE
    BESSIndex       # Значения индекса BESS
  )
)

## 3.2 Проверка и подготовка входных данных
inp <- check.inp(input_new, verbose = TRUE)


# ------------------- 4. НАСТРОЙКА МОДЕЛИ --------------------

## 4.1 Установка априорных распределений
inp$priors$logn <- c(log(2), 0.1, 1)   # Приор для n (модель Шефера)
inp$ini$logn <- log(2)                  # Начальное значение
inp$phases$logn <- -1                   # Фиксируем параметр (не оцениваем)

inp$priors$logK <- c(5, 0.7, 1)       # Приор для несущей способности (K)
inp$priors$logbkfrac <- c(log(0.75),0.25,1) # Начальный уровень эксплуатации



## 4.2 Настройка неопределенности данных
# Повышаем неопределенность для последнего года вылова
inp$stdevfacC[length(inp$stdevfacC)] <- 2 

# Повышаем неопределенность для последнего значения BESS
inp$stdevfacI[[2]][length(inp$stdevfacI[[2]])] <- 2 

## 4.3 Настройка временного шага
inp$dteuler <- 1/16  # Более точная дискретизация (по умолчанию 1)

## 4.4 Включение оценки ковариации
inp$getJointPrecision <- TRUE # Для оценки случайных эффектов


# ----------------- 5. ВИЗУАЛИЗАЦИЯ ВХОДНЫХ ДАННЫХ -----------------

## 5.1 Общий график данных
plotspict.data(inp)

plotspict.ci(inp)

# ------------------- 6. ЗАПУСК МОДЕЛИ --------------------

## 6.1 Настройка оптимизатора
inp$optimiser.control = list(iter.max = 1e5, eval.max = 1e5)

## 6.2 Подгонка модели
fit <- fit.spict(inp)

## 6.3 Добавление OSA-остатков
fit <- calc.osa.resid(fit) 


# ----------------- 7. ДИАГНОСТИКА СХОДИМОСТИ -----------------

## 7.1 Проверка сходимости
fit$opt$convergence  # 0 = успешная сходимость

## 7.2 Проверка конечных значений
all(is.finite(fit$sd)) # TRUE = все параметры конечны


# ----------------- 8. ДИАГНОСТИКА МОДЕЛИ -----------------

## 8.1 График остатков
plotspict.osar(fit) 

## 8.2 Общая диагностика
plotspict.diagnostic(fit)

## 8.3 Сравнение априорных и апостериорных распределений
plotspict.priors(fit)

## 8.4 Проверка корреляции параметров
cov2cor(fit$cov.fixed)        # Матрица корреляций
cov2cor(fit$cov.fixed) > 0.8  # Выявление сильных корреляций (>0.8)


# ----------------- 9. ВИЗУАЛИЗАЦИЯ РЕЗУЛЬТАТОВ -----------------

## 9.1 Основные графики
plot(fit) # Комплексный отчет

## 9.2 Биомасса в абсолютных величинах
plotspict.biomass(
  fit,
  logax = FALSE,       # Линейная шкала
  main = "Абсолютная биомасса",
  ylim = c(0, 250),   # Ограничение по оси Y
  plot.obs = TRUE,     # Отображать наблюдения
  xlab = "Год",
  CI = 0.95,            # 95% доверительный интервал
  qlegend = FALSE,
  rel.axes = TRUE,
  rel.ci = TRUE
)


## 9.3 Относительная биомасса (B/Bmsy)
plotspict.bbmsy(fit,qlegend = FALSE)

## 9.4 Вылов
plotspict.catch(fit,qlegend = FALSE)

## 9.5 Относительная смертность (F/Fmsy)
plotspict.ffmsy(fit,qlegend = FALSE)

## 9.6 Продукционная кривая
plotspict.production(fit)

## 9.7 Kobe plot
plotspict.fb(fit, ylim=c(0, 0.5), xlim=c(0, 200))


# ----------------- 10. АНАЛИЗ РЕЗУЛЬТАТОВ -----------------

## 10.1 Краткий отчет
summary(fit)

## 10.2 Точечные оценки параметров
pars <- sumspict.parest(fit)

## 10.3 Ориентиры управления(стохастические)
sumspict.srefpoints(fit)

## 10.4 Ориентиры управления(детерминированные)
sumspict.drefpoints(fit)


# -------------- 11. РЕТРОСПЕКТИВНЫЙ АНАЛИЗ --------------

## 11.1 Запуск ретроспективного анализа
fit <- retro(fit)

## 11.2 Визуализация ретроспективы
plotspict.retro(fit, add.mohn = TRUE, CI = 0.95)

## Интерпретация коэффициента Мона (Mohn's rho):
## Долгоживущие виды: |rho| > 0.2 значимо
## Короткоживущие виды: |rho| > 0.3 значимо


# ----------- 12. ПРОГНОЗИРОВАНИЕ И СЦЕНАРИИ УПРАВЛЕНИЯ -----------

## 12.1 Установка интервала управления
inp$maninterval <- c(2025, 2026) # Годы прогноза

## 12.2 Базовые сценарии управления
fit <- manage(fit)

## 12.3 Пользовательские сценарии (постоянный вылов)
catchvals = c(10, 12, 15, 17) # Варианты вылова в тыс.тонн

for(i in seq_along(catchvals)){
  fit <- add.man.scenario(
    fit,
    scenarioTitle = paste0("Постоянный вылов ", catchvals[i], " тыс.т"),
    cabs = catchvals[i]  # Абсолютный вылов
  )
}

## 12.4 Сводка по сценариям управления
sumspict.manage(fit, include.unc = TRUE) # С учетом неопределенности

