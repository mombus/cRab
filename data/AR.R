# =============================================================================
# ПРАКТИЧЕСКОЕ ЗАНЯТИЕ: АВТОРЕГРЕССИЯ AR(1) В ГИДРОБИОЛОГИИ
# Модель колебаний температуры воды
# =============================================================================

# Очистим рабочее пространство
rm(list = ls())

# Загружаем необходимые пакеты
library(ggplot2)
library(dplyr)

# =============================================================================
# ПАРАМЕТРЫ МОДЕЛИ AR(1)
# =============================================================================

# Время моделирования (дни)
n_days <- 100

# Количество симуляций
n_simulations <- 6

# Параметры AR(1) для температуры воды
phi_values <- c(0.2, 0.5, 0.8, 0.95)  # разные уровни "памяти" системы
sigma_temp <- 1.5  # волатильность температуры

# =============================================================================
# ФУНКЦИИ МОДЕЛИРОВАНИЯ
# =============================================================================

# Функция для генерации AR(1) процесса
simulate_ar1 <- function(n, phi, sigma, initial = 0) {
  x <- numeric(n)
  x[1] <- initial
  for (t in 2:n) {
    x[t] <- phi * x[t-1] + rnorm(1, 0, sigma)
  }
  return(x)
}

# =============================================================================
# МОДЕЛИРОВАНИЕ AR(1) ПРОЦЕССОВ
# =============================================================================

cat("=== МОДЕЛИРОВАНИЕ AR(1) ПРОЦЕССОВ ===\n")

results <- list()

for (phi in phi_values) {
  cat("Моделируем AR(1) с φ =", phi, "...\n")
  
  # Матрица для хранения результатов
  temp_matrix <- matrix(NA, nrow = n_simulations, ncol = n_days)
  
  for (i in 1:n_simulations) {
    # Генерируем AR(1) процесс для температуры
    temperature <- simulate_ar1(n_days, phi, sigma_temp)
    temp_matrix[i, ] <- temperature
  }
  
  results[[as.character(phi)]] <- temp_matrix
}

# =============================================================================
# ПОДГОТОВКА ДАННЫХ ДЛЯ ВИЗУАЛИЗАЦИИ
# =============================================================================

# Подготовка данных для графика температур
temp_data <- data.frame()
for (phi in phi_values) {
  for (i in 1:n_simulations) {
    temp_df <- data.frame(
      day = 1:n_days,
      temperature = results[[as.character(phi)]][i, ],
      simulation = i,
      phi = paste("φ =", phi)
    )
    temp_data <- rbind(temp_data, temp_df)
  }
}

# =============================================================================
# ГРАФИК: ТРАЕКТОРИИ ТЕМПЕРАТУРЫ ВОДЫ (AR(1))
# =============================================================================

cat("Создаем график траекторий температуры...\n")

p1 <- ggplot(temp_data, aes(x = day, y = temperature, group = simulation)) +
  geom_line(alpha = 0.6, linewidth = 0.5, color = "steelblue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", alpha = 0.7) +
  
  facet_wrap(~ phi, ncol = 2) +
  
  labs(
    title = "Авторегрессия AR(1): Колебания температуры воды",
    subtitle = "φ = 0.2 (быстрое забывание) ... φ = 0.95 (долгая память)",
    x = "Время (дни)",
    y = "Отклонение температуры от среднего (°C)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5),
    strip.background = element_rect(fill = "lightblue"),
    panel.grid.minor = element_blank()
  )

print(p1)

# =============================================================================
# ОБЪЯСНЕНИЕ РЕЗУЛЬТАТОВ
# =============================================================================

cat("\n=== БИОЛОГИЧЕСКАЯ ИНТЕРПРЕТАЦИЯ AR(1) ===\n")
cat("• φ = 0.2: Быстрое 'забывание' - температура быстро возвращается к норме\n")
cat("  Пример: Мелководные озера, быстро реагирующие на погоду\n")
cat("• φ = 0.5: Умеренная память - средняя скорость возврата к норме\n")
cat("  Пример: Среднеглубинные водоемы\n")
cat("• φ = 0.8: Долгая 'память' - температурные аномалии сохраняются долго\n")
cat("  Пример: Глубокие морские заливы с инерцией водных масс\n")
cat("• φ = 0.95: Очень долгая память - почти случайное блуждание\n")
cat("  Пример: Климатические тренды, многолетние циклы\n\n")

cat("КЛЮЧЕВОЙ ВЫВОД:\n")
cat("AR(1) описывает системы с 'упругой памятью' - они отклоняются\n")
cat("от равновесия, но стремятся вернуться к нему. Параметр φ показывает,\n")
cat("насколько сильно прошлое влияет на будущее состояние системы.\n")