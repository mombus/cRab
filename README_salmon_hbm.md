# Иерархическая байесовская модель для оценки R0 лосося

## Описание

Этот скрипт реализует иерархическую байесовскую модель (HBM) для оценки параметра R0 (начальное пополнение) популяций лосося в разных реках, используя пакет `nimble` в R.

## Исправления в коде

### Основные проблемы, которые были исправлены:

1. **Ошибка в визуализации априорных распределений**: 
   - Проблема: `tibble()` пытался создать столбцы разного размера (5000 vs 512)
   - Решение: Использование `density()` для создания правильных данных для графиков

2. **Улучшенная визуализация**:
   - Добавлены подписи к осям и заголовки
   - Улучшено форматирование графиков
   - Добавлены дополнительные диагностические графики

3. **Расширенная аналитика**:
   - Добавлены метрики точности (MAE, относительная ошибка)
   - Добавлен анализ покрытия доверительных интервалов
   - Добавлен график точности оценок

## Структура модели

### Иерархическая структура:
```
μ, σ, τ_obs (гиперпараметры)
    ↓
logR0[i] ~ N(μ, σ²) для каждой реки i
    ↓
log_recruits[j] ~ N(logR0[river_id[j]], τ_obs²) для каждого наблюдения j
```

### Параметры:
- `μ`: среднее log(R0) на уровне популяции
- `σ`: стандартное отклонение log(R0) между реками
- `τ_obs`: стандартное отклонение наблюдений
- `logR0[i]`: log(R0) для реки i

## Установка и запуск

### Требуемые пакеты:
```r
install.packages(c("nimble", "tidyverse", "bayesplot", "coda"))
```

### Запуск:
```r
source("salmon_hbm_analysis.R")
```

## Результаты

Скрипт генерирует:

1. **Временные ряды данных** - визуализация синтетических данных пополнения
2. **Диагностика сходимости** - статистики Gelman-Rubin и эффективные размеры выборки
3. **Трассировки** - графики цепей MCMC для основных параметров
4. **Априорные vs постериорные распределения** - сравнение для μ, σ, τ_obs
5. **Оценки R0 по рекам** - точечные оценки с доверительными интервалами
6. **Анализ точности** - сравнение истинных и оцененных значений

## Ключевые особенности

- **Исправленная визуализация**: Все графики теперь работают корректно
- **Полная диагностика**: Проверка сходимости и качества цепей MCMC
- **Метрики производительности**: Количественная оценка точности модели
- **Современная визуализация**: Использование ggplot2 и bayesplot

## Интерпретация результатов

- **Gelman-Rubin < 1.1**: Цепи сошлись
- **Эффективный размер выборки > 1000**: Достаточно для надежных выводов
- **Покрытие ДИ ≈ 95%**: Модель хорошо калибрована
- **Низкая относительная ошибка**: Модель точна

## Примечания

- Скрипт использует синтетические данные для демонстрации
- Для реальных данных замените раздел генерации данных
- MCMC параметры можно настроить в зависимости от сложности данных
- Модель предполагает лог-нормальное распределение наблюдений