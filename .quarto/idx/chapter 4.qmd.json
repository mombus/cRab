{"title":"sdmTMB - оценка и визуализация индекса обилия по съемке","markdown":{"yaml":{"title":"sdmTMB - оценка и визуализация индекса обилия по съемке","format":"html"},"headingText":"Введение","containsRefs":false,"markdown":"\n\n\nОценка индекса промыслового запаса камчатского краба в Баренцевом море с использованием пространственно-временного моделирования (библиотека R: sdmTMB)\n\n**Цель:**\\\nПродемонстрировать применение современных методов SDM (Species Distribution Modeling) и GAMM (Generalized Additive Mixed Models) для стандартизации оценки запасов промысловых видов на примере камчатского краба.\n\n**Ключевые аспекты:**\n\n1.  **Подготовка данных**:\n\n    -   Преобразование координат в проекцию UTM (км)\n\n    -   Фильтрация данных через выпуклую оболочку (convex hull)\n\n    -   Создание прогнозной сетки с шагом 10 км (2 км)\n\n2.  **Моделирование**:\n\n    -   Построение треугольной сетки (mesh) для учета пространственной автокорреляции\n\n    -   Подбор модели sdmTMB с пространственно-временными случайными эффектами\n\n    -   Учет ключевых факторов: температура, глубина, тип съемки\n\n3.  **Визуализация**:\n\n    -   Карты распределения плотности с наложением данных съемок\n\n    -   Динамика индекса обилия с 50% и 95% доверительными интервалами\n\n**Для работы скрипта:**\n\n1.  Скачайте файл данных ([KARTOGRAPHIC.xlsx](https://mombus.github.io/cRab/data/KARTOGRAPHIC.xlsx))\n\n2.  Установите рабочую директорию в setwd()\n\n3.  Установите необходимые пакеты (см. начало скрипта).\n\n## Базовая оценка\n\n```{r}\n#| output: false\n#| eval: false\n# ---------------------------\n# 1. ПОДГОТОВКА СРЕДЫ И ДАННЫХ\n# ---------------------------\n\n# Очистка рабочей среды\nrm(list = ls())\n\n# Установка рабочей директории (замените на свою)\nsetwd(\"C:/COMBINE/\")\n\n# Загрузка необходимых пакетов\nlibrary(readxl)       # Для чтения Excel-файлов\nlibrary(ggplot2)      # Визуализация данных\nlibrary(dplyr)        # Обработка данных\nlibrary(sdmTMB)       # Пространственно-временное моделирование\nlibrary(INLA)         # Продвинутые пространственные модели\nlibrary(sp)           # Классы для пространственных данных\nlibrary(sf)           # Пространственные данные (современный формат)\nlibrary(rnaturalearth) # Загрузка картографических данных\n\n# Загрузка данных из Excel-файла\ndata <- readxl::read_excel(\"KARTOGRAPHIC.xlsx\", sheet = \"SURVEY\")\n\n# Просмотр структуры данных\nstr(data)\n```\n\nДолжно выглядеть так:\n\n```{r}\n#| output: false\n#| eval: false\n> str(data)\ntibble [1,126 x 20] (S3: tbl_df/tbl/data.frame)\n $ NUM    : num [1:1126] 1 2 3 4 5 6 7 8 9 10 ...\n $ CALL   : chr [1:1126] \"UFJN\" \"UFJN\" \"UFJN\" \"UFJN\" ...\n $ CRUSE  : num [1:1126] 112 112 112 112 112 112 112 112 112 112 ...\n $ SURV   : chr [1:1126] \"SUM\" \"SUM\" \"SUM\" \"SUM\" ...\n $ TRAL   : num [1:1126] 2 3 5 7 9 11 13 15 17 19 ...\n $ DATE   : POSIXct[1:1126], format: \"2019-08-16\" \"2019-08-16\" ...\n $ MONTH  : num [1:1126] 8 8 8 8 8 8 8 8 8 8 ...\n $ YEAR   : num [1:1126] 2019 2019 2019 2019 2019 ...\n $ TIME   : chr [1:1126] \"9:43\" \"14:19\" \"19:33\" \"2:47\" ...\n $ DECMIN : num [1:1126] 1.04 0.15 0.15 0.15 0.15 0.15 0.15 0.15 0.15 0.15 ...\n $ DUR    : num [1:1126] 1.73 0.25 0.25 0.25 0.25 ...\n $ DEPTH  : num [1:1126] 200 198 196 132 128 131 64 73 91 62 ...\n $ SPEED  : num [1:1126] 3 3 3 3 3 3 3 3 3 3 ...\n $ CATCH  : num [1:1126] 12.9 365.3 253 163.9 55.7 ...\n $ Y      : num [1:1126] 69.5 69.5 69.4 68.8 69.4 ...\n $ X      : num [1:1126] 35.8 35.9 37.4 38.6 39 ...\n $ PROM   : num [1:1126] 2 0 0 3 0 6 6 34 22 9 ...\n $ Density: num [1:1126] 30 0 0 45 0 ...\n $ DIST   : num [1:1126] 28.7 28.7 49.9 37.3 90.8 ...\n $ TEMP   : num [1:1126] 5.57 5.49 4.99 4.8 4.4 ...\n> \n\n```\n\nДалее:\n\n```{r}\n#| output: false\n#| eval: false\n# --------------------------------------------------\n# 2. ПРЕОБРАЗОВАНИЕ КООРДИНАТ В ПРОЕКЦИЮ UTM (в км)\n# --------------------------------------------------\n\n# Создание пространственного объекта из данных\ndata_sf <- st_as_sf(\n  data, \n  coords = c(\"X\", \"Y\"), # Указание столбцов с координатами\n  crs = 4326            # Система координат WGS84 (широта/долгота)\n) \n\n# Преобразование в UTM зону 37N (метры)\ndata_utm <- st_transform(data_sf, crs = 32637) \n\n# Извлечение координат и перевод в километры\nutm_coords <- st_coordinates(data_utm)\ndata$xkm <- utm_coords[, 1] / 1000  # X в км\ndata$ykm <- utm_coords[, 2] / 1000  # Y в км\n\n# Очистка временных объектов\nrm(data_sf, data_utm, utm_coords)\n\n# -----------------------------------------\n# 3. ОПРЕДЕЛЕНИЕ ГРАНИЦ ИССЛЕДОВАНИЯ\n# -----------------------------------------\n\n# Вычисление границ исследовательского полигона\nxl <- c(min(data$xkm), max(data$xkm))  # Границы по X\nyl <- c(min(data$ykm), max(data$ykm))  # Границы по Y\n\n# ----------------------------------------\n# 4. СОЗДАНИЕ РАСТРОВОЙ СЕТКИ ДЛЯ МОДЕЛИ\n# ----------------------------------------\n\n# Создание равномерной сетки с шагом 10 км \nGRID <- makeGrid(\n  x = seq(xl[1], xl[2], 10), \n  y = seq(yl[1], yl[2], 10),\n  byrow = FALSE,\n  projection = \"UTM\", \n  zone = 37\n)\n\n# Расчет центроидов ячеек сетки\nGRID <- calcCentroid(GRID, rollup = 3)\n\n# -----------------------------------------------------------\n# 5. ПОСТРОЕНИЕ ВЫПУКЛОЙ ОБОЛОЧКИ (CONVEX HULL) ДЛЯ ДАННЫХ\n# -----------------------------------------------------------\n\n# Создание выпуклой оболочки вокруг точек данных\nHull <- inla.nonconvex.hull(cbind(data$xkm, data$ykm), convex = -0.03)\n\n# Визуализация оболочки \n plot(Hull)\n```\n\n![Рис. 1.: Визуализация оболочки съемок](images/sdmTMB1.PNG){fig-align=\"center\" width=\"60%\"}\n\n```{r}\n#| output: false\n#| eval: false\n# Визуализация оболочки и точек съемок 2019-2024\npoints(data$xkm, data$ykm, pch=1, cex=0.55,col=\"black\")\n```\n\n![Рис. 2.: Визуализация оболочки и точек съемок](images/sdmTMB2.PNG){fig-align=\"center\" width=\"60%\"}\n\n```{r}\n#| output: false\n#| eval: false\n\n# Фильтрация сетки: оставляем только точки внутри оболочки\nline <- Hull$loc[, 1:2] %>% as.data.frame()\ncolnames(line) <- c(\"X\", \"Y\")\nGRID$AREA <- point.in.polygon(GRID$X, GRID$Y, line$X, line$Y)\nGRID <- GRID[GRID$AREA > 0.1, c(\"X\", \"Y\")]  # Только внутренние точки\n\n# -------------------------------------------------\n# 6. ПОДГОТОВКА СЕТКИ ДЛЯ ПРОГНОЗИРОВАНИЯ\n# -------------------------------------------------\n\n# Создание временной сетки (для каждого года)\ngrid <- replicate_df(GRID, \"YEAR\", unique(data$YEAR))\ncolnames(grid) <- c(\"xkm\", \"ykm\", \"YEAR\")\ngrid$SURV <- \"CRAB\"  # Добавляем информацию о типе съемки\n\n# Визуализация оболочки и сетки для прогнозирования (grid)\n plot(Hull)\n points(grid$xkm, grid$ykm, pch=1, cex=0.55,col=\"black\")\n```\n\n![Рис. 3.: Визуализация оболочки и сетки для прогнозирования (grid)](images/sdmTMB3.PNG){fig-align=\"center\" width=\"60%\"}\n\n```{r}\n#| output: false\n#| eval: false\n# ---------------------------------------------------\n# 7. ПОСТРОЕНИЕ ПРОСТРАНСТВЕННОЙ СЕТКИ (MESH)\n# ---------------------------------------------------\n\n# Создание треугольной сетки для пространственного моделирования\nmesh_sdm <- make_mesh(\n  data, \n  c(\"xkm\", \"ykm\"),  # Координаты\n  cutoff = 10        # Минимальное расстояние между узлами (км)\n)\n\n# Визуализация сетки \n plot(mesh_sdm)\n```\n\n![Рис. 4.: Визуализация сетки (mesh)](images/sdmTMB4.PNG){fig-align=\"center\" width=\"60%\"}\n\n```{r}\n#| output: false\n#| eval: false\n# ---------------------------------------------------\n# 8. ПОСТРОЕНИЕ ПРОСТРАНСТВЕННО-ВРЕМЕННОЙ МОДЕЛИ\n# ---------------------------------------------------\n\nm <- sdmTMB(\n  data = data, \n  formula = Density ~ 0 + as.factor(YEAR),  # Формула: плотность зависит от года\n  time = \"YEAR\",         # Временная переменная\n  mesh = mesh_sdm,       # Пространственная сетка\n  family = tweedie(link = \"log\"),  # Статистическое распределение\n  spatial = \"on\",        # Включение пространственных эффектов\n  spatiotemporal = \"iid\" # Пространственно-временные эффекты\n)\n\n# Вывод результатов модели\nsummary(m)\nAIC(m)  # Критерий Акаике\nsanity(m)  # Проверка корректности модели\n```\n\nПолучили результаты:\n\n```{r}\n#| output: false\n#| eval: false\n> # Вывод результатов модели\n> summary(m)\nSpatiotemporal model fit by ML ['sdmTMB']\nFormula: Density ~ 0 + as.factor(YEAR)\nMesh: mesh_sdm (isotropic covariance)\nTime column: YEAR\nData: data\nFamily: tweedie(link = 'log')\n \nConditional model:\n                    coef.est coef.se\nas.factor(YEAR)2019     2.15    0.72\nas.factor(YEAR)2020     1.49    0.76\nas.factor(YEAR)2021     1.74    0.76\nas.factor(YEAR)2022     1.62    0.73\nas.factor(YEAR)2023     1.50    0.74\nas.factor(YEAR)2024     1.56    0.72\n\nDispersion parameter: 19.71\nTweedie p: 1.50\nMatern range: 142.65\nSpatial SD: 2.01\nSpatiotemporal IID SD: 0.95\nML criterion at convergence: 5984.224\n\nSee ?tidy.sdmTMB to extract these values as a data frame.\n> AIC(m)  # Критерий Акаике\n[1] 11990.45\n> sanity(m)  # Проверка корректности модели\nv Non-linear minimizer suggests successful convergence\nv Hessian matrix is positive definite\nv No extreme or very small eigenvalues detected\nv No gradients with respect to fixed effects are >= 0.001\nv No fixed-effect standard errors are NA\nv No standard errors look unreasonably large\nv No sigma parameters are < 0.01\nv No sigma parameters are > 100\nv Range parameter doesn't look unreasonably large\n \n```\n\n#### **Годовые эффекты:**\n\n```         \n2019: 2.15 ± 0.72 → exp(2.15) ≈ 8.58 экз./км²\n2020: 1.49 ± 0.76 → exp(1.49) ≈ 4.44 экз./км²\n2024: 1.56 ± 0.72 → exp(1.56) ≈ 4.76 экз./км²\n```\n\n-   **2019 год** - пик запаса (8.58 экз./км²)\n\n-   **2020 год** - резкое снижение (-52% к 2019)\n\n-   **2021-2024** - стабилизация на уровне \\~4.5-5.0 экз./км²\n\n-   **Стандартные ошибки** \\~0.75:\n\n    -   Приемлемая точность для данных такого объема\n\n    -   Все годовые оценки статистически значимы\n\n    Модель пространственно-временного распределения плотности камчатского краба успешно прошла все диагностические проверки, демонстрируя отличную сходимость и статистическую надежность. Параметр распределения Твиди (p=1.50) оптимально соответствует данным траловых съемок, учитывая характерную для уловов передисперсию и избыток нулевых значений.\n\n    Годовые оценки показывают выраженную динамику запаса: в 2019 году зафиксирован пик плотности (8.58 экз./км²), после чего в 2020 году произошло резкое снижение до 4.44 экз./км². В последующие годы (2021-2024) плотность стабилизировалась на уровне 4.5-5.0 экз./км², что составляет примерно 55% от максимальных значений 2019 года. Стандартные ошибки годовых коэффициентов (0.72-0.76) свидетельствуют о хорошей точности оценок при текущем объеме данных.\n\n    Пространственная структура распределения характеризуется крупномасштабными скоплениями с диапазоном корреляции 143 км (Matern range: 142.65), что согласуется с известными особенностями миграций камчатского краба. Высокое значение пространственной изменчивости (SD=2.01) отражает типичную для вида мозаичность распределения, где участки высокой плотности соседствуют с зонами отсутствия особей. Умеренная пространственно-временная изменчивость (IID SD=0.95) указывает на относительную стабильность пространственной структуры запаса между годами.\n\n    Параметр дисперсии (19.71) подтверждает ожидаемо высокую вариабельность данных, характерную для траловых съемок морских гидробионтов. Полученные результаты надежно фиксируют значительное сокращение запаса после 2019 года с последующей стабилизацией на пониженном уровне.\n\n    ### **Пояснение результатов `sanity(m)` для начинающих гидробиологов (от DeepSeek):**\n\n    **1. `v Non-linear minimizer suggests successful convergence`**\\\n    (Нелинейный оптимизатор успешно сошелся)\\\n    *Пояснение:* Алгоритм поиска параметров модели корректно завершил работу. Это значит, что модель \"научилась\" описывать ваши данные и не застряла в промежуточных вычислениях. Как если бы вы успешно завершили лабораторный анализ без технических сбоев.\n\n    **2. `v Hessian matrix is positive definite`**\\\n    (Матрица Гессе положительно определена)\\\n    *Пояснение:* Математическое подтверждение, что найденные параметры модели действительно оптимальны. Аналогично тому, как в микроскопии вы видите четкий фокус - здесь модель \"четко видит\" закономерности в данных.\n\n    **3. `v No extreme or very small eigenvalues detected`**\\\n    (Не обнаружено экстремальных или очень маленьких собственных значений)\\\n    *Пояснение:* Модель статистически стабильна. Представьте, что вы измеряете длину рыб - если бы ваш штангенциркуль иногда показывал 0 или 1000 мм, это было бы проблемой. Здесь аналогично - вычисления надежны.\n\n    **4. `v No gradients with respect to fixed effects are >= 0.001`**\\\n    (Градиенты для фиксированных эффектов \\< 0.001)\\\n    *Пояснение:* Все ключевые параметры модели (например, влияние года на плотность) рассчитаны точно. Это как убедиться, что все измерения в вашем эксперименте выполнены с требуемой точностью (±0.1 мг, ±1 см и т.д.).\n\n    **5. `v No fixed-effect standard errors are NA`**\\\n    (Стандартные ошибки для фиксированных эффектов не отсутствуют)\\\n    *Пояснение:* Для каждого рассчитанного параметра (например, годовых оценок) указана погрешность. Важно как в химическом анализе - если для концентрации вещества нет погрешности, результат ненадежен.\n\n    **6. `v No standard errors look unreasonably large`**\\\n    (Стандартные ошибки выглядят разумными)\\\n    *Пояснение:* Погрешности оценок адекватны. Например, если плотность краба 5±1 экз./км² - это нормально, но 5±100 экз./км² было бы бессмысленным.\n\n    **7. `v No sigma parameters are < 0.01`**\\\n    (Параметры сигма не меньше 0.01)\\\n    *Пояснение:* Модель не игнорирует важные источники изменчивости. Аналогично тому, что в пробе воды вы не упустили бы важный показатель, сказав \"он слишком мал\".\n\n    **8. `v No sigma parameters are > 100`**\\\n    (Параметры сигма не превышают 100)\\\n    *Пояснение:* Модель не преувеличивает случайные вариации. Как если бы вы не приписали естественные колебания температуры воды катастрофическому изменению климата.\n\n    **9. `v Range parameter doesn't look unreasonably large`**\\\n    (Параметр диапазона не выглядит чрезмерно большим)\\\n    *Пояснение:* Пространственная автокорреляция имеет биологически осмысленный масштаб. Например, если модель показала бы, что скопления краба одинаковы на расстоянии 1000 км - это было бы нереалистично.\n\n```{r}\n#| output: false\n#| eval: false\n# ---------------------------------------------------\n# 9. ДИАГНОСТИКА МОДЕЛИ\n# ---------------------------------------------------\n\n# Расчет остатков модели\ndata$resids <- residuals(m) \n\n# Гистограмма остатков\nhist(data$resids)\n\n# График квантиль-квантиль\nqqnorm(data$resids)\nabline(a = 0, b = 1)\n```\n\n\n![Рис. 5.: Гистограмма остатков](images/sdmTMB5.PNG){fig-align=\"center\" width=\"60%\"}\n\n\n![Рис. 6.: График квантиль-квантиль](images/sdmTMB6.PNG){fig-align=\"center\" width=\"60%\"}\n\n```{r}\n#| output: false\n#| eval: false\n# ---------------------------------------------------\n# 10. ПРОГНОЗИРОВАНИЕ НА СЕТКЕ\n# ---------------------------------------------------\n\n# Прогноз значений плотности на сетке\npredictions <- predict(m, newdata = grid, return_tmb_object = TRUE)\nRASP <- predictions$data\n\n# Преобразование координат обратно в широту/долготу\nRASP$xkm_m <- RASP$xkm * 1000  # Обратно в метры\nRASP$ykm_m <- RASP$ykm * 1000\n\n# Создание пространственного объекта в UTM\nutm_proj <- CRS(\"+proj=utm +zone=37 +datum=WGS84 +units=m +no_defs\")\ncoords <- cbind(RASP$xkm_m, RASP$ykm_m)\nsp_points <- SpatialPoints(coords, proj4string = utm_proj)\n\n# Преобразование в WGS84 (широта/долгота)\nwgs84_proj <- CRS(\"+proj=longlat +datum=WGS84\")\nsp_points_latlon <- spTransform(sp_points, wgs84_proj)\n\n# Добавление координат в основной датафрейм\nRASP$X <- coordinates(sp_points_latlon)[, 1]  # Долгота\nRASP$Y <- coordinates(sp_points_latlon)[, 2]  # Широта\n\n# Удаление временных столбцов\nRASP$xkm_m <- NULL\nRASP$ykm_m <- NULL\n\n# Проверка структуры результата\nstr(RASP)\n\n# ---------------------------------------------\n# 11. ВИЗУАЛИЗАЦИЯ РЕЗУЛЬТАТОВ (КАРТА)\n# ---------------------------------------------\n\n# Загрузка картографических данных\nworld <- ne_countries(scale = \"medium\", returnclass = \"sf\")\n\n# Определение региона интереса (Арктика России)\narctic_bbox <- st_bbox(c(xmin = 25, xmax = 70, ymin = 65, ymax = 80), crs = 4326)\narctic <- st_crop(world, arctic_bbox)\n\n# Кастомные разрывы для цветовой шкалы\nmy_breaks <- c(0.001, 0.1, 1, 200, 10000)\n\n# Создание основной визуализации\nggplot() +\n  # Теплокарта плотности\n  geom_point(\n    data = RASP, \n    aes(x = X, y = Y, color = exp(est)), \n    size = 0.8, \n    alpha = 0.7\n  ) + \n  # Наблюдаемые точки данных\n  geom_point(\n    data = data, \n    aes(x = X, y = Y, size = Density), # Размер по плотности\n    color = \"black\", \n    fill = NA, \n    alpha = 0.6,\n    shape = 21 # Кружки с обводкой\n  ) +\n  # Картографическая подложка\n  geom_sf(data = arctic, fill = \"lightgrey\", color = \"darkgrey\") +\n  # Цветовая шкала (логарифмическая)\n  scale_color_viridis_c(\n    name = \"\",\n    option = \"H\", \n    trans = \"log\", \n    breaks = my_breaks, \n    labels = my_breaks\n  ) +\n  # Разделение по годам\n  facet_wrap(~ YEAR, ncol = 2) +\n  # Настройка области просмотра\n  coord_sf(\n    xlim = c(min(RASP$X)-1, max(RASP$X)+1),\n    ylim = c(min(RASP$Y)-0.5, max(RASP$Y)+0.5),\n    crs = 4326\n  ) +\n  # Тема оформления\n  theme_bw(base_size = 12) +\n  labs(x = \"Долгота\", y = \"Широта\", title = \"Пространственное распределение плотности\") +\n  theme(\n    panel.grid = element_line(color = \"grey90\"),\n    legend.position = \"bottom\",\n    legend.key.width = unit(1.2, \"cm\"),\n    strip.background = element_rect(fill = \"white\")\n  )\n\n# Сохранение графика (раскомментируйте)\n ggsave(\"sdmTMBmap10.jpg\", width = 8, height = 8, dpi = 300)\n\n```\n![Рис. 7.: Визуализация результатов (КАРТА)](images/sdmTMBmap10.jpg){fig-align=\"center\" width=\"60%\"}\n\n\n```{r}\n#| output: false\n#| eval: false\n# ---------------------------------------------------\n# 12. РАСЧЕТ ИНДЕКСОВ ОБИЛИЯ\n# ---------------------------------------------------\n\n# Расчет индексов с разными доверительными интервалами\nindex <- get_index(predictions, area = 4, level = 0.95, bias_correct = TRUE)\nindex2 <- get_index(predictions, area = 4, level = 0.5, bias_correct = TRUE)\n\n# Формирование сводной таблицы результатов\ntotal <- data.frame(\n  YEAR = index$YEAR,\n  lwr_95 = index$lwr,\n  lwr_50 = index2$lwr,\n  estimate = index$est,\n  upr_50 = index2$upr,\n  upr_95 = index$upr,\n  se = index$se,\n  cv = sqrt(exp(index$se^2) - 1) # Коэффициент вариации\n)\n\n# Визуализация индексов обилия\nggplot(total, aes(x = YEAR, y = estimate/1000000)) + \n  # Основная линия оценки\n  geom_line(linewidth = 1, color = \"steelblue\") +\n  \n  # 95% доверительный интервал (более широкий и прозрачный)\n  geom_ribbon(\n    aes(ymin = lwr_95/1000000, ymax = upr_95/1000000),\n    alpha = 0.2,  # Полупрозрачность\n    fill = \"steelblue\",\n    color = NA     # Без контура\n  ) +\n  \n  # 50% доверительный интервал (менее прозрачный)\n  geom_ribbon(\n    aes(ymin = lwr_50/1000000, ymax = upr_50/1000000),\n    alpha = 0.4,  # Меньшая прозрачность\n    fill = \"steelblue\",\n    color = NA\n  ) +\n  \n  # Настройки осей и заголовков\n  ylab('Промысловый запас, млн. экз') +\n  xlab('Год') +\n  \n  # Вертикальные линии для годов\n  geom_vline(\n    xintercept = total$YEAR, \n    linetype = \"dotted\", \n    color = \"grey60\", \n    alpha = 0.6\n  ) +\n  \n  # Точки с значениями оценок\n  geom_point(\n    size = 3,\n    color = \"navyblue\",\n    fill = \"white\",\n    shape = 21\n  ) +\n  \n  # Настройка темы\n  theme_minimal(base_size = 14) +\n  theme(\n    plot.title = element_text(hjust = 0.5, face = \"bold\"),\n    panel.grid.minor = element_blank(),\n    panel.grid.major = element_line(color = \"grey90\"),\n    axis.line = element_line(color = \"grey30\"),\n    legend.position = \"none\"\n  )\n\n```\n![Рис. 8.: Визуализация индексов обилия](images/sdmTMB7.PNG){fig-align=\"center\" width=\"60%\"}\n\n```{r}\n#| output: false\n#| eval: false\n# Форматированный вывод результатов\ntotal %>% \n  mutate(cv_percent = 100 * cv) %>% \n  select(\n    YEAR, \n    estimate, \n    lwr_50,  # Нижняя граница 50% ДИ\n    upr_50,  # Верхняя граница 50% ДИ\n    lwr_95,  # Нижняя граница 95% ДИ\n    upr_95,  # Верхняя граница 95% ДИ\n    cv_percent\n  ) %>%\n  knitr::kable(\n    format = \"pandoc\", \n    digits = c(0, 0, 0, 0, 0, 0, 1),\n    col.names = c(\n      \"Год\", \n      \"Оценка\", \n      \"Нижняя 50%\", \n      \"Верхняя 50%\", \n      \"Нижняя 95%\", \n      \"Верхняя 95%\", \n      \"CV%\"\n    )\n  )\n```\n\n```{r}\n#| output: false\n#| eval: false\n  Год    Оценка   Нижняя 50%   Верхняя 50%   Нижняя 95%   Верхняя 95%    CV%\n-----  --------  -----------  ------------  -----------  ------------  -----\n 2019   2381774      2177448       2605274      1835312       3090946   13.4\n 2020   1634549      1539111       1735906      1372377       1946805    8.9\n 2021   1920507      1794122       2055795      1575823       2340584   10.1\n 2022   1036673       959251       1120344       827345       1298963   11.5\n 2023   1147685      1068401       1232853       932147       1413062   10.6\n 2024   1055733       985624       1130829       864640       1289060   10.2\n> \n\n```\n\n## Базовая оценка + предикторы\n\nТекст. Текст. Текст.\n\n## Визуализация эффектов\n\nТекст. Текст. Текст.\n\n## Карта с акцентом на нулевые уловы\n\n## Определение площади съемки\n\n## Присоединение факторов к данным съемок\n","srcMarkdownNoYaml":"\n\n## Введение\n\nОценка индекса промыслового запаса камчатского краба в Баренцевом море с использованием пространственно-временного моделирования (библиотека R: sdmTMB)\n\n**Цель:**\\\nПродемонстрировать применение современных методов SDM (Species Distribution Modeling) и GAMM (Generalized Additive Mixed Models) для стандартизации оценки запасов промысловых видов на примере камчатского краба.\n\n**Ключевые аспекты:**\n\n1.  **Подготовка данных**:\n\n    -   Преобразование координат в проекцию UTM (км)\n\n    -   Фильтрация данных через выпуклую оболочку (convex hull)\n\n    -   Создание прогнозной сетки с шагом 10 км (2 км)\n\n2.  **Моделирование**:\n\n    -   Построение треугольной сетки (mesh) для учета пространственной автокорреляции\n\n    -   Подбор модели sdmTMB с пространственно-временными случайными эффектами\n\n    -   Учет ключевых факторов: температура, глубина, тип съемки\n\n3.  **Визуализация**:\n\n    -   Карты распределения плотности с наложением данных съемок\n\n    -   Динамика индекса обилия с 50% и 95% доверительными интервалами\n\n**Для работы скрипта:**\n\n1.  Скачайте файл данных ([KARTOGRAPHIC.xlsx](https://mombus.github.io/cRab/data/KARTOGRAPHIC.xlsx))\n\n2.  Установите рабочую директорию в setwd()\n\n3.  Установите необходимые пакеты (см. начало скрипта).\n\n## Базовая оценка\n\n```{r}\n#| output: false\n#| eval: false\n# ---------------------------\n# 1. ПОДГОТОВКА СРЕДЫ И ДАННЫХ\n# ---------------------------\n\n# Очистка рабочей среды\nrm(list = ls())\n\n# Установка рабочей директории (замените на свою)\nsetwd(\"C:/COMBINE/\")\n\n# Загрузка необходимых пакетов\nlibrary(readxl)       # Для чтения Excel-файлов\nlibrary(ggplot2)      # Визуализация данных\nlibrary(dplyr)        # Обработка данных\nlibrary(sdmTMB)       # Пространственно-временное моделирование\nlibrary(INLA)         # Продвинутые пространственные модели\nlibrary(sp)           # Классы для пространственных данных\nlibrary(sf)           # Пространственные данные (современный формат)\nlibrary(rnaturalearth) # Загрузка картографических данных\n\n# Загрузка данных из Excel-файла\ndata <- readxl::read_excel(\"KARTOGRAPHIC.xlsx\", sheet = \"SURVEY\")\n\n# Просмотр структуры данных\nstr(data)\n```\n\nДолжно выглядеть так:\n\n```{r}\n#| output: false\n#| eval: false\n> str(data)\ntibble [1,126 x 20] (S3: tbl_df/tbl/data.frame)\n $ NUM    : num [1:1126] 1 2 3 4 5 6 7 8 9 10 ...\n $ CALL   : chr [1:1126] \"UFJN\" \"UFJN\" \"UFJN\" \"UFJN\" ...\n $ CRUSE  : num [1:1126] 112 112 112 112 112 112 112 112 112 112 ...\n $ SURV   : chr [1:1126] \"SUM\" \"SUM\" \"SUM\" \"SUM\" ...\n $ TRAL   : num [1:1126] 2 3 5 7 9 11 13 15 17 19 ...\n $ DATE   : POSIXct[1:1126], format: \"2019-08-16\" \"2019-08-16\" ...\n $ MONTH  : num [1:1126] 8 8 8 8 8 8 8 8 8 8 ...\n $ YEAR   : num [1:1126] 2019 2019 2019 2019 2019 ...\n $ TIME   : chr [1:1126] \"9:43\" \"14:19\" \"19:33\" \"2:47\" ...\n $ DECMIN : num [1:1126] 1.04 0.15 0.15 0.15 0.15 0.15 0.15 0.15 0.15 0.15 ...\n $ DUR    : num [1:1126] 1.73 0.25 0.25 0.25 0.25 ...\n $ DEPTH  : num [1:1126] 200 198 196 132 128 131 64 73 91 62 ...\n $ SPEED  : num [1:1126] 3 3 3 3 3 3 3 3 3 3 ...\n $ CATCH  : num [1:1126] 12.9 365.3 253 163.9 55.7 ...\n $ Y      : num [1:1126] 69.5 69.5 69.4 68.8 69.4 ...\n $ X      : num [1:1126] 35.8 35.9 37.4 38.6 39 ...\n $ PROM   : num [1:1126] 2 0 0 3 0 6 6 34 22 9 ...\n $ Density: num [1:1126] 30 0 0 45 0 ...\n $ DIST   : num [1:1126] 28.7 28.7 49.9 37.3 90.8 ...\n $ TEMP   : num [1:1126] 5.57 5.49 4.99 4.8 4.4 ...\n> \n\n```\n\nДалее:\n\n```{r}\n#| output: false\n#| eval: false\n# --------------------------------------------------\n# 2. ПРЕОБРАЗОВАНИЕ КООРДИНАТ В ПРОЕКЦИЮ UTM (в км)\n# --------------------------------------------------\n\n# Создание пространственного объекта из данных\ndata_sf <- st_as_sf(\n  data, \n  coords = c(\"X\", \"Y\"), # Указание столбцов с координатами\n  crs = 4326            # Система координат WGS84 (широта/долгота)\n) \n\n# Преобразование в UTM зону 37N (метры)\ndata_utm <- st_transform(data_sf, crs = 32637) \n\n# Извлечение координат и перевод в километры\nutm_coords <- st_coordinates(data_utm)\ndata$xkm <- utm_coords[, 1] / 1000  # X в км\ndata$ykm <- utm_coords[, 2] / 1000  # Y в км\n\n# Очистка временных объектов\nrm(data_sf, data_utm, utm_coords)\n\n# -----------------------------------------\n# 3. ОПРЕДЕЛЕНИЕ ГРАНИЦ ИССЛЕДОВАНИЯ\n# -----------------------------------------\n\n# Вычисление границ исследовательского полигона\nxl <- c(min(data$xkm), max(data$xkm))  # Границы по X\nyl <- c(min(data$ykm), max(data$ykm))  # Границы по Y\n\n# ----------------------------------------\n# 4. СОЗДАНИЕ РАСТРОВОЙ СЕТКИ ДЛЯ МОДЕЛИ\n# ----------------------------------------\n\n# Создание равномерной сетки с шагом 10 км \nGRID <- makeGrid(\n  x = seq(xl[1], xl[2], 10), \n  y = seq(yl[1], yl[2], 10),\n  byrow = FALSE,\n  projection = \"UTM\", \n  zone = 37\n)\n\n# Расчет центроидов ячеек сетки\nGRID <- calcCentroid(GRID, rollup = 3)\n\n# -----------------------------------------------------------\n# 5. ПОСТРОЕНИЕ ВЫПУКЛОЙ ОБОЛОЧКИ (CONVEX HULL) ДЛЯ ДАННЫХ\n# -----------------------------------------------------------\n\n# Создание выпуклой оболочки вокруг точек данных\nHull <- inla.nonconvex.hull(cbind(data$xkm, data$ykm), convex = -0.03)\n\n# Визуализация оболочки \n plot(Hull)\n```\n\n![Рис. 1.: Визуализация оболочки съемок](images/sdmTMB1.PNG){fig-align=\"center\" width=\"60%\"}\n\n```{r}\n#| output: false\n#| eval: false\n# Визуализация оболочки и точек съемок 2019-2024\npoints(data$xkm, data$ykm, pch=1, cex=0.55,col=\"black\")\n```\n\n![Рис. 2.: Визуализация оболочки и точек съемок](images/sdmTMB2.PNG){fig-align=\"center\" width=\"60%\"}\n\n```{r}\n#| output: false\n#| eval: false\n\n# Фильтрация сетки: оставляем только точки внутри оболочки\nline <- Hull$loc[, 1:2] %>% as.data.frame()\ncolnames(line) <- c(\"X\", \"Y\")\nGRID$AREA <- point.in.polygon(GRID$X, GRID$Y, line$X, line$Y)\nGRID <- GRID[GRID$AREA > 0.1, c(\"X\", \"Y\")]  # Только внутренние точки\n\n# -------------------------------------------------\n# 6. ПОДГОТОВКА СЕТКИ ДЛЯ ПРОГНОЗИРОВАНИЯ\n# -------------------------------------------------\n\n# Создание временной сетки (для каждого года)\ngrid <- replicate_df(GRID, \"YEAR\", unique(data$YEAR))\ncolnames(grid) <- c(\"xkm\", \"ykm\", \"YEAR\")\ngrid$SURV <- \"CRAB\"  # Добавляем информацию о типе съемки\n\n# Визуализация оболочки и сетки для прогнозирования (grid)\n plot(Hull)\n points(grid$xkm, grid$ykm, pch=1, cex=0.55,col=\"black\")\n```\n\n![Рис. 3.: Визуализация оболочки и сетки для прогнозирования (grid)](images/sdmTMB3.PNG){fig-align=\"center\" width=\"60%\"}\n\n```{r}\n#| output: false\n#| eval: false\n# ---------------------------------------------------\n# 7. ПОСТРОЕНИЕ ПРОСТРАНСТВЕННОЙ СЕТКИ (MESH)\n# ---------------------------------------------------\n\n# Создание треугольной сетки для пространственного моделирования\nmesh_sdm <- make_mesh(\n  data, \n  c(\"xkm\", \"ykm\"),  # Координаты\n  cutoff = 10        # Минимальное расстояние между узлами (км)\n)\n\n# Визуализация сетки \n plot(mesh_sdm)\n```\n\n![Рис. 4.: Визуализация сетки (mesh)](images/sdmTMB4.PNG){fig-align=\"center\" width=\"60%\"}\n\n```{r}\n#| output: false\n#| eval: false\n# ---------------------------------------------------\n# 8. ПОСТРОЕНИЕ ПРОСТРАНСТВЕННО-ВРЕМЕННОЙ МОДЕЛИ\n# ---------------------------------------------------\n\nm <- sdmTMB(\n  data = data, \n  formula = Density ~ 0 + as.factor(YEAR),  # Формула: плотность зависит от года\n  time = \"YEAR\",         # Временная переменная\n  mesh = mesh_sdm,       # Пространственная сетка\n  family = tweedie(link = \"log\"),  # Статистическое распределение\n  spatial = \"on\",        # Включение пространственных эффектов\n  spatiotemporal = \"iid\" # Пространственно-временные эффекты\n)\n\n# Вывод результатов модели\nsummary(m)\nAIC(m)  # Критерий Акаике\nsanity(m)  # Проверка корректности модели\n```\n\nПолучили результаты:\n\n```{r}\n#| output: false\n#| eval: false\n> # Вывод результатов модели\n> summary(m)\nSpatiotemporal model fit by ML ['sdmTMB']\nFormula: Density ~ 0 + as.factor(YEAR)\nMesh: mesh_sdm (isotropic covariance)\nTime column: YEAR\nData: data\nFamily: tweedie(link = 'log')\n \nConditional model:\n                    coef.est coef.se\nas.factor(YEAR)2019     2.15    0.72\nas.factor(YEAR)2020     1.49    0.76\nas.factor(YEAR)2021     1.74    0.76\nas.factor(YEAR)2022     1.62    0.73\nas.factor(YEAR)2023     1.50    0.74\nas.factor(YEAR)2024     1.56    0.72\n\nDispersion parameter: 19.71\nTweedie p: 1.50\nMatern range: 142.65\nSpatial SD: 2.01\nSpatiotemporal IID SD: 0.95\nML criterion at convergence: 5984.224\n\nSee ?tidy.sdmTMB to extract these values as a data frame.\n> AIC(m)  # Критерий Акаике\n[1] 11990.45\n> sanity(m)  # Проверка корректности модели\nv Non-linear minimizer suggests successful convergence\nv Hessian matrix is positive definite\nv No extreme or very small eigenvalues detected\nv No gradients with respect to fixed effects are >= 0.001\nv No fixed-effect standard errors are NA\nv No standard errors look unreasonably large\nv No sigma parameters are < 0.01\nv No sigma parameters are > 100\nv Range parameter doesn't look unreasonably large\n \n```\n\n#### **Годовые эффекты:**\n\n```         \n2019: 2.15 ± 0.72 → exp(2.15) ≈ 8.58 экз./км²\n2020: 1.49 ± 0.76 → exp(1.49) ≈ 4.44 экз./км²\n2024: 1.56 ± 0.72 → exp(1.56) ≈ 4.76 экз./км²\n```\n\n-   **2019 год** - пик запаса (8.58 экз./км²)\n\n-   **2020 год** - резкое снижение (-52% к 2019)\n\n-   **2021-2024** - стабилизация на уровне \\~4.5-5.0 экз./км²\n\n-   **Стандартные ошибки** \\~0.75:\n\n    -   Приемлемая точность для данных такого объема\n\n    -   Все годовые оценки статистически значимы\n\n    Модель пространственно-временного распределения плотности камчатского краба успешно прошла все диагностические проверки, демонстрируя отличную сходимость и статистическую надежность. Параметр распределения Твиди (p=1.50) оптимально соответствует данным траловых съемок, учитывая характерную для уловов передисперсию и избыток нулевых значений.\n\n    Годовые оценки показывают выраженную динамику запаса: в 2019 году зафиксирован пик плотности (8.58 экз./км²), после чего в 2020 году произошло резкое снижение до 4.44 экз./км². В последующие годы (2021-2024) плотность стабилизировалась на уровне 4.5-5.0 экз./км², что составляет примерно 55% от максимальных значений 2019 года. Стандартные ошибки годовых коэффициентов (0.72-0.76) свидетельствуют о хорошей точности оценок при текущем объеме данных.\n\n    Пространственная структура распределения характеризуется крупномасштабными скоплениями с диапазоном корреляции 143 км (Matern range: 142.65), что согласуется с известными особенностями миграций камчатского краба. Высокое значение пространственной изменчивости (SD=2.01) отражает типичную для вида мозаичность распределения, где участки высокой плотности соседствуют с зонами отсутствия особей. Умеренная пространственно-временная изменчивость (IID SD=0.95) указывает на относительную стабильность пространственной структуры запаса между годами.\n\n    Параметр дисперсии (19.71) подтверждает ожидаемо высокую вариабельность данных, характерную для траловых съемок морских гидробионтов. Полученные результаты надежно фиксируют значительное сокращение запаса после 2019 года с последующей стабилизацией на пониженном уровне.\n\n    ### **Пояснение результатов `sanity(m)` для начинающих гидробиологов (от DeepSeek):**\n\n    **1. `v Non-linear minimizer suggests successful convergence`**\\\n    (Нелинейный оптимизатор успешно сошелся)\\\n    *Пояснение:* Алгоритм поиска параметров модели корректно завершил работу. Это значит, что модель \"научилась\" описывать ваши данные и не застряла в промежуточных вычислениях. Как если бы вы успешно завершили лабораторный анализ без технических сбоев.\n\n    **2. `v Hessian matrix is positive definite`**\\\n    (Матрица Гессе положительно определена)\\\n    *Пояснение:* Математическое подтверждение, что найденные параметры модели действительно оптимальны. Аналогично тому, как в микроскопии вы видите четкий фокус - здесь модель \"четко видит\" закономерности в данных.\n\n    **3. `v No extreme or very small eigenvalues detected`**\\\n    (Не обнаружено экстремальных или очень маленьких собственных значений)\\\n    *Пояснение:* Модель статистически стабильна. Представьте, что вы измеряете длину рыб - если бы ваш штангенциркуль иногда показывал 0 или 1000 мм, это было бы проблемой. Здесь аналогично - вычисления надежны.\n\n    **4. `v No gradients with respect to fixed effects are >= 0.001`**\\\n    (Градиенты для фиксированных эффектов \\< 0.001)\\\n    *Пояснение:* Все ключевые параметры модели (например, влияние года на плотность) рассчитаны точно. Это как убедиться, что все измерения в вашем эксперименте выполнены с требуемой точностью (±0.1 мг, ±1 см и т.д.).\n\n    **5. `v No fixed-effect standard errors are NA`**\\\n    (Стандартные ошибки для фиксированных эффектов не отсутствуют)\\\n    *Пояснение:* Для каждого рассчитанного параметра (например, годовых оценок) указана погрешность. Важно как в химическом анализе - если для концентрации вещества нет погрешности, результат ненадежен.\n\n    **6. `v No standard errors look unreasonably large`**\\\n    (Стандартные ошибки выглядят разумными)\\\n    *Пояснение:* Погрешности оценок адекватны. Например, если плотность краба 5±1 экз./км² - это нормально, но 5±100 экз./км² было бы бессмысленным.\n\n    **7. `v No sigma parameters are < 0.01`**\\\n    (Параметры сигма не меньше 0.01)\\\n    *Пояснение:* Модель не игнорирует важные источники изменчивости. Аналогично тому, что в пробе воды вы не упустили бы важный показатель, сказав \"он слишком мал\".\n\n    **8. `v No sigma parameters are > 100`**\\\n    (Параметры сигма не превышают 100)\\\n    *Пояснение:* Модель не преувеличивает случайные вариации. Как если бы вы не приписали естественные колебания температуры воды катастрофическому изменению климата.\n\n    **9. `v Range parameter doesn't look unreasonably large`**\\\n    (Параметр диапазона не выглядит чрезмерно большим)\\\n    *Пояснение:* Пространственная автокорреляция имеет биологически осмысленный масштаб. Например, если модель показала бы, что скопления краба одинаковы на расстоянии 1000 км - это было бы нереалистично.\n\n```{r}\n#| output: false\n#| eval: false\n# ---------------------------------------------------\n# 9. ДИАГНОСТИКА МОДЕЛИ\n# ---------------------------------------------------\n\n# Расчет остатков модели\ndata$resids <- residuals(m) \n\n# Гистограмма остатков\nhist(data$resids)\n\n# График квантиль-квантиль\nqqnorm(data$resids)\nabline(a = 0, b = 1)\n```\n\n\n![Рис. 5.: Гистограмма остатков](images/sdmTMB5.PNG){fig-align=\"center\" width=\"60%\"}\n\n\n![Рис. 6.: График квантиль-квантиль](images/sdmTMB6.PNG){fig-align=\"center\" width=\"60%\"}\n\n```{r}\n#| output: false\n#| eval: false\n# ---------------------------------------------------\n# 10. ПРОГНОЗИРОВАНИЕ НА СЕТКЕ\n# ---------------------------------------------------\n\n# Прогноз значений плотности на сетке\npredictions <- predict(m, newdata = grid, return_tmb_object = TRUE)\nRASP <- predictions$data\n\n# Преобразование координат обратно в широту/долготу\nRASP$xkm_m <- RASP$xkm * 1000  # Обратно в метры\nRASP$ykm_m <- RASP$ykm * 1000\n\n# Создание пространственного объекта в UTM\nutm_proj <- CRS(\"+proj=utm +zone=37 +datum=WGS84 +units=m +no_defs\")\ncoords <- cbind(RASP$xkm_m, RASP$ykm_m)\nsp_points <- SpatialPoints(coords, proj4string = utm_proj)\n\n# Преобразование в WGS84 (широта/долгота)\nwgs84_proj <- CRS(\"+proj=longlat +datum=WGS84\")\nsp_points_latlon <- spTransform(sp_points, wgs84_proj)\n\n# Добавление координат в основной датафрейм\nRASP$X <- coordinates(sp_points_latlon)[, 1]  # Долгота\nRASP$Y <- coordinates(sp_points_latlon)[, 2]  # Широта\n\n# Удаление временных столбцов\nRASP$xkm_m <- NULL\nRASP$ykm_m <- NULL\n\n# Проверка структуры результата\nstr(RASP)\n\n# ---------------------------------------------\n# 11. ВИЗУАЛИЗАЦИЯ РЕЗУЛЬТАТОВ (КАРТА)\n# ---------------------------------------------\n\n# Загрузка картографических данных\nworld <- ne_countries(scale = \"medium\", returnclass = \"sf\")\n\n# Определение региона интереса (Арктика России)\narctic_bbox <- st_bbox(c(xmin = 25, xmax = 70, ymin = 65, ymax = 80), crs = 4326)\narctic <- st_crop(world, arctic_bbox)\n\n# Кастомные разрывы для цветовой шкалы\nmy_breaks <- c(0.001, 0.1, 1, 200, 10000)\n\n# Создание основной визуализации\nggplot() +\n  # Теплокарта плотности\n  geom_point(\n    data = RASP, \n    aes(x = X, y = Y, color = exp(est)), \n    size = 0.8, \n    alpha = 0.7\n  ) + \n  # Наблюдаемые точки данных\n  geom_point(\n    data = data, \n    aes(x = X, y = Y, size = Density), # Размер по плотности\n    color = \"black\", \n    fill = NA, \n    alpha = 0.6,\n    shape = 21 # Кружки с обводкой\n  ) +\n  # Картографическая подложка\n  geom_sf(data = arctic, fill = \"lightgrey\", color = \"darkgrey\") +\n  # Цветовая шкала (логарифмическая)\n  scale_color_viridis_c(\n    name = \"\",\n    option = \"H\", \n    trans = \"log\", \n    breaks = my_breaks, \n    labels = my_breaks\n  ) +\n  # Разделение по годам\n  facet_wrap(~ YEAR, ncol = 2) +\n  # Настройка области просмотра\n  coord_sf(\n    xlim = c(min(RASP$X)-1, max(RASP$X)+1),\n    ylim = c(min(RASP$Y)-0.5, max(RASP$Y)+0.5),\n    crs = 4326\n  ) +\n  # Тема оформления\n  theme_bw(base_size = 12) +\n  labs(x = \"Долгота\", y = \"Широта\", title = \"Пространственное распределение плотности\") +\n  theme(\n    panel.grid = element_line(color = \"grey90\"),\n    legend.position = \"bottom\",\n    legend.key.width = unit(1.2, \"cm\"),\n    strip.background = element_rect(fill = \"white\")\n  )\n\n# Сохранение графика (раскомментируйте)\n ggsave(\"sdmTMBmap10.jpg\", width = 8, height = 8, dpi = 300)\n\n```\n![Рис. 7.: Визуализация результатов (КАРТА)](images/sdmTMBmap10.jpg){fig-align=\"center\" width=\"60%\"}\n\n\n```{r}\n#| output: false\n#| eval: false\n# ---------------------------------------------------\n# 12. РАСЧЕТ ИНДЕКСОВ ОБИЛИЯ\n# ---------------------------------------------------\n\n# Расчет индексов с разными доверительными интервалами\nindex <- get_index(predictions, area = 4, level = 0.95, bias_correct = TRUE)\nindex2 <- get_index(predictions, area = 4, level = 0.5, bias_correct = TRUE)\n\n# Формирование сводной таблицы результатов\ntotal <- data.frame(\n  YEAR = index$YEAR,\n  lwr_95 = index$lwr,\n  lwr_50 = index2$lwr,\n  estimate = index$est,\n  upr_50 = index2$upr,\n  upr_95 = index$upr,\n  se = index$se,\n  cv = sqrt(exp(index$se^2) - 1) # Коэффициент вариации\n)\n\n# Визуализация индексов обилия\nggplot(total, aes(x = YEAR, y = estimate/1000000)) + \n  # Основная линия оценки\n  geom_line(linewidth = 1, color = \"steelblue\") +\n  \n  # 95% доверительный интервал (более широкий и прозрачный)\n  geom_ribbon(\n    aes(ymin = lwr_95/1000000, ymax = upr_95/1000000),\n    alpha = 0.2,  # Полупрозрачность\n    fill = \"steelblue\",\n    color = NA     # Без контура\n  ) +\n  \n  # 50% доверительный интервал (менее прозрачный)\n  geom_ribbon(\n    aes(ymin = lwr_50/1000000, ymax = upr_50/1000000),\n    alpha = 0.4,  # Меньшая прозрачность\n    fill = \"steelblue\",\n    color = NA\n  ) +\n  \n  # Настройки осей и заголовков\n  ylab('Промысловый запас, млн. экз') +\n  xlab('Год') +\n  \n  # Вертикальные линии для годов\n  geom_vline(\n    xintercept = total$YEAR, \n    linetype = \"dotted\", \n    color = \"grey60\", \n    alpha = 0.6\n  ) +\n  \n  # Точки с значениями оценок\n  geom_point(\n    size = 3,\n    color = \"navyblue\",\n    fill = \"white\",\n    shape = 21\n  ) +\n  \n  # Настройка темы\n  theme_minimal(base_size = 14) +\n  theme(\n    plot.title = element_text(hjust = 0.5, face = \"bold\"),\n    panel.grid.minor = element_blank(),\n    panel.grid.major = element_line(color = \"grey90\"),\n    axis.line = element_line(color = \"grey30\"),\n    legend.position = \"none\"\n  )\n\n```\n![Рис. 8.: Визуализация индексов обилия](images/sdmTMB7.PNG){fig-align=\"center\" width=\"60%\"}\n\n```{r}\n#| output: false\n#| eval: false\n# Форматированный вывод результатов\ntotal %>% \n  mutate(cv_percent = 100 * cv) %>% \n  select(\n    YEAR, \n    estimate, \n    lwr_50,  # Нижняя граница 50% ДИ\n    upr_50,  # Верхняя граница 50% ДИ\n    lwr_95,  # Нижняя граница 95% ДИ\n    upr_95,  # Верхняя граница 95% ДИ\n    cv_percent\n  ) %>%\n  knitr::kable(\n    format = \"pandoc\", \n    digits = c(0, 0, 0, 0, 0, 0, 1),\n    col.names = c(\n      \"Год\", \n      \"Оценка\", \n      \"Нижняя 50%\", \n      \"Верхняя 50%\", \n      \"Нижняя 95%\", \n      \"Верхняя 95%\", \n      \"CV%\"\n    )\n  )\n```\n\n```{r}\n#| output: false\n#| eval: false\n  Год    Оценка   Нижняя 50%   Верхняя 50%   Нижняя 95%   Верхняя 95%    CV%\n-----  --------  -----------  ------------  -----------  ------------  -----\n 2019   2381774      2177448       2605274      1835312       3090946   13.4\n 2020   1634549      1539111       1735906      1372377       1946805    8.9\n 2021   1920507      1794122       2055795      1575823       2340584   10.1\n 2022   1036673       959251       1120344       827345       1298963   11.5\n 2023   1147685      1068401       1232853       932147       1413062   10.6\n 2024   1055733       985624       1130829       864640       1289060   10.2\n> \n\n```\n\n## Базовая оценка + предикторы\n\nТекст. Текст. Текст.\n\n## Визуализация эффектов\n\nТекст. Текст. Текст.\n\n## Карта с акцентом на нулевые уловы\n\n## Определение площади съемки\n\n## Присоединение факторов к данным съемок\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"chapter 4.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.7.29","bibliography":["references.bib"],"editor":"visual","theme":["cosmo","brand"],"title":"sdmTMB - оценка и визуализация индекса обилия по съемке"},"extensions":{"book":{"multiFile":true}}},"pdf":{"identifier":{"display-name":"PDF","target-format":"pdf","base-format":"pdf"},"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","output-file":"chapter 4.pdf"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"block-headings":true,"bibliography":["references.bib"],"editor":"visual","documentclass":"scrreprt","title":"sdmTMB - оценка и визуализация индекса обилия по съемке"},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html","pdf"]}