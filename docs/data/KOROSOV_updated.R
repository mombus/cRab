# ЗАГРУЗКА БИБЛИОТЕК И НАСТРОЙКА СРЕДЫ ================================
library(neuralnet)   # Для построения нейронных сетей
library(ggplot2)     # Для продвинутой визуализации (в данном скрипте не используется напрямую)

# Установите свою рабочую директорию (где лежат файлы данных)
 setwd("C:/COURSES/ЛЕКЦИИ")


# РАЗДЕЛ 1: ЛИНЕЙНАЯ РЕГРЕССИЯ ======================================
### Основы экологического моделирования
# Как масса животного зависит от его длины тела?

# Данные: масса (w) и длина тела (lt) гадюк (в см и граммах)
w <- c(85, 90, 85, 95, 95, 135, 165, 135, 140)
lt <- c(51, 51, 52, 54, 54, 59, 59, 60, 62)

# Построение линейной модели: w = a0 + a1*lt
lreg <- lm(w ~ lt)

# Просмотр результатов модели:
summary(lreg)  # Обратите внимание на коэффициенты и p-значения

# Визуализация зависимости
plot(lt, w, 
     main = "Зависимость массы от длины тела гадюки", 
     xlab = "Длина тела (см)", 
     ylab = "Масса (г)", 
     pch = 19,        # Кружки вместо стандартных точек
     col = "darkgreen")
abline(lreg, col = "red", lwd = 2)  # Добавляем линию регрессии

# РАЗДЕЛ 2: ЧИСЛЕННАЯ ОПТИМИЗАЦИЯ ==================================
### Альтернативный подход к настройке параметров
# Иногда аналитическое решение невозможно - используем численные методы

# Подгонка параметров через оптимизацию
nls_model <- nls(w ~ a0 + a1 * lt, start = list(a0 = 1, a1 = 1))
summary(nls_model)

# Сравнение методов:
cat("Метод наименьших квадратов (lm):", coef(lreg), "\n")
cat("Численная оптимизация (nls):", coef(nls_model))

# РАЗДЕЛ 3: МНОЖЕСТВЕННАЯ РЕГРЕССИЯ ================================
### Учет комплексных экологических факторов
# Добавляем новый признак - длину хвоста (lc)
w <- c(40, 156, 105, 85, 80, 50, 75, 48, 75, 67)
lt <- c(44, 59, 49, 50, 54, 43, 49, 42, 47, 47)
lc <- c(70, 78, 66, 90, 83, 70, 62, 75, 40, 80)

# Множественная регрессия: w = a0 + a1*lt + a2*lc
multi_reg <- glm(w ~ lt + lc)
summary(multi_reg)

# РАЗДЕЛ 4: НЕЛИНЕЙНЫЕ ЗАВИСИМОСТИ ================================
### Моделирование аллометрических зависимостей
# Часто в экологии связи имеют степенной характер: w = a0 * lt^a1
# Линеаризация через логарифмирование
log_model <- lm(log(w) ~ log(lt))

# Преобразование коэффициентов обратно
a0 <- exp(coef(log_model)[1])  # Переход от логарифмов
a1 <- coef(log_model)[2]       # Показатель степени

# Визуализация степенной зависимости
plot(lt, w, 
     main = "Степенная зависимость массы от длины", 
     xlab = "Длина тела (см)", 
     ylab = "Масса (г)",
     pch = 17,
     col = "blue")
curve(a0 * x^a1, add = TRUE, col = "red", lwd = 2)  # Кривая модели

# РАЗДЕЛ 5: ЛОГИСТИЧЕСКАЯ РЕГРЕССИЯ ===============================
### Моделирование пороговых эффектов в экологии
# Пример: смертность дафний при разных концентрациях токсиканта

# Данные:
K <- c(100, 126, 158, 200, 251, 316, 398, 501, 631, 794, 1000)
p <- c(0, 0, 0, 0, 0, 0.5, 0.5, 1, 1, 1, 1)  # Доля погибших
d <- data.frame(K, p)

# Построение логистической модели
logit_model <- glm(p ~ K, family = binomial(), data = d)

# Визуализация S-образной кривой
plot(d$K, d$p, 
     xlab = "Концентрация токсиканта (мг/л)", 
     ylab = "Доля погибших", 
     main = "Токсическое воздействие на дафний",
     pch = 19,
     col = "red")
lines(d$K, predict(logit_model, type = "response"), 
      col = "blue", lwd = 2, lty = 1)

# РАЗДЕЛ 6: ПЕРЕХОД К НЕЙРОННЫМ СЕТЯМ =============================
### От регрессии к нейронным конструкциям

# Простейшая нейросеть (аналог линейной регрессии)
nn_simple <- neuralnet(p ~ K, data = d, hidden = 0)

# Визуализация структуры сети
plot(nn_simple, rep = "best")

# РАЗДЕЛ 7: НЕЙРОНЫ КАК НЕЛИНЕЙНЫЕ ПРЕОБРАЗОВАТЕЛИ ================
### Реализация сложных зависимостей

# Сеть с одним скрытым нейроном (имитирует логистическую регрессию)
nn_1hidden <- neuralnet(p ~ K, data = d, hidden = 1)

# Сравнение с логистической регрессией
plot(d$K, predict(logit_model, type = "response"), 
     type = "l", 
     col = "darkgreen", 
     lwd = 2,
     xlab = "Концентрация", 
     ylab = "Смертность",
     main = "Сравнение моделей")
lines(d$K, predict(nn_1hidden, d), col = "blue", lty = 2, lwd = 2)
legend("bottomright", 
       legend = c("Логистическая регрессия", "Нейронная сеть (1 нейрон)"),
       col = c("darkgreen", "blue"), 
       lty = 1:2,
       lwd = 2)

# РАЗДЕЛ 8: КЛАССИФИКАЦИЯ В ЭКОЛОГИИ =============================
### Определение пола животных по морфометрическим признакам

# Загрузка данных по гадюкам (пол, длина тела, длина хвоста, масса)
v <- read.csv("vipkar.csv")
head(v, 3)  # Просмотр первых строк данных

## 8.1 Модель без скрытых нейронов (аналог линейной регрессии)
nv0 <- neuralnet(ns ~ lc, data = v, hidden = 0)
plot(nv0)  # Визуализация простейшей сети

## 8.2 Модель с одним скрытым нейроном
nv1 <- neuralnet(ns ~ lc, data = v, hidden = 1)
plot(nv1)  # Схема сети с одним нейроном

## 8.3 Модель с тремя скрытыми нейронами (полноценная нейросеть)
nv3 <- neuralnet(ns ~ lc + lt + w, data = v, hidden = 3)
plot(nv3)  # Визуализация сложной сети

# Оценка точности классификации
predictions <- predict(nv3, v)
predicted_sex <- round(predictions)
accuracy <- mean(v$ns == predicted_sex)
cat("Точность классификации:", round(accuracy*100, 1), "%\n")

# РАЗДЕЛ 9: ПРОСТРАНСТВЕННОЕ МОДЕЛИРОВАНИЕ ======================
### Прогнозирование распространения видов

# Данные по островам Кижского архипелага
v <- read.csv("kihzsdat.csv")
head(v, 3)  # Структура данных: площадь, биотопы, численность видов

# Случайное разделение данных на обучающую и тестовую выборки
set.seed(123)  # Для воспроизводимости
train_indices <- sample(1:nrow(v), 12)
train_data <- v[train_indices, ]
test_data <- v[-train_indices, ]

# Построение нейросети с 5 нейронами в скрытом слое
model <- neuralnet(vb ~ fo + me + bo, data = train_data, hidden = 5)

# Прогнозирование на обучающей выборке
train_pred <- predict(model, train_data)
train_accuracy <- mean(round(train_pred) == train_data$vb)
cat("Точность на обучающей выборке:", round(train_accuracy*100, 1), "%\n")

# Прогнозирование на тестовой выборке
test_pred <- predict(model, test_data)
test_accuracy <- mean(round(test_pred) == test_data$vb)
cat("Точность на тестовой выборке:", round(test_accuracy*100, 1), "%\n")

# Прогноз для новых условий (пример)
new_conditions <- data.frame(
  fo = c(57.9, 35.3, 83.0),  # Площадь лесов (%)
  me = c(4.1, 0.0, 7.3),     # Площадь лугов (%)
  bo = c(3.4, 7.9, 11.5)     # Площадь болот (%)
)

future_pred <- predict(model, new_conditions)
cat("Прогнозируемая численность гадюк:", round(future_pred), "\n")
