<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.29">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>8&nbsp; Прогноз пополнения: от факторов до ансамбля – Оценка водных биоресурсов при недостатке данных в среде R (для начинающих)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./chapter 8.html" rel="next">
<link href="./chapter 6.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-0815c480559380816a4d1ea211a47e91.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-364982630eef5352dd1537128a8ed5cb.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./chapter 7.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Прогноз пополнения: от факторов до ансамбля</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Оценка водных биоресурсов при недостатке данных в среде R (для начинающих)</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Аннотация</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Введение</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter 1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Анализ и визуализация данных улова</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter 2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Нейронные сети в экологии: практическое введение</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter 3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Основы картографии</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter 4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">sdmTMB - оценка и визуализация индекса обилия по съемке</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter 5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Продукционная модель SPiCT</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter 6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Продукционная модель JABBA</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter 7.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Прогноз пополнения: от факторов до ансамбля</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter 8.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Введение в прогнозирование</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter 9.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">ПРП и стратегии управления</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#введение" id="toc-введение" class="nav-link active" data-scroll-target="#введение"><span class="header-section-number">8.1</span> Введение</a></li>
  <li><a href="#выбор-предикторов" id="toc-выбор-предикторов" class="nav-link" data-scroll-target="#выбор-предикторов"><span class="header-section-number">8.2</span> Выбор предикторов</a></li>
  <li><a href="#модели-запас-пополнение-рикера-и-бивертона-холта" id="toc-модели-запас-пополнение-рикера-и-бивертона-холта" class="nav-link" data-scroll-target="#модели-запас-пополнение-рикера-и-бивертона-холта"><span class="header-section-number">8.3</span> Модели «запас-пополнение» Рикера и Бивертона-Холта</a></li>
  <li><a href="#статистические-модели-lmglmgam" id="toc-статистические-модели-lmglmgam" class="nav-link" data-scroll-target="#статистические-модели-lmglmgam"><span class="header-section-number">8.4</span> Статистические модели LM/GLM/GAM</a></li>
  <li><a href="#полный-цикл-от-факторов-до-ансамблевого-прогноза" id="toc-полный-цикл-от-факторов-до-ансамблевого-прогноза" class="nav-link" data-scroll-target="#полный-цикл-от-факторов-до-ансамблевого-прогноза"><span class="header-section-number">8.5</span> Полный цикл от факторов до ансамблевого прогноза</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Прогноз пополнения: от факторов до ансамбля</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="введение" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="введение"><span class="header-section-number">8.1</span> Введение</h2>
<p>В этой практической работе представлен цикл прикладного анализа зависимости пополнения запаса гидробионта от факторов среды (в том числе нерестового запаса): от подготовки данных и отбора предикторов до сравнения нескольких семейств моделей, выбора устойчивой к хронологии прогностической схемы и построения прогноза с доверительными интервалами. Подход ориентирован на начинающих, но использует современные приёмы: автоматический отбор признаков (Boruta, LASSO), сопоставление линейных/нелинейных моделей, time-slice валидацию и ансамблевый прогноз. • Целевая переменная: R3haddock — пополнение запаса. • Кандидатные предикторы: гидрометеорология (температуры T…), океанография (O…), биотические показатели (например, codTSB) и нерестовый запас (haddock68). • Цель анализа: понять, какие факторы и в каких формах оказываются значимыми, отобрать рабочий набор моделей и получить прогноз на 2022–2024 с оценкой неопределенности.</p>
<p>Настоящий анализ разделен на несколько этапов:</p>
<ol type="1">
<li><p>Выбор предикторов. Скрипт можно скачать по <a href="https://mombus.github.io/cRab/data/RECRUITMENT_PREDICTORS.R">ссылке</a></p></li>
<li><p>Построение биологически мотивированных (механистических) нелинейных классических моделей «запас-пополнение» Рикера и Бивертона-Холта. Анализ их значимости и сравнение с моделями LM/GLM/GAM. Скрипт можно скачать по <a href="https://mombus.github.io/cRab/data/RECRUITMENT_CLASSIC.R">ссылке</a></p></li>
<li><p>Построение классических статистических моделей LM/GLM/GAM. Анализ их прогностических способностей и выполнение прогноза. Скрипт можно скачать по <a href="https://mombus.github.io/cRab/data/RECRUITMENT_LM_GLM_GAM.R">ссылке</a></p></li>
<li><p>Полный цикл ( <a href="https://mombus.github.io/cRab/data/RECRUITMENT_MAIN.R">СКРИПТ</a>) прикладного анализа зависимости пополнения запаса гидробионта от факторов среды, включающий:</p></li>
</ol>
<ul>
<li><p>а) выбор предикторов;</p></li>
<li><p>б) базовое сравнение различных моделей;</p></li>
<li><p>в) выбор лучшей прогностической модели;</p></li>
<li><p>г) ансамблевый прогноз.</p></li>
</ul>
<p>Входные данные для работы скрипта: RECRUITMENT.xlsx, а также промежуточный файл с готовым набором предикторов: selected_predictors_dataset.csv.</p>
</section>
<section id="выбор-предикторов" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="выбор-предикторов"><span class="header-section-number">8.2</span> Выбор предикторов</h2>
<p>В процессе анализа факторов, влияющих на пополнение рыбных запасов, ключевым этапом является тщательная подготовка данных и отбор наиболее информативных предикторов, поскольку качество последующих моделей напрямую зависит от качества входных данных. Начиная с первичной обработки, мы приводим все потенциальные предикторы к числовому формату, так как большинство статистических и машинно-обучаемых моделей требуют именно такой представления данных, при этом заменяем строковые обозначения пропущенных значений «NA» на стандартные NA, что позволяет системе R корректно обрабатывать отсутствующие наблюдения. Для заполнения пропусков мы применяем медианную импутацию, которая представляет собой простой и устойчивый к выбросам метод, поскольку медиана менее чувствительна к экстремальным значениям по сравнению со средним. Хотя существуют и более сложные альтернативы, такие как множественная импутация с использованием пакета mice, KNN-импутация через recipes::step_impute_knn или даже методы, специально разработанные для временных рядов, например, фильтр Калмана или ARIMA-модели, медианная импутация остается практичным выбором для начального этапа анализа, особенно когда объем данных ограничен или временные зависимости не являются доминирующими. Следующим важным этапом является анализ корреляционной структуры данных, поскольку высокая мультиколлинеарность между предикторами может серьезно ухудшить интерпретацию моделей и завысить дисперсию оценок параметров, особенно в линейных моделях. Для автоматического выявления и устранения сильно коррелированных переменных мы используем функцию findCorrelation с пороговым значением коэффициента корреляции 0.8, что позволяет сохранить лишь один представитель из каждой группы высококоррелированных переменных. Хотя альтернативными подходами могут служить диагностика по значениям VIF или применение методов снижения размерности, таких как PLS или PCA, удаление явно коррелированных предикторов оказывается наиболее прямолинейным решением для обеспечения стабильности последующих моделей. Для автоматического отбора наиболее значимых предикторов мы применяем два дополнительных метода, которые по-разному подходят к этой задаче и тем самым обеспечивают взаимную проверку результатов. Boruta представляет собой обертку над алгоритмом Random Forest, которая генерирует «теневые» переменные, полученные путем случайного перемешивания исходных признаков, и сравнивает важность реальных предикторов с этими теневыми копиями, сохраняя только те переменные, чья важность статистически превосходит уровень шума. Этот метод особенно эффективен при наличии нелинейных зависимостей и взаимодействий между переменными, демонстрируя высокую устойчивость к шуму, хотя и требует больше вычислительных ресурсов и может излишне благоволить к группам коррелированных признаков. Параллельно мы применяем LASSO-регрессию из пакета glmnet, которая использует L1-регуляризацию для зануления коэффициентов слабо влияющих предикторов, тем самым выполняет отбор признаков в процессе оценки модели. При выборе оптимального значения параметра регуляризации lambda мы сознательно предпочитаем значение lambda.1se, которое соответствует более простой модели, но при этом находится в пределах одной стандартной ошибки от минимального значения ошибки, так как этот консервативный подход часто обеспечивает лучшую обобщающую способность на небольших выборках, характерных для экологических данных. Однако LASSO имеет свои ограничения: он чувствителен к масштабу переменных, что делает центрирование и стандартизацию обязательными предварительными шагами, и предполагает линейную форму зависимости между предикторами и откликом, что может не соответствовать реальной биологической природе процессов. Финальный набор предикторов формируется как объединение результатов Boruta и LASSO с учетом биологической логики, что повышает устойчивость отбора к случайным флуктуациям, присущим каждому отдельному методу, и гарантирует включение ключевых переменных, таких как нерестовый запас (haddock68), который биологически должен влиять на пополнение запаса. Для предварительной проверки значимости отобранных предикторов мы строим простую линейную модель, которая не предназначена для окончательного прогноза, но служит в качестве sanity-check, позволяя оценить порядок величины эффектов и выявить явно незначимые или противоречащие биологической логике переменные. Важно отметить несколько нюансов и потенциальных подводных камней, с которыми можно столкнуться на этом этапе: если распределение целевой переменной R3haddock сильно скошено, может потребоваться лог-трансформация или использование моделей, специально разработанных для положительных откликов, таких как Gamma GLM; корреляция между переменными не обязательно отражает причинно-следственные связи, и при удалении высококоррелированных предикторов мы можем потерять полезную информацию, поэтому в некоторых случаях лучше применять методы, сохраняющие информацию из всех переменных, например, PLS или GAM; наконец, медианная импутация, хотя и проста в применении, может быть недостаточно точной для временных рядов, где хронологически осмысленная импутация, такая как скользящая медиана или интерполяция, часто дает более реалистичные результаты, учитывающие естественную динамику экологических процессов. Таким образом, этап подготовки данных и отбора предикторов представляет собой критически важный фундамент для последующего построения качественных моделей прогнозирования пополнения рыбных запасов, где баланс между статистической строгостью и биологической интерпретируемостью определяет успех всего анализа.</p>
<div class="cell" data-code-line-count="true" data-code-max-lines="5">
<details class="code-fold">
<summary>Показать скрипт</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) ВЫБОР ПРЕДИКТОРОВ</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------------------</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Цель блока: привести данные к числовому виду, обработать пропуски, сократить</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># мультиколлинеарность (сильные корреляции), а затем автоматически выделить</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># кандидатов-предикторов двумя методами (Boruta, LASSO). В конце сформируем</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># финальный пул признаков и проверим их значимость в простой LM.</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Установка и подключение необходимых библиотек</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Для автоматического отбора предикторов нам понадобятся дополнительные пакеты</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"pacman"</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  readxl, tidyverse, caret, corrplot, mgcv, randomForest, xgboost,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  Boruta,GGally, FactoMineR, glmnet, recipes, rsample  <span class="co"># Новые библиотеки для автоматического отбора</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Очистка среды и установка рабочей директории</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Совет: rm(list=ls()) очищает все объекты в памяти R; setwd задаёт папку,</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># где искать/сохранять файлы. Убедитесь, что путь корректен на вашей машине.</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"C:/RECRUITMENT/"</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Пакеты для расширенного отбора предикторов</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Boruta — обёртка над Random Forest для отбора признаков;</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># glmnet — регуляризация (LASSO/ElasticNet) для отбора/усиления обобщающей способности;</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># FactoMineR — PCA и другие многомерные методы (используем как утилиту).</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Boruta)   <span class="co"># Алгоритм обертки для отбора признаков</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)   <span class="co"># LASSO-регрессия</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(FactoMineR) <span class="co"># PCA анализ</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Загрузка и первичная обработка данных</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Шаги: фильтруем годы, приводим типы к числовому, заменяем строковые "NA" на NA.</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>DATA <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_excel</span>(<span class="st">"RECRUITMENT.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"RECRUITMENT"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEAR <span class="sc">&gt;</span> <span class="dv">1989</span> <span class="sc">&amp;</span> YEAR <span class="sc">&lt;</span> <span class="dv">2022</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Преобразуем необходимые столбцы в числовой формат</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"T"</span>), as.numeric),</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"I"</span>), as.numeric),</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"O"</span>), as.numeric),</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Обработка пропущенных значений (заменяем строку "NA" на NA)</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), <span class="sc">~</span><span class="fu">na_if</span>(., <span class="st">"NA"</span>)))</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Подготовка данных -------------------------------------------------------</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Выделим все возможные предикторы, включая географию и индексы трески</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Примечание: оставляем только числовые переменные, т.к. большинство моделей</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="co"># требует числовой вход без категориальных уровней.</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>predictors <span class="ot">&lt;-</span> DATA <span class="sc">%&gt;%</span> </span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>YEAR, <span class="sc">-</span>R3haddock) <span class="sc">%&gt;%</span> </span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select_if</span>(is.numeric) <span class="co"># Только числовые переменные</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Целевая переменная</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>response <span class="ot">&lt;-</span> DATA<span class="sc">$</span>R3haddock</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="co"># В статистическом анализе мы различаем:</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="co"># - Отклик (response/target variable) - то, что мы пытаемся предсказать (в нашем случае R3haddock)</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="co"># - Предикторы (predictors/features) - переменные, которые могут объяснять изменения отклика</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Для корректного анализа важно, чтобы предикторы были числовыми или преобразованы в числовой формат.</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Обработка пропусков -----------------------------------------------------</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Заполнение медианными значениями — простой и устойчивый способ справиться с NA.</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Альтернативы: множественная иммутация (mice), KNN-impute и др.</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>predictors_filled <span class="ot">&lt;-</span> predictors <span class="sc">%&gt;%</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">ifelse</span>(<span class="fu">is.na</span>(.), <span class="fu">median</span>(., <span class="at">na.rm =</span> <span class="cn">TRUE</span>), .)))</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Заполнение медианой - простой и устойчивый метод обработки пропусков для числовых переменных.</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Медиана предпочтительнее среднего, так как менее чувствительна к выбросам.</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Предварительный анализ корреляций ---------------------------------------</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Зачем: высокие корреляции затрудняют интерпретацию и могут вредить ряду моделей.</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>cor_matrix <span class="ot">&lt;-</span> <span class="fu">cor</span>(predictors_filled, <span class="at">use =</span> <span class="st">"complete.obs"</span>)</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="fu">corrplot</span>(cor_matrix, <span class="at">method =</span> <span class="st">"circle"</span>, <span class="at">type =</span> <span class="st">"upper"</span>, <span class="at">tl.cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Удаляем высокоскоррелированные предикторы (r &gt; 0.8)</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Это механическое сокращение мультиколлинеарности до этапа отбора.</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>high_cor <span class="ot">&lt;-</span> <span class="fu">findCorrelation</span>(cor_matrix, <span class="at">cutoff =</span> <span class="fl">0.8</span>)</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>predictors_filtered <span class="ot">&lt;-</span> predictors_filled[, <span class="sc">-</span>high_cor]</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Высокая корреляция между предикторами (мультиколлинеарность) может привести к нестабильности моделей.</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Например, если два предиктора почти идентичны, модель может неустойчиво распределять их влияние на отклик.</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Удаление сильно коррелированных переменных (r &gt; 0.8) помогает улучшить интерпретируемость и стабильность моделей.</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Автоматизированный отбор Boruta (обертка Random Forest) -----------------</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Идея: определить признаки, которые важнее, чем случайный шум (shadow features).</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>boruta_output <span class="ot">&lt;-</span> <span class="fu">Boruta</span>(</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> predictors_filtered, </span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> response,</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">maxRuns =</span> <span class="dv">100</span>,</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">doTrace =</span> <span class="dv">2</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Визуализация результатов</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(boruta_output, <span class="at">cex.axis =</span> <span class="fl">0.7</span>, <span class="at">las =</span> <span class="dv">2</span>)</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>boruta_stats <span class="ot">&lt;-</span> <span class="fu">attStats</span>(boruta_output)</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>selected_vars <span class="ot">&lt;-</span> <span class="fu">getSelectedAttributes</span>(boruta_output, <span class="at">withTentative =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Boruta - это алгоритм отбора признаков, основанный на методе случайного леса.</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Он сравнивает важность реальных переменных с "теневыми" переменными (случайными копиями),</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a><span class="co"># чтобы определить, действительно ли переменная информативна. [[6]]</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Результаты Boruta показывают: </span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a><span class="co">#   - Confirmed (зеленые) - значимые предикторы</span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a><span class="co">#   - Tentative (желтые) - предикторы, близкие к порогу значимости</span></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a><span class="co">#   - Rejected (красные) - незначимые предикторы</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. LASSO с более строгим критерием ------------------------------------------</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Идея: L1-регуляризация зануляет коэффициенты «слабых» предикторов.</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Выбор lambda.1se вместо lambda.min — более консервативный (простая модель).</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(predictors_filtered)</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> response</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a><span class="co"># LASSO (Least Absolute Shrinkage and Selection Operator) - метод регрессии с L1-регуляризацией,</span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a><span class="co"># который одновременно выполняет отбор признаков и оценку коэффициентов. [[8]]</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Параметр lambda контролирует силу регуляризации:</span></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a><span class="co">#   - lambda.min дает наименьшую ошибку, но может включать шумовые переменные</span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a><span class="co">#   - lambda.1se (на 1 стандартную ошибку больше) дает более простую модель с меньшим риском переобучения</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Для прогнозирования мы предпочитаем более строгий критерий (lambda.1se), чтобы модель была устойчивее. [[1]]</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Кросс-валидация</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>cv_fit <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(x, y, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">nfolds =</span> <span class="dv">10</span>)</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv_fit)</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a><span class="co"># ИСПОЛЬЗУЕМ lambda.1se вместо lambda.min — СТРОЖЕ!</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>lasso_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(cv_fit, <span class="at">s =</span> <span class="st">"lambda.1se"</span>)  <span class="co"># &lt;-- Ключевое изменение!</span></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>lasso_vars <span class="ot">&lt;-</span> <span class="fu">rownames</span>(lasso_coef)[lasso_coef[,<span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>][<span class="sc">-</span><span class="dv">1</span>]  <span class="co"># исключаем (Intercept)</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Сравнение отобранных предикторов ----------------------------------------</span></span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a><span class="co"># Полезно видеть, какие признаки отмечают оба метода (устойчивые кандидаты).</span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Boruta selected:"</span>, <span class="fu">length</span>(selected_vars), <span class="st">"variables</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(selected_vars)</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">LASSO selected:"</span>, <span class="fu">length</span>(lasso_vars), <span class="st">"variables</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lasso_vars)</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Финальный набор предикторов (объединение результатов) -------------------</span></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a><span class="co"># Логика: объединяем списки, добавляем биологически важные переменные вручную.</span></span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>final_vars <span class="ot">&lt;-</span> <span class="fu">union</span>(selected_vars, lasso_vars) </span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a><span class="co"># Добавляем обязательные переменные по биологической логике</span></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>mandatory <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"haddock68"</span>)</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>final_vars <span class="ot">&lt;-</span> <span class="fu">union</span>(final_vars, mandatory) <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Мы объединяем результаты двух методов отбора признаков для большей надежности.</span></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Также добавляем переменную haddock68 (нерестовый запас), так как биологически </span></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a><span class="co"># логично, что пополнение запаса напрямую зависит от численности производителей. </span></span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a><span class="co"># Это пример интеграции экспертных знаний в статистический анализ - важный принцип </span></span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a><span class="co"># при работе с данными в биологических науках.</span></span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Проверка значимости -----------------------------------------------------</span></span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Быстрая оценка значимости с LM: не как окончательный вывод, а как sanity-check.</span></span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>final_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(response <span class="sc">~</span> <span class="fu">as.matrix</span>(predictors_filled[, final_vars]))</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(final_model)</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Формирование финального датасета ----------------------------------------</span></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a><span class="co"># Собираем набор с откликом и выбранными предикторами; удалим строки с NA.</span></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> DATA <span class="sc">%&gt;%</span></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(R3haddock, <span class="fu">all_of</span>(final_vars)) <span class="sc">%&gt;%</span></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a><span class="co"># Просмотр структуры финальных данных</span></span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(model_data)</span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a><span class="co"># Визуализация важности переменных</span></span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a><span class="co"># Внимание: важности от RF — относительные; сопоставляйте с предметной логикой.</span></span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>var_importance <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> model_data, <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(var_importance, <span class="at">main =</span> <span class="st">"Важность предикторов"</span>)</span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a><span class="co"># Перед окончательным выбором модели мы проверяем значимость предикторов с помощью линейной регрессии.</span></span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Функция summary() показывает p-значения коэффициентов - если p &lt; 0.05, переменная считается статистически значимой. </span></span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a><span class="co"># Визуализация важности переменных с помощью случайного леса дает дополнительную перспективу,</span></span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a><span class="co"># показывая, какие переменные наиболее информативны для предсказания без предположений о линейности.</span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a><span class="co">#  ПОДГОТОВКА ДАННЫХ</span></span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Создаём NAOspring, фиксируем финальный набор признаков, сохраняем CSV.</span></span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------------------</span></span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a><span class="co"># Цель блока: стандартизировать набор признаков для дальнейшего сравнения</span></span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a><span class="co"># моделей и обеспечить воспроизводимость (фиксированный CSV с нужными полями).</span></span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.1 Пакеты и окружение</span></span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Примечание: блок повторяет базовую инициализацию для автономного запуска.</span></span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"pacman"</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(readxl, tidyverse, caret, corrplot)</span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"C:/RECRUITMENT/"</span>)</span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.2 Загрузка исходных данных и приведение типов</span></span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>DATA <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_excel</span>(<span class="st">"RECRUITMENT.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"RECRUITMENT"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEAR <span class="sc">&gt;</span> <span class="dv">1989</span> <span class="sc">&amp;</span> YEAR <span class="sc">&lt;</span> <span class="dv">2022</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"T"</span>), as.numeric),</span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"I"</span>), as.numeric),</span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"O"</span>), as.numeric),</span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">where</span>(is.character), <span class="sc">~</span><span class="fu">na_if</span>(., <span class="st">"NA"</span>))</span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.3 Создаём NAOspring (если есть NAO3, NAO4, NAO5)</span></span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Идея: агрегируем весенний индекс NAO как среднее за месяцы 3–5.</span></span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"NAO3"</span>,<span class="st">"NAO4"</span>,<span class="st">"NAO5"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(DATA))) {</span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>  DATA <span class="ot">&lt;-</span> DATA <span class="sc">%&gt;%</span></span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">NAOspring =</span> <span class="fu">rowMeans</span>(<span class="fu">pick</span>(NAO3, NAO4, NAO5), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>NAO3, <span class="sc">-</span>NAO4, <span class="sc">-</span>NAO5)</span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a><span class="co"># NAO (North Atlantic Oscillation) - важный климатический индекс, влияющий описывающий изменения атмосферного давления</span></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a><span class="co"># над Северной Атлантикой. В частности, он отражает разницу в атмосферном давлении между Исландской депрессией и</span></span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a><span class="co"># Азорским максимумом. NAO влияет на силу и направление западных ветров, а также на траектории штормов в Северной Атлантике. </span></span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a><span class="co"># Мы создаем NAOspring как среднее значение за весенние месяцы (марта, апреля, мая),</span></span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a><span class="co"># так как именно в этот период происходят ключевые процессы, влияющие на нерест трески. </span></span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a><span class="co"># Создание составных переменных на основе экспертных знаний часто улучшает качество моделей.</span></span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.4 Финальный учебный набор предикторов (фиксируем)</span></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a><span class="co"># Важно: проверяем присутствие нужных колонок и формируем компактный датасет.</span></span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>needed <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"codTSB"</span>, <span class="st">"T12"</span>, <span class="st">"I5"</span>, <span class="st">"NAOspring"</span>, <span class="st">"haddock68"</span>)</span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(needed <span class="sc">%in%</span> <span class="fu">names</span>(DATA)))</span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Сохраняем YEAR в CSV (ниже он будет отброшен при обучении, но нужен для графика)</span></span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> DATA <span class="sc">%&gt;%</span></span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEAR, <span class="fu">all_of</span>(needed), R3haddock) <span class="sc">%&gt;%</span></span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(model_data, <span class="st">"selected_predictors_dataset.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(model_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="модели-запас-пополнение-рикера-и-бивертона-холта" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="модели-запас-пополнение-рикера-и-бивертона-холта"><span class="header-section-number">8.3</span> Модели «запас-пополнение» Рикера и Бивертона-Холта</h2>
<p>Модели запас-пополнение представляют собой фундаментальный инструмент в оценке водных биоресурсов, которые гораздо больше, чем просто математические кривые, — это формализованные выражения фундаментальных биологических представлений о том, как численность родительского стада определяет успех следующего поколения. Среди классических моделей этого типа наиболее широко используются модель Рикера и модель Бивертона-Холта, каждая из которых отражает различные гипотезы о биологических процессах, происходящих в популяции. Модель Рикера, предложенная Уильямом Рикером в 1954 году и имеющая характерный горб на графике, выражается уравнением R = a*<em>S</em>*exp(-b*S), где <strong><em>R</em></strong> обозначает пополнение, <strong><em>S</em></strong> — нерестовый запас, а параметры <strong><em>a</em></strong> и <strong><em>b</em></strong> имеют четкую биологическую интерпретацию: <strong><em>a</em></strong> соответствует максимальной продуктивности на единицу запаса при очень низких плотностях, фактически отражая максимальное пополнение (количество рекрутов) на одного производителя, а <strong><em>b</em></strong> характеризует степень плотностной зависимости, определяющей точку, после которой начинается снижение из-за внутривидовой конкуренции. Эта модель предсказывает, что с ростом нерестового запаса пополнение сначала увеличивается, достигает максимума, а затем снижается, что отражает явление перенаселенности, когда чрезмерная плотность производителей приводит к конкуренции за ресурсы, нехватке корма для личинок, усилению каннибализма или даже эпидемиям, что в итоге снижает выход молоди — мы буквально видим, как чрезмерный успех закладывает семена будущего коллапса пополнения. В отличие от нее, модель Бивертона-Холта, разработанная в 1957 году, имеет вид R = a<em>S/(1+b</em>*S) и предполагает, что пополнение асимптотически приближается к предельному значению <strong><em>a/b</em></strong>, называемому <strong><em>Rmax</em></strong>, с увеличением нерестового запаса, без последующего снижения, что соответствует ситуации, когда основной лимитирующий фактор — это не внутривидовая конкуренция, а внешние условия: ограниченное количество нерестовых площадок, хищничество, которое не зависит от плотности, или просто конечная пропускная способность экосистемы для молоди. Эта модель идеально описывает сценарий, когда кривая плавно выходит на плато, символизируя насыщение, и представляет собой альтернативную логику, где главным ограничивающим фактором являются внешние, а не внутривидовые процессы.</p>
<p>При оценке параметров этих нелинейных моделей мы сталкиваемся с необходимостью применения специализированных методов, поскольку обычный метод наименьших квадратов не справляется с их сложной структурой; в нашем анализе мы используем улучшенный алгоритм nlsLM из пакета minpack.lm, который сочетает метод Левенберга-Марквардта с возможностью наложения ограничений на параметры, что важно для обеспечения биологической правдоподобности результатов, так как параметры <strong><em>a</em></strong> и <strong><em>b</em></strong> должны оставаться положительными. Для получения надежных начальных оценок параметров в модели Рикера мы применяем функцию srStarts из пакета FSA, которая автоматически определяет разумные стартовые значения на основе анализа данных, тогда как для модели Бивертона-Холта мы используем комбинацию автоматических и ручных подходов, оценивая a как среднее отношение <strong><em>R/S</em></strong> при низких значениях запаса и устанавливая разумные начальные значения для <strong><em>b</em></strong> с последующей защитой от некорректных значений. Однако подбор модели — это только полдела, и критически важно провести тщательную диагностику, поскольку самая большая ошибка — слепо применять эти модели, не задумываясь об их предпосылках. Мы строим график остатков, потому что любая закономерность в их распределении — это сигнал о том, что модель не уловила какой-то важный процесс в данных. Мы смотрим на доверительные интервалы параметров; если они невероятно широки, значит, наша модель перепараметризована для имеющихся данных, и её прогностическая сила будет сомнительной. Модель Рикера не будет работать, если в вашей системе нет механизма перенаселения, а модель Бивертона-Холта окажется бесполезной, если пополнение продолжает расти или, наоборот, обрушивается после достижения пика. Именно поэтому мы всегда начинаем с простого графика «запас-пополнение» — его форма сама подскажет, какая из концепций более адекватна для конкретной популяции.</p>
<p>Но реальный мир часто бывает сложнее этих двух идеализированных сценариев. Что если система ведёт себя по-рикеровски при высокой численности, но при низкой — работает иначе? Здесь на помощь приходит модификация — модель Рикера с порогом, или hockey-stick модель, которая сочетает в себе линейный рост при малых запасах и плато или спад при высоких, что может быть биологически более оправдано для многих запасов, находящихся под прессом промысла. И здесь мы подходим к самому главному — интеграции классики и современности. Эти модели не являются застывшими реликтами, а служат мощным инструментом для создания гипотез. Если модель Рикера плохо описывает данные, особенно в области низких значений запаса, это прямой сигнал о том, что возможно, существует какой-то дополнительный лимитирующий фактор, не учтенный в модели. Возможно, это температура воды на ключевой стадии развития икры, наличие хищников или доступность корма. Таким образом, классические модели становятся трамплином для более сложного анализа, включающего средовые предикторы. Мы можем включить параметры модели Рикера в качестве фиксированных эффектов в GAM или использовать предсказания классической модели в качестве одного из входных признаков для Random Forest. Этот синтез позволяет нам сохранить биологическую интерпретируемость классических моделей и добавить к ним гибкость и прогностическую силу машинного обучения для учета сложных, нелинейных влияний окружающей среды. В сущности, мы строим мост между глубоким, но узким знанием, заключенным в одной кривой, и широким, но зачастую “черно-ящичным” прогнозом сложного алгоритма, пытаясь получить лучшее из двух миров. Среди распространенных подводных камней при работе с моделями запас-пополнение следует отметить высокую чувствительность к начальным значениям параметров, что может приводить к сходимости к локальным минимумам, необходимость учета неоднородности дисперсии ошибок, особенно при работе с данными, охватывающими широкий диапазон значений запаса, и влияние временных лагов, поскольку пополнение в текущем году может зависеть не только от нерестового запаса в том же году, но и от условий прошлых лет. Кроме того, чистые модели запас-пополнение часто оказываются недостаточными для точного прогнозирования, так как пополнение зависит не только от размера нерестового запаса, но и от множества экологических факторов, что делает целесообразным развитие этих моделей в направлении включения дополнительных предикторов, как это продемонстрировано в последующих разделах нашего анализа. Тем не менее, классические модели Рикера и Бивертона-Холта остаются важной отправной точкой в анализе динамики рыбных популяций, предоставляя интерпретируемую основу для понимания механизмов регулирования численности и служа эталоном для оценки добавленной ценности более сложных моделей, что особенно важно в условиях ограниченных данных, характерных для многих водных экосистем.</p>
<div class="cell" data-code-line-count="true" data-code-max-lines="5">
<details class="code-fold">
<summary>Показать скрипт</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ПРАКТИЧЕСКОЕ ЗАНЯТИЕ: АНАЛИЗ ФАКТОРОВ, ВЛИЯЮЩИХ НА ПОПОЛНЕНИЕ </span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># (КЛАССИЧЕСКИЕ МОДЕЛИ ЗАПАС-ПОПОЛНЕНИЕ)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Курс: "Оценка водных биоресурсов в среде R (для начинающих)"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Установка и подключение ТОЛЬКО необходимых библиотек</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"pacman"</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  tidyverse,    <span class="co"># Манипуляции с данными и визуализация</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  FSA,          <span class="co"># Начальные оценки для моделей запас-пополнение</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  minpack.lm,   <span class="co"># Улучшенный алгоритм нелинейной регрессии (nlsLM)</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  car,          <span class="co"># Проверка допущений моделей</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  mgcv,         <span class="co"># Построение GAM-моделей</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  investr,      <span class="co"># Доверительные интервалы для нелинейных моделей</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>   caret)       <span class="co"># Расчет RMSE</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Очистка среды и установка рабочей директории</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"C:/RECRUITMENT/"</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. ЗАГРУЗКА ДАННЫХ -----------------------------------------------------------</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"selected_predictors_dataset.csv"</span>, </span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                      <span class="at">header =</span> <span class="cn">TRUE</span>, </span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                      <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Проверка структуры данных</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(model_data)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Проверка на пропущенные значения (должно быть 0 после предобработки)</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(model_data))</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. ПОДГОТОВКА ДАННЫХ ДЛЯ МОДЕЛЕЙ ЗАПАС-ПОПОЛНЕНИЕ ----------------------------</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>rec_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">S =</span> model_data<span class="sc">$</span>haddock68,  <span class="co"># Нерестовый запас</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> model_data<span class="sc">$</span>R3haddock   <span class="co"># Пополнение</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. ПОДГОНКА МОДЕЛИ РИКЕРА ----------------------------------------------------</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>ricker_starts <span class="ot">&lt;-</span> FSA<span class="sc">::</span><span class="fu">srStarts</span>(R <span class="sc">~</span> S, <span class="at">data =</span> rec_data, <span class="at">type =</span> <span class="st">"Ricker"</span>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>ricker_model <span class="ot">&lt;-</span> minpack.lm<span class="sc">::</span><span class="fu">nlsLM</span>(</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  R <span class="sc">~</span> a <span class="sc">*</span> S <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>b <span class="sc">*</span> S),</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> rec_data,</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">start =</span> ricker_starts,</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">c</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">0</span>)</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. ПОДГОНКА МОДЕЛИ БИВЕРТОНА-ХОЛТА -------------------------------------------</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>a_start <span class="ot">&lt;-</span> <span class="fu">mean</span>(rec_data<span class="sc">$</span>R[rec_data<span class="sc">$</span>S <span class="sc">&lt;</span> <span class="fu">quantile</span>(rec_data<span class="sc">$</span>S, <span class="fl">0.25</span>)] <span class="sc">/</span> </span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>                rec_data<span class="sc">$</span>S[rec_data<span class="sc">$</span>S <span class="sc">&lt;</span> <span class="fu">quantile</span>(rec_data<span class="sc">$</span>S, <span class="fl">0.25</span>)], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.na</span>(a_start) <span class="sc">||</span> a_start <span class="sc">&lt;=</span> <span class="dv">0</span>) a_start <span class="ot">&lt;-</span> <span class="fl">0.001</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>bh_model <span class="ot">&lt;-</span> minpack.lm<span class="sc">::</span><span class="fu">nlsLM</span>(</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  R <span class="sc">~</span> (a <span class="sc">*</span> S) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> b <span class="sc">*</span> S),</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> rec_data,</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">start =</span> <span class="fu">list</span>(<span class="at">a =</span> a_start, <span class="at">b =</span> <span class="fl">0.0001</span>),</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">c</span>(<span class="at">a =</span> <span class="fl">0.0001</span>, <span class="at">b =</span> <span class="fl">0.00001</span>),</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">nls.lm.control</span>(<span class="at">maxiter =</span> <span class="dv">200</span>)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. ОЦЕНКА КАЧЕСТВА МОДЕЛЕЙ ---------------------------------------------------</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>calculate_R2 <span class="ot">&lt;-</span> <span class="cf">function</span>(model, data) {</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>  predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> data)</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>  residuals <span class="ot">&lt;-</span> data<span class="sc">$</span>R <span class="sc">-</span> predicted</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>  SSE <span class="ot">&lt;-</span> <span class="fu">sum</span>(residuals<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>  SST <span class="ot">&lt;-</span> <span class="fu">sum</span>((data<span class="sc">$</span>R <span class="sc">-</span> <span class="fu">mean</span>(data<span class="sc">$</span>R))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>  R2 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> (SSE <span class="sc">/</span> SST)</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data)</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">coef</span>(model))</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>  adj_R2 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> ((n <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> (n <span class="sc">-</span> p <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> R2)</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">R2 =</span> R2, <span class="at">adj_R2 =</span> adj_R2))</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>calculate_pvalue <span class="ot">&lt;-</span> <span class="cf">function</span>(model, data) {</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>  predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> data)</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>  residuals <span class="ot">&lt;-</span> data<span class="sc">$</span>R <span class="sc">-</span> predicted</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>  SSE <span class="ot">&lt;-</span> <span class="fu">sum</span>(residuals<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>  SST <span class="ot">&lt;-</span> <span class="fu">sum</span>((data<span class="sc">$</span>R <span class="sc">-</span> <span class="fu">mean</span>(data<span class="sc">$</span>R))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>  SSR <span class="ot">&lt;-</span> SST <span class="sc">-</span> SSE</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data)</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">coef</span>(model))</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>  F_stat <span class="ot">&lt;-</span> (SSR <span class="sc">/</span> (p <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">/</span> (SSE <span class="sc">/</span> (n <span class="sc">-</span> p))</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">&lt;-</span> <span class="fu">pf</span>(F_stat, <span class="at">df1 =</span> p <span class="sc">-</span> <span class="dv">1</span>, <span class="at">df2 =</span> n <span class="sc">-</span> p, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p_value)</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>ricker_r2 <span class="ot">&lt;-</span> <span class="fu">calculate_R2</span>(ricker_model, rec_data)</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>bh_r2 <span class="ot">&lt;-</span> <span class="fu">calculate_R2</span>(bh_model, rec_data)</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>ricker_p <span class="ot">&lt;-</span> <span class="fu">calculate_pvalue</span>(ricker_model, rec_data)</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>bh_p <span class="ot">&lt;-</span> <span class="fu">calculate_pvalue</span>(bh_model, rec_data)</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIC Рикера:"</span>, <span class="fu">AIC</span>(ricker_model), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIC Бивертона-Холта:"</span>, <span class="fu">AIC</span>(bh_model), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. ВИЗУАЛИЗАЦИЯ РЕЗУЛЬТАТОВ --------------------------------------------------</span></span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>new_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">S =</span> <span class="fu">seq</span>(<span class="fu">min</span>(rec_data<span class="sc">$</span>S), <span class="fu">max</span>(rec_data<span class="sc">$</span>S), <span class="at">length.out =</span> <span class="dv">100</span>))</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>ricker_ci <span class="ot">&lt;-</span> investr<span class="sc">::</span><span class="fu">predFit</span>(ricker_model, <span class="at">newdata =</span> new_data, <span class="at">interval =</span> <span class="st">"confidence"</span>)</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>bh_ci <span class="ot">&lt;-</span> investr<span class="sc">::</span><span class="fu">predFit</span>(bh_model, <span class="at">newdata =</span> new_data, <span class="at">interval =</span> <span class="st">"confidence"</span>)</span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> new_data <span class="sc">%&gt;%</span></span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">ricker_pred =</span> <span class="fu">predict</span>(ricker_model, <span class="at">newdata =</span> .),</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">ricker_lwr =</span> ricker_ci[, <span class="st">"lwr"</span>],</span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">ricker_upr =</span> ricker_ci[, <span class="st">"upr"</span>],</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">bh_pred =</span> <span class="fu">predict</span>(bh_model, <span class="at">newdata =</span> .),</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">bh_lwr =</span> bh_ci[, <span class="st">"lwr"</span>],</span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">bh_upr =</span> bh_ci[, <span class="st">"upr"</span>]</span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> rec_data, <span class="fu">aes</span>(<span class="at">x =</span> S, <span class="at">y =</span> R), </span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"darkgray"</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> plot_data, <span class="fu">aes</span>(<span class="at">x =</span> S, <span class="at">ymin =</span> ricker_lwr, <span class="at">ymax =</span> ricker_upr), </span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> plot_data, <span class="fu">aes</span>(<span class="at">x =</span> S, <span class="at">ymin =</span> bh_lwr, <span class="at">ymax =</span> bh_upr), </span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> plot_data, <span class="fu">aes</span>(<span class="at">x =</span> S, <span class="at">y =</span> ricker_pred), </span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> plot_data, <span class="fu">aes</span>(<span class="at">x =</span> S, <span class="at">y =</span> bh_pred), </span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Сравнение моделей запас-пополнение"</span>,</span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Рикер: R² = "</span>, <span class="fu">round</span>(ricker_r2<span class="sc">$</span>R2, <span class="dv">2</span>), <span class="st">", p = "</span>, <span class="fu">format.pval</span>(ricker_p, <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>      <span class="st">" | Бивертон-Холт: R² = "</span>, <span class="fu">round</span>(bh_r2<span class="sc">$</span>R2, <span class="dv">2</span>), <span class="st">", p = "</span>, <span class="fu">format.pval</span>(bh_p, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Нерестовый запас"</span>,</span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Пополнение"</span></span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span></span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. СРАВНЕНИЕ С ДРУГИМИ ТИПАМИ МОДЕЛЕЙ ----------------------------------------</span></span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>lm_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> model_data)</span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>glm_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(R3haddock <span class="sc">~</span> ., <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">data =</span> model_data)</span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>gam_model <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(R3haddock <span class="sc">~</span> <span class="fu">s</span>(haddock68) <span class="sc">+</span> <span class="fu">s</span>(codTSB) <span class="sc">+</span> <span class="fu">s</span>(T12) <span class="sc">+</span> <span class="fu">s</span>(I5) <span class="sc">+</span> <span class="fu">s</span>(NAOspring),</span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> model_data, <span class="at">method =</span> <span class="st">"REML"</span>)</span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>model_comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"Рикер"</span>, <span class="st">"Бивертон-Холт"</span>, <span class="st">"LM"</span>, <span class="st">"GLM"</span>, <span class="st">"GAM"</span>),</span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a>  <span class="at">AIC =</span> <span class="fu">c</span>(<span class="fu">AIC</span>(ricker_model), <span class="fu">AIC</span>(bh_model), <span class="fu">AIC</span>(lm_model), <span class="fu">AIC</span>(glm_model), <span class="fu">AIC</span>(gam_model)),</span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>  <span class="at">R2 =</span> <span class="fu">c</span>(</span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>    ricker_r2<span class="sc">$</span>R2, </span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>    bh_r2<span class="sc">$</span>R2, </span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(lm_model)<span class="sc">$</span>r.squared,</span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cor</span>(model_data<span class="sc">$</span>R3haddock, <span class="fu">predict</span>(glm_model, <span class="at">type =</span> <span class="st">"response"</span>))<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(gam_model)<span class="sc">$</span>r.sq</span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_comparison)</span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. ИНТЕРПРЕТАЦИЯ РЕЗУЛЬТАТОВ -------------------------------------------------</span></span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Параметры модели Рикера:"</span>)</span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">a ="</span>, <span class="fu">coef</span>(ricker_model)[<span class="dv">1</span>], <span class="st">"- максимальная продукция потомства"</span>)</span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">b ="</span>, <span class="fu">coef</span>(ricker_model)[<span class="dv">2</span>], <span class="st">"- коэффициент плотностной зависимости"</span>)</span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">Параметры модели Бивертона-Холта:"</span>)</span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">a ="</span>, <span class="fu">coef</span>(bh_model)[<span class="dv">1</span>], <span class="st">"- максимальное пополнение на особь"</span>)</span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">b ="</span>, <span class="fu">coef</span>(bh_model)[<span class="dv">2</span>], <span class="st">"- коэффициент внутривидовой конкуренции"</span>)</span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. СРАВНЕНИЕ С ДРУГИМИ ТИПАМИ МОДЕЛЕЙ ----------------------------------------</span></span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a><span class="co"># Построение линейной модели LM</span></span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a>lm_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> model_data)</span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a><span class="co"># Диагностика</span></span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lm_model)</span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(lm_model)  <span class="co"># Проверка мультиколлинеарности</span></span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a><span class="co"># Интерпретация</span></span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm_model)</span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a><span class="co"># Построение обобщенной линейной модели GLM</span></span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a>glm_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(R3haddock <span class="sc">~</span> ., </span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>), </span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> model_data)</span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(glm_model)</span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a><span class="co"># Построение обобщенной аддитивной модели GАM</span></span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>gam_model <span class="ot">&lt;-</span> <span class="fu">gam</span>(R3haddock <span class="sc">~</span> </span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">s</span>(codTSB) <span class="sc">+</span> </span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">s</span>(T12) <span class="sc">+</span> </span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">s</span>(I5) <span class="sc">+</span> </span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">s</span>(NAOspring) <span class="sc">+</span> </span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">s</span>(haddock68),</span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> model_data,</span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">"REML"</span>)</span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gam_model)</span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gam_model, <span class="at">pages =</span> <span class="dv">1</span>, <span class="at">residuals =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a><span class="co"># Таблица сравнения моделей</span></span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a><span class="co"># Сравнение моделей</span></span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a>model_comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"Рикер"</span>, <span class="st">"Бивертон-Холт"</span>, <span class="st">"LM"</span>, <span class="st">"GLM"</span>, <span class="st">"GAM"</span>),</span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a>  <span class="at">AIC =</span> <span class="fu">c</span>(<span class="fu">AIC</span>(ricker_model), <span class="fu">AIC</span>(bh_model), <span class="fu">AIC</span>(lm_model), <span class="fu">AIC</span>(glm_model), <span class="fu">AIC</span>(gam_model)),</span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a>  <span class="at">R2 =</span> <span class="fu">c</span>(ricker_r2<span class="sc">$</span>R2, bh_r2<span class="sc">$</span>R2, <span class="fu">summary</span>(lm_model)<span class="sc">$</span>r.squared, </span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a>         <span class="fu">cor</span>(model_data<span class="sc">$</span>R3haddock, <span class="fu">predict</span>(glm_model))<span class="sc">^</span><span class="dv">2</span>, </span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a>         <span class="fu">summary</span>(gam_model)<span class="sc">$</span>r.sq),  <span class="co"># Используем summary(gam_model)$r.sq для R^2</span></span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a>  <span class="at">Adj_R2 =</span> <span class="fu">c</span>(ricker_r2<span class="sc">$</span>adj_R2, bh_r2<span class="sc">$</span>adj_R2, <span class="fu">summary</span>(lm_model)<span class="sc">$</span>adj.r.squared, <span class="cn">NA</span>, </span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a>             <span class="fu">summary</span>(gam_model)<span class="sc">$</span>r.sq),  <span class="co"># Используем summary(gam_model)$r.sq для Adjusted R^2</span></span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">c</span>(<span class="fu">RMSE</span>(<span class="fu">predict</span>(ricker_model), rec_data<span class="sc">$</span>R), </span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a>           <span class="fu">RMSE</span>(<span class="fu">predict</span>(bh_model), rec_data<span class="sc">$</span>R),</span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>           <span class="fu">RMSE</span>(<span class="fu">predict</span>(lm_model), model_data<span class="sc">$</span>R3haddock),</span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a>           <span class="fu">RMSE</span>(<span class="fu">predict</span>(glm_model, <span class="at">type =</span> <span class="st">"response"</span>), model_data<span class="sc">$</span>R3haddock),</span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a>           <span class="fu">RMSE</span>(<span class="fu">predict</span>(gam_model, <span class="at">type =</span> <span class="st">"response"</span>), model_data<span class="sc">$</span>R3haddock))</span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a><span class="co"># Вывод таблицы</span></span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_comparison)</span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a><span class="co"># ВИЗУАЛИЗАЦИЯ ВСЕХ МОДЕЛЕЙ НА ОДНОМ ГРАФИКЕ </span></span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a><span class="co"># Фиксируем другие предикторы на их средних значениях (исключая haddock68)</span></span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a>mean_values <span class="ot">&lt;-</span> model_data <span class="sc">%&gt;%</span></span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>R3haddock, <span class="sc">-</span>haddock68) <span class="sc">%&gt;%</span></span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a><span class="co"># Расширяем new_data, добавляя средние значения других предикторов</span></span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a>new_data_full <span class="ot">&lt;-</span> new_data <span class="sc">%&gt;%</span></span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(mean_values[<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(new_data)), ]) <span class="sc">%&gt;%</span></span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">haddock68 =</span> S)  <span class="co"># Переименовываем S в haddock68 для совместимости</span></span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a><span class="co"># Получаем предсказания для всех моделей</span></span>
<span id="cb2-248"><a href="#cb2-248" aria-hidden="true" tabindex="-1"></a>new_data_full <span class="ot">&lt;-</span> new_data_full <span class="sc">%&gt;%</span></span>
<span id="cb2-249"><a href="#cb2-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-250"><a href="#cb2-250" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Предсказания для моделей запаса-пополнения</span></span>
<span id="cb2-251"><a href="#cb2-251" aria-hidden="true" tabindex="-1"></a>    <span class="at">ricker_pred =</span> <span class="fu">predict</span>(ricker_model, <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">S =</span> haddock68)),</span>
<span id="cb2-252"><a href="#cb2-252" aria-hidden="true" tabindex="-1"></a>    <span class="at">bh_pred =</span> <span class="fu">predict</span>(bh_model, <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">S =</span> haddock68)),</span>
<span id="cb2-253"><a href="#cb2-253" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-254"><a href="#cb2-254" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Предсказания для линейной модели (LM)</span></span>
<span id="cb2-255"><a href="#cb2-255" aria-hidden="true" tabindex="-1"></a>    <span class="at">lm_pred =</span> <span class="fu">predict</span>(lm_model, <span class="at">newdata =</span> .),</span>
<span id="cb2-256"><a href="#cb2-256" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-257"><a href="#cb2-257" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Предсказания для обобщенной линейной модели (GLM)</span></span>
<span id="cb2-258"><a href="#cb2-258" aria-hidden="true" tabindex="-1"></a>    <span class="at">glm_pred =</span> <span class="fu">predict</span>(glm_model, <span class="at">newdata =</span> ., <span class="at">type =</span> <span class="st">"response"</span>),</span>
<span id="cb2-259"><a href="#cb2-259" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-260"><a href="#cb2-260" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Предсказания для обобщенной аддитивной модели (GAM)</span></span>
<span id="cb2-261"><a href="#cb2-261" aria-hidden="true" tabindex="-1"></a>    <span class="at">gam_pred =</span> <span class="fu">predict</span>(gam_model, <span class="at">newdata =</span> ., <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb2-262"><a href="#cb2-262" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-263"><a href="#cb2-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-264"><a href="#cb2-264" aria-hidden="true" tabindex="-1"></a><span class="co"># Создаем длинный формат данных для ggplot</span></span>
<span id="cb2-265"><a href="#cb2-265" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> new_data_full <span class="sc">%&gt;%</span></span>
<span id="cb2-266"><a href="#cb2-266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(haddock68, ricker_pred, bh_pred, lm_pred, glm_pred, gam_pred) <span class="sc">%&gt;%</span></span>
<span id="cb2-267"><a href="#cb2-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb2-268"><a href="#cb2-268" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span>haddock68,</span>
<span id="cb2-269"><a href="#cb2-269" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"model"</span>,</span>
<span id="cb2-270"><a href="#cb2-270" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"prediction"</span></span>
<span id="cb2-271"><a href="#cb2-271" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb2-272"><a href="#cb2-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-273"><a href="#cb2-273" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="fu">case_when</span>(</span>
<span id="cb2-274"><a href="#cb2-274" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"ricker_pred"</span> <span class="sc">~</span> <span class="st">"Рикер"</span>,</span>
<span id="cb2-275"><a href="#cb2-275" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"bh_pred"</span> <span class="sc">~</span> <span class="st">"Бивертон-Холт"</span>,</span>
<span id="cb2-276"><a href="#cb2-276" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"lm_pred"</span> <span class="sc">~</span> <span class="st">"Линейная (LM)"</span>,</span>
<span id="cb2-277"><a href="#cb2-277" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"glm_pred"</span> <span class="sc">~</span> <span class="st">"Обобщенная линейная (GLM)"</span>,</span>
<span id="cb2-278"><a href="#cb2-278" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"gam_pred"</span> <span class="sc">~</span> <span class="st">"Обобщенная аддитивная (GAM)"</span>,</span>
<span id="cb2-279"><a href="#cb2-279" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> model</span>
<span id="cb2-280"><a href="#cb2-280" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-281"><a href="#cb2-281" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-282"><a href="#cb2-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-283"><a href="#cb2-283" aria-hidden="true" tabindex="-1"></a><span class="co"># Создаем палитру цветов для моделей</span></span>
<span id="cb2-284"><a href="#cb2-284" aria-hidden="true" tabindex="-1"></a>model_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-285"><a href="#cb2-285" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Рикер"</span> <span class="ot">=</span> <span class="st">"#E41A1C"</span>,          <span class="co"># Красный</span></span>
<span id="cb2-286"><a href="#cb2-286" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Бивертон-Холт"</span> <span class="ot">=</span> <span class="st">"#377EB8"</span>,  <span class="co"># Синий</span></span>
<span id="cb2-287"><a href="#cb2-287" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Линейная (LM)"</span> <span class="ot">=</span> <span class="st">"#4DAF4A"</span>,  <span class="co"># Зеленый</span></span>
<span id="cb2-288"><a href="#cb2-288" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Обобщенная линейная (GLM)"</span> <span class="ot">=</span> <span class="st">"#984EA3"</span>, <span class="co"># Фиолетовый</span></span>
<span id="cb2-289"><a href="#cb2-289" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Обобщенная аддитивная (GAM)"</span> <span class="ot">=</span> <span class="st">"#FF7F00"</span> <span class="co"># Оранжевый</span></span>
<span id="cb2-290"><a href="#cb2-290" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-291"><a href="#cb2-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-292"><a href="#cb2-292" aria-hidden="true" tabindex="-1"></a><span class="co"># Создаем график</span></span>
<span id="cb2-293"><a href="#cb2-293" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb2-294"><a href="#cb2-294" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Точки исходных данных</span></span>
<span id="cb2-295"><a href="#cb2-295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> rec_data, <span class="fu">aes</span>(<span class="at">x =</span> S, <span class="at">y =</span> R), </span>
<span id="cb2-296"><a href="#cb2-296" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"darkgray"</span>, <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb2-297"><a href="#cb2-297" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-298"><a href="#cb2-298" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Линии предсказаний моделей</span></span>
<span id="cb2-299"><a href="#cb2-299" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> plot_data, </span>
<span id="cb2-300"><a href="#cb2-300" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> haddock68, <span class="at">y =</span> prediction, <span class="at">color =</span> model, <span class="at">linetype =</span> model),</span>
<span id="cb2-301"><a href="#cb2-301" aria-hidden="true" tabindex="-1"></a>            <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb2-302"><a href="#cb2-302" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-303"><a href="#cb2-303" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Настройка цветов и типов линий</span></span>
<span id="cb2-304"><a href="#cb2-304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> model_colors) <span class="sc">+</span></span>
<span id="cb2-305"><a href="#cb2-305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb2-306"><a href="#cb2-306" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Рикер"</span> <span class="ot">=</span> <span class="st">"solid"</span>,</span>
<span id="cb2-307"><a href="#cb2-307" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Бивертон-Холт"</span> <span class="ot">=</span> <span class="st">"dashed"</span>,</span>
<span id="cb2-308"><a href="#cb2-308" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Линейная (LM)"</span> <span class="ot">=</span> <span class="st">"dotdash"</span>,</span>
<span id="cb2-309"><a href="#cb2-309" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Обобщенная линейная (GLM)"</span> <span class="ot">=</span> <span class="st">"longdash"</span>,</span>
<span id="cb2-310"><a href="#cb2-310" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Обобщенная аддитивная (GAM)"</span> <span class="ot">=</span> <span class="st">"twodash"</span></span>
<span id="cb2-311"><a href="#cb2-311" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb2-312"><a href="#cb2-312" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-313"><a href="#cb2-313" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Подписи и темы</span></span>
<span id="cb2-314"><a href="#cb2-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-315"><a href="#cb2-315" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Сравнение моделей зависимости пополнения от нерестового запаса"</span>,</span>
<span id="cb2-316"><a href="#cb2-316" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Фиксация других предикторов на средних значениях"</span>,</span>
<span id="cb2-317"><a href="#cb2-317" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Нерестовый запас (тыс. тонн)"</span>,</span>
<span id="cb2-318"><a href="#cb2-318" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Пополнение (млн особей)"</span>,</span>
<span id="cb2-319"><a href="#cb2-319" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Модель"</span>,</span>
<span id="cb2-320"><a href="#cb2-320" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">"Модель"</span></span>
<span id="cb2-321"><a href="#cb2-321" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-322"><a href="#cb2-322" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb2-323"><a href="#cb2-323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb2-324"><a href="#cb2-324" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">16</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb2-325"><a href="#cb2-325" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"gray30"</span>),</span>
<span id="cb2-326"><a href="#cb2-326" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb2-327"><a href="#cb2-327" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb2-328"><a href="#cb2-328" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.box =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb2-329"><a href="#cb2-329" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb2-330"><a href="#cb2-330" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-331"><a href="#cb2-331" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">color =</span> <span class="st">"gray80"</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>)</span>
<span id="cb2-332"><a href="#cb2-332" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-333"><a href="#cb2-333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb2-334"><a href="#cb2-334" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>),</span>
<span id="cb2-335"><a href="#cb2-335" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-336"><a href="#cb2-336" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="статистические-модели-lmglmgam" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="статистические-модели-lmglmgam"><span class="header-section-number">8.4</span> Статистические модели LM/GLM/GAM</h2>
<p>Статистические модели линейной регрессии (LM), обобщенной линейной регрессии (GLM) и обобщенной аддитивной регрессии (GAM) представляют собой мощный и взаимодополняющий набор инструментов для анализа водных биоресурсов, позволяющий исследователям от простых линейных зависимостей переходить к сложным нелинейным взаимодействиям, сохраняя при этом интерпретируемость результатов. Линейная модель (LM) служит фундаментом для всего статистического анализа в гидробиологии, основываясь на предположении, что зависимость между предикторами и откликом является линейной, а остатки распределены нормально с постоянной дисперсией. Эта модель предоставляет простую интерпретацию коэффициентов как величины изменения отклика при единичном изменении предиктора, что особенно ценно при работе с такими биологическими показателями, как пополнение запаса или нерестовая биомасса. Однако при анализе водных биоресурсов мы часто сталкиваемся с данными, которые нарушают ключевые предположения LM: пополнение рыбы или беспозвоночного не может быть отрицательным, его распределение обычно сильно скошено вправо, а дисперсия часто увеличивается с ростом среднего значения. Именно здесь на помощь приходит обобщенная линейная модель (GLM), расширяющая возможности LM за счет введения двух ключевых компонентов — экспоненциального семейства распределений и связующей функции (link-function). Для данных о рыбных запасах особенно полезно Gamma-распределение с логарифмической связкой, которое учитывает положительность отклика и мультипликативную природу ошибок, характерную для биологических данных. В отличие от LM, где мы интерпретируем коэффициенты как абсолютные изменения, в GLM с лог-связкой коэффициенты отражают относительные изменения: увеличение предиктора на единицу приводит к умножению ожидаемого отклика на exp(коэффициент), что соответствует биологической реальности, где эффекты часто действуют мультипликативно, а не аддитивно. Но даже GLM сохраняет ограничение на линейность в преобразованном пространстве, что может быть недостаточным для описания сложных экологических зависимостей, таких как оптимальный диапазон температуры для нереста или пороговые эффекты средовых факторов. Здесь в игру вступают обобщенные аддитивные модели (GAM), которые заменяют линейные комбинации предикторов на гладкие функции, оцениваемые с помощью сплайнов, что позволяет моделировать практически любые нелинейные зависимости без предварительного задания их формы. GAM сохраняет интерпретируемость линейных моделей, так как каждая гладкая функция может быть визуализирована и проанализирована отдельно, показывая, как именно каждый фактор влияет на пополнение запаса, будь то монотонный рост, оптимум с максимумом или сложная колебательная зависимость. При работе с GAM особое внимание уделяется выбору степени гладкости, так как чрезмерно гибкие функции могут переобучиться на шум в данных, тогда как недостаточно гибкие не уловят реальные биологические закономерности; в пакете mgcv это решается автоматически через метод максимального правдоподобия с штрафом (REML), который балансирует качество подгонки и гладкость функций. Сравнивая эти модели с классическими моделями запас-пополнение, мы видим, что GAM может рассматриваться как их естественное обобщение: вместо фиксированной формы кривой Рикера или Бивертона-Холта GAM позволяет данным “говорить за себя”, выявляя оптимальную форму зависимости без предварительных гипотез, при этом сохраняя возможность включить нерестовый запас как один из гладких членов в модель, дополненный другими экологическими факторами. Однако при всей своей гибкости, GAM, как и LM с GLM, требует тщательной проверки предположений: мы анализируем графики остатков против предсказанных значений, чтобы убедиться в отсутствии систематических отклонений, проверяем нормальность остатков (для LM) или соответствие выбранному распределению (для GLM/GAM), и исследуем влияние влиятельных точек, которые могут исказить результаты, особенно в условиях ограниченных данных, характерных для гидробиологических исследований. Выбор между LM, GLM и GAM должен основываться не только на статистических критериях, таких как AIC или кросс-валидация, но и на биологической интерпретируемости результатов: иногда более простая модель с меньшей точностью предпочтительнее сложного “черного ящика”, особенно когда результаты должны быть понятны начальникам и менеджерам рыболовства. Практический подход, который обычно рекомендуется начинающим ихтиологам/гидробиологам, состоит в последовательном усложнении модели: начните с классической модели запас-пополнение, затем добавьте средовые факторы через LM/GLM, и только если зависимости явно нелинейны, перейдите к GAM, всегда проверяя, действительно ли усложнение модели приводит к биологически значимому улучшению понимания процесса. Важно помнить, что статистическая модель — это не самоцель, а инструмент для понимания биологических процессов, и даже самая изощренная модель бесполезна, если её результаты нельзя перевести на язык биологии и применить для устойчивого управления водными ресурсами. В конечном счете, сочетание классических представлений об экосистемах с современными статистическими методами позволяет нам строить мост между фундаментальной биологией и прикладной оценкой запасов, где каждая модель, от простой линейной регрессии до сложного GAM, вносит свой вклад в формирование целостного понимания динамики водных биоресурсов.</p>
<div class="cell" data-code-line-count="true" data-code-max-lines="5">
<details class="code-fold">
<summary>Показать скрипт</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Урезанная версия: только LM / GLM(Gamma) / GAM</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Без caret/train: стандартная оценка параметров lm/glm/gam, собственная time-slice CV,</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># выбор лучшей модели, прогноз 2022–2024, эмпирические интервалы и график.</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Пакеты и окружение --------------------------------------------------------</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"pacman"</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  readxl, tidyverse, mgcv, lmtest, car, ggplot2, corrplot</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"C:/RECRUITMENT/"</span>)  <span class="co"># при необходимости измените путь</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Подготовка данных ---------------------------------------------------------</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Загрузка, приведение типов, создание NAOspring, фиксируем набор признаков</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>DATA <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_excel</span>(<span class="st">"RECRUITMENT.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"RECRUITMENT"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEAR <span class="sc">&gt;</span> <span class="dv">1989</span> <span class="sc">&amp;</span> YEAR <span class="sc">&lt;</span> <span class="dv">2022</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"T"</span>), as.numeric),</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"I"</span>), as.numeric),</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"O"</span>), as.numeric),</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">where</span>(is.character), <span class="sc">~</span><span class="fu">na_if</span>(., <span class="st">"NA"</span>))</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"NAO3"</span>,<span class="st">"NAO4"</span>,<span class="st">"NAO5"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(DATA))) {</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  DATA <span class="ot">&lt;-</span> DATA <span class="sc">%&gt;%</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">NAOspring =</span> <span class="fu">rowMeans</span>(<span class="fu">pick</span>(NAO3, NAO4, NAO5), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>NAO3, <span class="sc">-</span>NAO4, <span class="sc">-</span>NAO5)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>needed <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"codTSB"</span>, <span class="st">"T12"</span>, <span class="st">"I5"</span>, <span class="st">"NAOspring"</span>, <span class="st">"haddock68"</span>)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(needed <span class="sc">%in%</span> <span class="fu">names</span>(DATA)))</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> DATA <span class="sc">%&gt;%</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEAR, <span class="fu">all_of</span>(needed), R3haddock) <span class="sc">%&gt;%</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(YEAR)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(model_data, <span class="st">"selected_predictors_dataset.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(model_data)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Формулы моделей и вспомогательные функции --------------------------------</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>f_lm  <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="st">"R3haddock ~ codTSB + T12 + I5 + NAOspring + haddock68"</span>)</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>f_gam <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="st">"R3haddock ~ s(codTSB,bs='tp',k=5) + s(T12,bs='tp',k=5) + s(I5,bs='tp',k=5) + s(NAOspring,bs='tp',k=5) + s(haddock68,bs='tp',k=5)"</span>)</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>rmse <span class="ot">&lt;-</span> <span class="cf">function</span>(a, p) <span class="fu">sqrt</span>(<span class="fu">mean</span>((a <span class="sc">-</span> p)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>mae  <span class="ot">&lt;-</span> <span class="cf">function</span>(a, p) <span class="fu">mean</span>(<span class="fu">abs</span>(a <span class="sc">-</span> p), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>r2   <span class="ot">&lt;-</span> <span class="cf">function</span>(a, p) <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>((a <span class="sc">-</span> p)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sum</span>((a <span class="sc">-</span> <span class="fu">mean</span>(a))<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>safe_fit <span class="ot">&lt;-</span> <span class="cf">function</span>(expr) {</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">eval</span>(expr), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">inherits</span>(out, <span class="st">"try-error"</span>)) <span class="cn">NULL</span> <span class="cf">else</span> out</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Time-slice CV (expanding window, h=3) + хронологический тест -------------</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>md <span class="ot">&lt;-</span> model_data</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>md_for_fit <span class="ot">&lt;-</span> md <span class="sc">%&gt;%</span> <span class="fu">select</span>(codTSB, T12, I5, NAOspring, haddock68, R3haddock)</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(md_for_fit)</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>holdout_frac <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>n_test <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">4</span>, <span class="fu">ceiling</span>(n <span class="sc">*</span> holdout_frac))</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>train_ts <span class="ot">&lt;-</span> <span class="fu">head</span>(md_for_fit, n <span class="sc">-</span> n_test)</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>test_ts  <span class="ot">&lt;-</span> <span class="fu">tail</span>(md_for_fit, n_test)</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>n_train <span class="ot">&lt;-</span> <span class="fu">nrow</span>(train_ts)</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>initial_frac <span class="ot">&lt;-</span> <span class="fl">0.6</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>horizon      <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>initialWindow <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">10</span>, <span class="fu">floor</span>(initial_frac <span class="sc">*</span> n_train))</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (initialWindow <span class="sc">+</span> horizon <span class="sc">&gt;</span> n_train) initialWindow <span class="ot">&lt;-</span> n_train <span class="sc">-</span> horizon</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Аккумулируем метрики и остатки по срезам</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>cv_summ <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Model =</span> <span class="fu">character</span>(), <span class="at">RMSE =</span> <span class="fu">double</span>(), <span class="at">MAE =</span> <span class="fu">double</span>())</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>resids_cv <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">LM =</span> <span class="fu">c</span>(), <span class="at">GLM =</span> <span class="fu">c</span>(), <span class="at">GAM =</span> <span class="fu">c</span>())</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>slice_id <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(initialWindow, n_train <span class="sc">-</span> horizon)) {</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>  slice_id <span class="ot">&lt;-</span> slice_id <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>  idx_tr <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>i</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>  idx_te <span class="ot">&lt;-</span> (i<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(i<span class="sc">+</span>horizon)</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>  dtr <span class="ot">&lt;-</span> train_ts[idx_tr, ]</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>  dte <span class="ot">&lt;-</span> train_ts[idx_te, ]</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># LM</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>  lm_fit <span class="ot">&lt;-</span> <span class="fu">safe_fit</span>(<span class="fu">quote</span>(<span class="fu">lm</span>(f_lm, <span class="at">data =</span> dtr)))</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(lm_fit)) {</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>    pr <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">predict</span>(lm_fit, <span class="at">newdata =</span> dte), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(pr, <span class="st">"try-error"</span>)) {</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>      cv_summ <span class="ot">&lt;-</span> <span class="fu">add_row</span>(cv_summ, <span class="at">Model =</span> <span class="st">"LM"</span>, <span class="at">RMSE =</span> <span class="fu">rmse</span>(dte<span class="sc">$</span>R3haddock, pr), <span class="at">MAE =</span> <span class="fu">mae</span>(dte<span class="sc">$</span>R3haddock, pr))</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>      resids_cv<span class="sc">$</span>LM <span class="ot">&lt;-</span> <span class="fu">c</span>(resids_cv<span class="sc">$</span>LM, dte<span class="sc">$</span>R3haddock <span class="sc">-</span> pr)</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># GLM (Gamma)</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>  glm_fit <span class="ot">&lt;-</span> <span class="fu">safe_fit</span>(<span class="fu">quote</span>(<span class="fu">glm</span>(f_lm, <span class="at">data =</span> dtr, <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>))))</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(glm_fit)) {</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>    pr <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">predict</span>(glm_fit, <span class="at">newdata =</span> dte, <span class="at">type =</span> <span class="st">"response"</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(pr, <span class="st">"try-error"</span>)) {</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>      cv_summ <span class="ot">&lt;-</span> <span class="fu">add_row</span>(cv_summ, <span class="at">Model =</span> <span class="st">"GLM"</span>, <span class="at">RMSE =</span> <span class="fu">rmse</span>(dte<span class="sc">$</span>R3haddock, pr), <span class="at">MAE =</span> <span class="fu">mae</span>(dte<span class="sc">$</span>R3haddock, pr))</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>      resids_cv<span class="sc">$</span>GLM <span class="ot">&lt;-</span> <span class="fu">c</span>(resids_cv<span class="sc">$</span>GLM, dte<span class="sc">$</span>R3haddock <span class="sc">-</span> pr)</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>  <span class="co"># GAM (Gamma log), ограничиваем сложность k для стабильности на малом n</span></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>  gam_fit <span class="ot">&lt;-</span> <span class="fu">safe_fit</span>(<span class="fu">quote</span>(mgcv<span class="sc">::</span><span class="fu">gam</span>(f_gam, <span class="at">data =</span> dtr, <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">method =</span> <span class="st">"REML"</span>, <span class="at">select =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(gam_fit)) {</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>    pr <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">predict</span>(gam_fit, <span class="at">newdata =</span> dte, <span class="at">type =</span> <span class="st">"response"</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(pr, <span class="st">"try-error"</span>)) {</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>      cv_summ <span class="ot">&lt;-</span> <span class="fu">add_row</span>(cv_summ, <span class="at">Model =</span> <span class="st">"GAM"</span>, <span class="at">RMSE =</span> <span class="fu">rmse</span>(dte<span class="sc">$</span>R3haddock, pr), <span class="at">MAE =</span> <span class="fu">mae</span>(dte<span class="sc">$</span>R3haddock, pr))</span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>      resids_cv<span class="sc">$</span>GAM <span class="ot">&lt;-</span> <span class="fu">c</span>(resids_cv<span class="sc">$</span>GAM, dte<span class="sc">$</span>R3haddock <span class="sc">-</span> pr)</span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a><span class="co"># Средние метрики по моделям</span></span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>cv_rank <span class="ot">&lt;-</span> cv_summ <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Model) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">RMSE =</span> <span class="fu">mean</span>(RMSE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">MAE =</span> <span class="fu">mean</span>(MAE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(RMSE, MAE)</span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cv_rank)</span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>best_model_name <span class="ot">&lt;-</span> cv_rank<span class="sc">$</span>Model[<span class="dv">1</span>]</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Лучшая модель по time-slice CV: %s</span><span class="sc">\n</span><span class="st">"</span>, best_model_name))</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Хронологический тест: обучаем на всём train_ts, прогнозируем на test_ts</span></span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>fit_on <span class="ot">&lt;-</span> <span class="cf">function</span>(model_name, data) {</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (model_name <span class="sc">==</span> <span class="st">"LM"</span>) <span class="fu">return</span>(<span class="fu">lm</span>(f_lm, <span class="at">data =</span> data))</span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (model_name <span class="sc">==</span> <span class="st">"GLM"</span>) <span class="fu">return</span>(<span class="fu">glm</span>(f_lm, <span class="at">data =</span> data, <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>)))</span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>  mgcv<span class="sc">::</span><span class="fu">gam</span>(f_gam, <span class="at">data =</span> data, <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">method =</span> <span class="st">"REML"</span>, <span class="at">select =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>predict_on <span class="ot">&lt;-</span> <span class="cf">function</span>(fit, newdata, model_name) {</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (model_name <span class="sc">==</span> <span class="st">"GLM"</span>) <span class="fu">return</span>(<span class="fu">predict</span>(fit, <span class="at">newdata =</span> newdata, <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">inherits</span>(fit, <span class="st">"gam"</span>)) <span class="fu">return</span>(<span class="fu">predict</span>(fit, <span class="at">newdata =</span> newdata, <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(fit, <span class="at">newdata =</span> newdata)</span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>fit_train <span class="ot">&lt;-</span> <span class="fu">fit_on</span>(best_model_name, train_ts)</span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>pred_te   <span class="ot">&lt;-</span> <span class="fu">predict_on</span>(fit_train, test_ts, best_model_name)</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>test_metrics <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> best_model_name,</span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE  =</span> <span class="fu">rmse</span>(test_ts<span class="sc">$</span>R3haddock, pred_te),</span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAE   =</span> <span class="fu">mae</span> (test_ts<span class="sc">$</span>R3haddock, pred_te),</span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>  <span class="at">R2    =</span> <span class="fu">r2</span>  (test_ts<span class="sc">$</span>R3haddock, pred_te)</span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(test_metrics)</span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Диагностика моделей (подгонка на всех данных до 2021) -------------------</span></span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>full_fit_df <span class="ot">&lt;-</span> md_for_fit</span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>lm_full  <span class="ot">&lt;-</span> <span class="fu">lm</span>(f_lm,  <span class="at">data =</span> full_fit_df)</span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>glm_full <span class="ot">&lt;-</span> <span class="fu">glm</span>(f_lm, <span class="at">data =</span> full_fit_df, <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>))</span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a>gam_full <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(f_gam, <span class="at">data =</span> full_fit_df, <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">method =</span> <span class="st">"REML"</span>, <span class="at">select =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">[LM] Сводка:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">summary</span>(lm_full))</span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">[LM] VIF:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(car<span class="sc">::</span><span class="fu">vif</span>(lm_full))</span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">[LM] Breusch–Pagan:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(lmtest<span class="sc">::</span><span class="fu">bptest</span>(lm_full))</span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">[LM] Durbin–Watson:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(lmtest<span class="sc">::</span><span class="fu">dwtest</span>(lm_full))</span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a>glm_resid <span class="ot">&lt;-</span> <span class="fu">residuals</span>(glm_full, <span class="at">type =</span> <span class="st">"pearson"</span>)</span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">[GLM-Gamma] Сводка:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">summary</span>(glm_full))</span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"[GLM-Gamma] Pearson dispersion: %.3f</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">sum</span>(glm_resid<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> glm_full<span class="sc">$</span>df.residual))</span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">[GAM] Сводка:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">summary</span>(gam_full))</span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">[GAM] Concurvity (коротко):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>ccv <span class="ot">&lt;-</span> <span class="fu">try</span>(mgcv<span class="sc">::</span><span class="fu">concurvity</span>(gam_full, <span class="at">full =</span> <span class="cn">FALSE</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(ccv, <span class="st">"try-error"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">is.list</span>(ccv)) {</span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Выведем усечённо и безопасно</span></span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">lapply</span>(ccv, <span class="cf">function</span>(m) <span class="cf">if</span> (<span class="fu">is.null</span>(m)) <span class="cn">NULL</span> <span class="cf">else</span> <span class="fu">round</span>(m, <span class="dv">3</span>)))</span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"не удалось оценить concurvity</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">try</span>(mgcv<span class="sc">::</span><span class="fu">gam.check</span>(gam_full), <span class="at">silent =</span> <span class="cn">TRUE</span>))</span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Прогноз 2022–2024 и эмпирические интервалы ------------------------------</span></span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a>best_full <span class="ot">&lt;-</span> <span class="cf">switch</span>(best_model_name,</span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a>  <span class="at">LM  =</span> lm_full,</span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>  <span class="at">GLM =</span> glm_full,</span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>  <span class="at">GAM =</span> gam_full</span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Остатки для PI: из CV выбранной модели, иначе из полного фита</span></span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a>resids <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">length</span>(resids_cv[[best_model_name]]) <span class="sc">&gt;</span> <span class="dv">5</span>) resids_cv[[best_model_name]] <span class="cf">else</span> <span class="fu">residuals</span>(best_full)</span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a>q025 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(resids, <span class="fl">0.025</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a>q250 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(resids, <span class="fl">0.250</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a>q750 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(resids, <span class="fl">0.750</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a>q975 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(resids, <span class="fl">0.975</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a>fc_start <span class="ot">&lt;-</span> <span class="dv">2022</span></span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a>pred_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"codTSB"</span>,<span class="st">"T12"</span>,<span class="st">"I5"</span>,<span class="st">"NAOspring"</span>,<span class="st">"haddock68"</span>)</span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> md <span class="sc">%&gt;%</span> <span class="fu">filter</span>(YEAR <span class="sc">&gt;</span> <span class="dv">1989</span> <span class="sc">&amp;</span> YEAR <span class="sc">&lt;</span> fc_start) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(pred_cols), <span class="sc">~</span><span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))) <span class="sc">%&gt;%</span> <span class="fu">as.list</span>()</span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"user_future"</span>)) user_future <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a>build_future <span class="ot">&lt;-</span> <span class="cf">function</span>(years, mu, <span class="at">user_df =</span> <span class="cn">NULL</span>) {</span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">YEAR =</span> years)</span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (v <span class="cf">in</span> pred_cols) df[[v]] <span class="ot">&lt;-</span> mu[[v]]</span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(user_df)) {</span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(user_df))) {</span>
<span id="cb3-205"><a href="#cb3-205" aria-hidden="true" tabindex="-1"></a>      yr <span class="ot">&lt;-</span> user_df<span class="sc">$</span>YEAR[i]</span>
<span id="cb3-206"><a href="#cb3-206" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (yr <span class="sc">%in%</span> years) {</span>
<span id="cb3-207"><a href="#cb3-207" aria-hidden="true" tabindex="-1"></a>        idx <span class="ot">&lt;-</span> <span class="fu">which</span>(df<span class="sc">$</span>YEAR <span class="sc">==</span> yr)</span>
<span id="cb3-208"><a href="#cb3-208" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (v <span class="cf">in</span> <span class="fu">intersect</span>(pred_cols, <span class="fu">names</span>(user_df))) {</span>
<span id="cb3-209"><a href="#cb3-209" aria-hidden="true" tabindex="-1"></a>          val <span class="ot">&lt;-</span> user_df[[v]][i]</span>
<span id="cb3-210"><a href="#cb3-210" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(val)) df[[v]][idx] <span class="ot">&lt;-</span> val</span>
<span id="cb3-211"><a href="#cb3-211" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb3-212"><a href="#cb3-212" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-213"><a href="#cb3-213" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-214"><a href="#cb3-214" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-215"><a href="#cb3-215" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb3-216"><a href="#cb3-216" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-217"><a href="#cb3-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-218"><a href="#cb3-218" aria-hidden="true" tabindex="-1"></a>future_years <span class="ot">&lt;-</span> fc_start<span class="sc">:</span><span class="dv">2024</span></span>
<span id="cb3-219"><a href="#cb3-219" aria-hidden="true" tabindex="-1"></a>scenario_future <span class="ot">&lt;-</span> <span class="fu">build_future</span>(future_years, mu, user_future)</span>
<span id="cb3-220"><a href="#cb3-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-221"><a href="#cb3-221" aria-hidden="true" tabindex="-1"></a>predict_best <span class="ot">&lt;-</span> <span class="cf">function</span>(fit, newdata, model_name) {</span>
<span id="cb3-222"><a href="#cb3-222" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (model_name <span class="sc">==</span> <span class="st">"GLM"</span>) <span class="fu">return</span>(<span class="fu">predict</span>(fit, <span class="at">newdata =</span> newdata, <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb3-223"><a href="#cb3-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(fit, <span class="at">newdata =</span> newdata)</span>
<span id="cb3-224"><a href="#cb3-224" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-225"><a href="#cb3-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-226"><a href="#cb3-226" aria-hidden="true" tabindex="-1"></a>pred_future <span class="ot">&lt;-</span> <span class="fu">predict_best</span>(best_full, scenario_future, best_model_name)</span>
<span id="cb3-227"><a href="#cb3-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-228"><a href="#cb3-228" aria-hidden="true" tabindex="-1"></a>forecast_tbl <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb3-229"><a href="#cb3-229" aria-hidden="true" tabindex="-1"></a>  <span class="at">YEAR      =</span> scenario_future<span class="sc">$</span>YEAR,</span>
<span id="cb3-230"><a href="#cb3-230" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model     =</span> best_model_name,</span>
<span id="cb3-231"><a href="#cb3-231" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_mean =</span> <span class="fu">as.numeric</span>(pred_future),</span>
<span id="cb3-232"><a href="#cb3-232" aria-hidden="true" tabindex="-1"></a>  <span class="at">PI50_low  =</span> pred_future <span class="sc">+</span> q250, <span class="at">PI50_high =</span> pred_future <span class="sc">+</span> q750,</span>
<span id="cb3-233"><a href="#cb3-233" aria-hidden="true" tabindex="-1"></a>  <span class="at">PI95_low  =</span> pred_future <span class="sc">+</span> q025, <span class="at">PI95_high =</span> pred_future <span class="sc">+</span> q975</span>
<span id="cb3-234"><a href="#cb3-234" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-235"><a href="#cb3-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-236"><a href="#cb3-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-237"><a href="#cb3-237" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb3-238"><a href="#cb3-238" aria-hidden="true" tabindex="-1"></a>  forecast_tbl <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(.x, <span class="dv">2</span>))),</span>
<span id="cb3-239"><a href="#cb3-239" aria-hidden="true" tabindex="-1"></a>  <span class="at">caption =</span> <span class="st">"Holdout-метрики (округлено до 2 знаков)"</span></span>
<span id="cb3-240"><a href="#cb3-240" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-241"><a href="#cb3-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-242"><a href="#cb3-242" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Визуализация 1990–2024 ---------------------------------------------------</span></span>
<span id="cb3-243"><a href="#cb3-243" aria-hidden="true" tabindex="-1"></a>pred_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb3-244"><a href="#cb3-244" aria-hidden="true" tabindex="-1"></a>  md <span class="sc">%&gt;%</span> <span class="fu">select</span>(YEAR, <span class="fu">all_of</span>(pred_cols)),</span>
<span id="cb3-245"><a href="#cb3-245" aria-hidden="true" tabindex="-1"></a>  scenario_future</span>
<span id="cb3-246"><a href="#cb3-246" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(YEAR, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(YEAR)</span>
<span id="cb3-247"><a href="#cb3-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-248"><a href="#cb3-248" aria-hidden="true" tabindex="-1"></a>pred_df<span class="sc">$</span>Pred      <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">predict_best</span>(best_full, pred_df, best_model_name))</span>
<span id="cb3-249"><a href="#cb3-249" aria-hidden="true" tabindex="-1"></a>pred_df<span class="sc">$</span>PI50_low  <span class="ot">&lt;-</span> pred_df<span class="sc">$</span>Pred <span class="sc">+</span> q250</span>
<span id="cb3-250"><a href="#cb3-250" aria-hidden="true" tabindex="-1"></a>pred_df<span class="sc">$</span>PI50_high <span class="ot">&lt;-</span> pred_df<span class="sc">$</span>Pred <span class="sc">+</span> q750</span>
<span id="cb3-251"><a href="#cb3-251" aria-hidden="true" tabindex="-1"></a>pred_df<span class="sc">$</span>PI95_low  <span class="ot">&lt;-</span> pred_df<span class="sc">$</span>Pred <span class="sc">+</span> q025</span>
<span id="cb3-252"><a href="#cb3-252" aria-hidden="true" tabindex="-1"></a>pred_df<span class="sc">$</span>PI95_high <span class="ot">&lt;-</span> pred_df<span class="sc">$</span>Pred <span class="sc">+</span> q975</span>
<span id="cb3-253"><a href="#cb3-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-254"><a href="#cb3-254" aria-hidden="true" tabindex="-1"></a>hist_df <span class="ot">&lt;-</span> md <span class="sc">%&gt;%</span> <span class="fu">select</span>(YEAR, R3haddock)</span>
<span id="cb3-255"><a href="#cb3-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-256"><a href="#cb3-256" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb3-257"><a href="#cb3-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> pred_df, <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">ymin =</span> PI95_low, <span class="at">ymax =</span> PI95_high), <span class="at">fill =</span> <span class="st">"grey80"</span>, <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb3-258"><a href="#cb3-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> pred_df, <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">ymin =</span> PI50_low, <span class="at">ymax =</span> PI50_high), <span class="at">fill =</span> <span class="st">"grey60"</span>, <span class="at">alpha =</span> <span class="fl">0.35</span>) <span class="sc">+</span></span>
<span id="cb3-259"><a href="#cb3-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(pred_df, YEAR <span class="sc">&lt;</span> fc_start), <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">y =</span> Pred), <span class="at">color =</span> <span class="st">"steelblue4"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb3-260"><a href="#cb3-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(pred_df, YEAR <span class="sc">&gt;=</span> fc_start<span class="dv">-1</span>), <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">y =</span> Pred), <span class="at">color =</span> <span class="st">"steelblue4"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb3-261"><a href="#cb3-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> hist_df, <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">y =</span> R3haddock), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb3-262"><a href="#cb3-262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))) <span class="sc">+</span></span>
<span id="cb3-263"><a href="#cb3-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"Пополнение R3haddock: факт (1990–2021) и прогноз (2022–2024) — "</span>, best_model_name),</span>
<span id="cb3-264"><a href="#cb3-264" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Прогноз — пунктир, интервалы — эмпирические из остатков"</span>,</span>
<span id="cb3-265"><a href="#cb3-265" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Год"</span>, <span class="at">y =</span> <span class="st">"R3haddock"</span>) <span class="sc">+</span></span>
<span id="cb3-266"><a href="#cb3-266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb3-267"><a href="#cb3-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb3-268"><a href="#cb3-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-269"><a href="#cb3-269" aria-hidden="true" tabindex="-1"></a><span class="co"># AIC-таблица (LM/GLM сопоставимы напрямую; для GAM также показываем ML)</span></span>
<span id="cb3-270"><a href="#cb3-270" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">AIC (LM): "</span>,  <span class="fu">AIC</span>(lm_full),  <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb3-271"><a href="#cb3-271" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIC (GLM): "</span>, <span class="fu">AIC</span>(glm_full), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb3-272"><a href="#cb3-272" aria-hidden="true" tabindex="-1"></a>gam_full_ml <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(f_gam, <span class="at">data =</span> full_fit_df, <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">method =</span> <span class="st">"ML"</span>, <span class="at">select =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-273"><a href="#cb3-273" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIC (GAM, REML): "</span>, <span class="fu">AIC</span>(gam_full),    <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb3-274"><a href="#cb3-274" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AIC (GAM, ML):   "</span>, <span class="fu">AIC</span>(gam_full_ml), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb3-275"><a href="#cb3-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-276"><a href="#cb3-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-277"><a href="#cb3-277" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb3-278"><a href="#cb3-278" aria-hidden="true" tabindex="-1"></a><span class="co"># Конец</span></span>
<span id="cb3-279"><a href="#cb3-279" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="полный-цикл-от-факторов-до-ансамблевого-прогноза" class="level2" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="полный-цикл-от-факторов-до-ансамблевого-прогноза"><span class="header-section-number">8.5</span> Полный цикл от факторов до ансамблевого прогноза</h2>
<p>Полный цикл анализа от идентификации ключевых факторов до создания надежного ансамблевого прогноза пополнения рыбных запасов представляет собой сложный, но систематизированный процесс, требующий как глубокого понимания биологических процессов, так и владения современными методами анализа данных. Начиная с формирования исходного набора предикторов, включающего как биологические переменные (нерестовый запас, биомасса хищников), так и комплексные океанографические показатели (температура, соленость, климатические индексы), мы проходим через строгую последовательность этапов, каждый из которых важен для конечного результата. На этапе подготовки данных мы не просто приводим информацию к числовому формату и заменяем строковые обозначения пропущенных значений «NA» на стандартные NA, но и проводим глубокий анализ корреляционной структуры, устраняя мультиколлинеарность через анализ корреляций и VIF-диагностику, что важно для корректной интерпретации последующих моделей. Для обработки пропусков мы применяем медианную импутацию, которая представляет собой простой и устойчивый к выбросам метод, хотя в некоторых случаях могут быть использованы и более сложные методы, такие как KNN-импутация или множественная импутация с использованием пакета MICE, особенно когда данные имеют сложную структуру или временные зависимости.</p>
<p>Затем следует этап отбора предикторов, где мы применяем два комплементарных метода: Boruta на основе Random Forest для выявления нелинейных зависимостей и LASSO-регрессию для линейного отбора с регуляризацией. Их объединение позволяет получить устойчивый набор предикторов, дополненный биологически значимыми переменными по экспертной оценке, что создает баланс между статистической значимостью и содержательной интерпретируемостью. Этот этап является мостом между классической ихтиологией и современными методами анализа, где экспертные знания биолога взаимодействуют с алгоритмической строгостью статистики, гарантируя включение ключевых факторов, таких как нерестовый запас, который должен присутствовать в модели по самой своей природе процесса пополнения.</p>
<p>После подготовки данных мы переходим к сравнению различных семейств моделей через единую кросс-валидационную процедуру (5-fold CV) с последующим хронологическим тестированием на отложенной выборке. Помимо линейных и обобщенных линейных моделей (LM, GLM), обобщенных аддитивных моделей (GAM), мы тестируем современные алгоритмы машинного обучения: Random Forest для улавливания сложных нелинейных зависимостей и взаимодействий между факторами, будучи при этом устойчивым к шуму и выбросам; XGBoost, с его градиентным бустингом над деревьями решений, часто дающий высочайшую точность прогноза; SVM с радиальным ядром для сложных разделяющих поверхностей; и нейронные сети для автоматического извлечения признаков. Каждая модель оценивается по комплексу метрик: RMSE, MAE, R² и MAPE, что позволяет сравнивать их прогностическую силу на разных участках данных и выявлять модели, которые лучше всего справляются с конкретными аспектами прогнозирования.</p>
<p>Особое внимание уделяется временным характеристикам данных, поскольку при анализе водных биоресурсов мы имеем дело с временными рядами, где случайное перемешивание данных приведет к утечке информации из будущего в прошлое, искусственно завысив качество прогноза. Для решения этой проблемы мы применяем специализированную time-slice кросс-валидацию с расширяющимся окном и горизонтом прогноза 3 года, которая имитирует реальные условия прогнозирования, обучаясь только на данных из прошлого и проверяя на последующих периодах. Это позволяет оценить устойчивость моделей к временным сдвигам и их способность к экстраполяции, что критически важно для практических задач управления рыбными запасами.</p>
<p>Выбор окончательной модели — это не просто вопрос максимальной точности на кросс-валидации, а сложный компромисс между точностью, интерпретируемостью и биологической правдоподобностью. Кульминацией цикла становится построение ансамблевой модели, комбинирующей сильные стороны отдельных алгоритмов. В нашем анализе оптимальный ансамбль (CUBIST + LM) строится через взвешенное усреднение предсказаний, где веса определяются на основе кросс-валидационной ошибки — например, 75% веса приходится на мощную нелинейную модель Cubist, а 25% — на простую и устойчивую линейную регрессию. Такой подход позволяет нивелировать индивидуальные недостатки моделей, сохранить интерпретируемость линейных моделей, где биолог может понять, как именно каждый фактор влияет на прогноз, и при этом использовать гибкость методов машинного обучения для захвата сложных нелинейных паттернов, которые могут ускользнуть от классических статистических методов.</p>
<p>Важнейшим компонентом становится оценка неопределенности через эмпирические доверительные интервалы, построенные на основе распределения остатков ансамблевой модели. Мы используем квантили остатков из кросс-валидации для построения 50% и 95% доверительных интервалов, что позволяет получить не только точечный прогноз, но и меру его надежности, важную для принятия управленческих решений. Это дает возможность визуализировать не только ожидаемое значение пополнения, но и диапазон возможных сценариев, что особенно важно в условиях высокой экологической неопределенности.</p>
<p>Финальная визуализация представляет собой совмещение исторических данных с прогнозом на 3 года вперед, где исторические данные отображаются сплошной линией, прогноз — пунктиром, а 50% и 95% доверительные интервалы — серыми лентами различной интенсивности. Такой график не только демонстрирует результат, но и позволяет визуально оценить точность модели на исторических данных и неопределенность будущих предсказаний, делая результаты доступными не только для статистиков, но и для управленцев и политиков, принимающих решения на основе этих прогнозов.</p>
<p>Представленный цикл является итеративным процессом: прогнозная точность ансамбля может быть улучшена через включение новых предикторов, изучение влияния предикторов с задержкой (лагами), тонкую настройку гиперпараметров моделей и обновление данных по мере их поступления. Этот подход представляет собой практический компромисс между статистической строгостью, вычислительной эффективностью и биологической интерпретируемостью, делая его мощным инструментом для решения прикладных задач оценки водных биоресурсов, где каждый этап, от первичной обработки данных до финального прогноза, подчинен одной цели — обеспечению устойчивого управления рыбными запасами на основе надежного научного анализа.</p>
<div class="cell" data-code-line-count="true" data-code-max-lines="5">
<details class="code-fold">
<summary>Показать скрипт</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ПРАКТИЧЕСКОЕ ЗАНЯТИЕ: АНАЛИЗ ФАКТОРОВ И ПРОГНОЗ ПОПОЛНЕНИЯ ЗАПАСА</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Курс: "Оценка водных биоресурсов в среде R (для начинающих)"</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Автор: Баканев С. В.</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Структура:</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Подготовка данных и выбор предикторов</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Базовое сравнение моделей (5-fold CV + holdout)</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Выбор лучшей прогностической модели (time-slice CV на 3 года + хронологический тест)</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Прогноз 2022–2024 (ансамбль CUBIST+LM) и график 1990–2024 с ДИ</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------------------</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Пояснения к занятию (для начинающих):</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># - Мы работаем с временным рядом пополнения запаса R3haddock и набором факторов</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   среды/биомассы. Цель — построить понятные и проверяемые модели прогноза.</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># - Сначала отберём информативные предикторы (Boruta и LASSO), затем сравним</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   разные модели машинного обучения на кросс-валидации (CV), после чего выберем</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   лучшую схему по time-slice CV (учитывая хронологию), и сделаем прогноз.</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) ВЫБОР ПРЕДИКТОРОВ</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------------------</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Цель блока: привести данные к числовому виду, обработать пропуски, сократить</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co"># мультиколлинеарность (сильные корреляции), а затем автоматически выделить</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="co"># кандидатов-предикторов двумя методами (Boruta, LASSO). В конце сформируем</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co"># финальный пул признаков и проверим их значимость в простой LM.</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Установка и подключение необходимых библиотек</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Для автоматического отбора предикторов нам понадобятся дополнительные пакеты</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"pacman"</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  readxl, tidyverse, caret, corrplot, mgcv, randomForest, xgboost,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  Boruta,GGally, FactoMineR, glmnet, recipes, rsample  <span class="co"># Новые библиотеки для автоматического отбора</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Очистка среды и установка рабочей директории</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Совет: rm(list=ls()) очищает все объекты в памяти R; setwd задаёт папку,</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="co"># где искать/сохранять файлы. Убедитесь, что путь корректен на вашей машине.</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"C:/RECRUITMENT/"</span>)</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Пакеты для расширенного отбора предикторов</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Boruta — обёртка над Random Forest для отбора признаков;</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="co"># glmnet — регуляризация (LASSO/ElasticNet) для отбора/усиления обобщающей способности;</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="co"># FactoMineR — PCA и другие многомерные методы (используем как утилиту).</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Boruta)   <span class="co"># Алгоритм обертки для отбора признаков</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)   <span class="co"># LASSO-регрессия</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(FactoMineR) <span class="co"># PCA анализ</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Загрузка и первичная обработка данных</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Шаги: фильтруем годы, приводим типы к числовому, заменяем строковые "NA" на NA.</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>DATA <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_excel</span>(<span class="st">"RECRUITMENT.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"RECRUITMENT"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEAR <span class="sc">&gt;</span> <span class="dv">1989</span> <span class="sc">&amp;</span> YEAR <span class="sc">&lt;</span> <span class="dv">2022</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Преобразуем необходимые столбцы в числовой формат</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"T"</span>), as.numeric),</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"I"</span>), as.numeric),</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"O"</span>), as.numeric),</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Обработка пропущенных значений (заменяем строку "NA" на NA)</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), <span class="sc">~</span><span class="fu">na_if</span>(., <span class="st">"NA"</span>)))</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Подготовка данных -------------------------------------------------------</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Выделим все возможные предикторы, включая географию и индексы трески</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Примечание: оставляем только числовые переменные, т.к. большинство моделей</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a><span class="co"># требует числовой вход без категориальных уровней.</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>predictors <span class="ot">&lt;-</span> DATA <span class="sc">%&gt;%</span> </span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>YEAR, <span class="sc">-</span>R3haddock) <span class="sc">%&gt;%</span> </span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select_if</span>(is.numeric) <span class="co"># Только числовые переменные</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Целевая переменная</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>response <span class="ot">&lt;-</span> DATA<span class="sc">$</span>R3haddock</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a><span class="co"># В статистическом анализе мы различаем:</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a><span class="co"># - Отклик (response/target variable) - то, что мы пытаемся предсказать (в нашем случае R3haddock)</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a><span class="co"># - Предикторы (predictors/features) - переменные, которые могут объяснять изменения отклика</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Для корректного анализа важно, чтобы предикторы были числовыми или преобразованы в числовой формат.</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Обработка пропусков -----------------------------------------------------</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Заполнение медианными значениями — простой и устойчивый способ справиться с NA.</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Альтернативы: множественная иммутация (mice), KNN-impute и др.</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>predictors_filled <span class="ot">&lt;-</span> predictors <span class="sc">%&gt;%</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">ifelse</span>(<span class="fu">is.na</span>(.), <span class="fu">median</span>(., <span class="at">na.rm =</span> <span class="cn">TRUE</span>), .)))</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Заполнение медианой - простой и устойчивый метод обработки пропусков для числовых переменных.</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Медиана предпочтительнее среднего, так как менее чувствительна к выбросам.</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Предварительный анализ корреляций ---------------------------------------</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Зачем: высокие корреляции затрудняют интерпретацию и могут вредить ряду моделей.</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>cor_matrix <span class="ot">&lt;-</span> <span class="fu">cor</span>(predictors_filled, <span class="at">use =</span> <span class="st">"complete.obs"</span>)</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a><span class="fu">corrplot</span>(cor_matrix, <span class="at">method =</span> <span class="st">"circle"</span>, <span class="at">type =</span> <span class="st">"upper"</span>, <span class="at">tl.cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Удаляем высокоскоррелированные предикторы (r &gt; 0.8)</span></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Это механическое сокращение мультиколлинеарности до этапа отбора.</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>high_cor <span class="ot">&lt;-</span> <span class="fu">findCorrelation</span>(cor_matrix, <span class="at">cutoff =</span> <span class="fl">0.8</span>)</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>predictors_filtered <span class="ot">&lt;-</span> predictors_filled[, <span class="sc">-</span>high_cor]</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a><span class="co"># Высокая корреляция между предикторами (мультиколлинеарность) может привести к нестабильности моделей.</span></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Например, если два предиктора почти идентичны, модель может неустойчиво распределять их влияние на отклик.</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Удаление сильно коррелированных переменных (r &gt; 0.8) помогает улучшить интерпретируемость и стабильность моделей.</span></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Автоматизированный отбор Boruta (обертка Random Forest) -----------------</span></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Идея: определить признаки, которые важнее, чем случайный шум (shadow features).</span></span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>boruta_output <span class="ot">&lt;-</span> <span class="fu">Boruta</span>(</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> predictors_filtered, </span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> response,</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>  <span class="at">maxRuns =</span> <span class="dv">100</span>,</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>  <span class="at">doTrace =</span> <span class="dv">2</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Визуализация результатов</span></span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(boruta_output, <span class="at">cex.axis =</span> <span class="fl">0.7</span>, <span class="at">las =</span> <span class="dv">2</span>)</span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>boruta_stats <span class="ot">&lt;-</span> <span class="fu">attStats</span>(boruta_output)</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>selected_vars <span class="ot">&lt;-</span> <span class="fu">getSelectedAttributes</span>(boruta_output, <span class="at">withTentative =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a><span class="co"># Boruta - это алгоритм отбора признаков, основанный на методе случайного леса.</span></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Он сравнивает важность реальных переменных с "теневыми" переменными (случайными копиями),</span></span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a><span class="co"># чтобы определить, действительно ли переменная информативна. [[6]]</span></span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Результаты Boruta показывают: </span></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a><span class="co">#   - Confirmed (зеленые) - значимые предикторы</span></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a><span class="co">#   - Tentative (желтые) - предикторы, близкие к порогу значимости</span></span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a><span class="co">#   - Rejected (красные) - незначимые предикторы</span></span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. LASSO с более строгим критерием ------------------------------------------</span></span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Идея: L1-регуляризация зануляет коэффициенты «слабых» предикторов.</span></span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Выбор lambda.1se вместо lambda.min — более консервативный (простая модель).</span></span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(predictors_filtered)</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> response</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a><span class="co"># LASSO (Least Absolute Shrinkage and Selection Operator) - метод регрессии с L1-регуляризацией,</span></span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a><span class="co"># который одновременно выполняет отбор признаков и оценку коэффициентов. [[8]]</span></span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Параметр lambda контролирует силу регуляризации:</span></span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a><span class="co">#   - lambda.min дает наименьшую ошибку, но может включать шумовые переменные</span></span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a><span class="co">#   - lambda.1se (на 1 стандартную ошибку больше) дает более простую модель с меньшим риском переобучения</span></span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a><span class="co"># Для прогнозирования мы предпочитаем более строгий критерий (lambda.1se), чтобы модель была устойчивее. [[1]]</span></span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Кросс-валидация</span></span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>cv_fit <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(x, y, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">nfolds =</span> <span class="dv">10</span>)</span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv_fit)</span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a><span class="co"># ИСПОЛЬЗУЕМ lambda.1se вместо lambda.min — СТРОЖЕ!</span></span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>lasso_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(cv_fit, <span class="at">s =</span> <span class="st">"lambda.1se"</span>)  <span class="co"># &lt;-- Ключевое изменение!</span></span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>lasso_vars <span class="ot">&lt;-</span> <span class="fu">rownames</span>(lasso_coef)[lasso_coef[,<span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>][<span class="sc">-</span><span class="dv">1</span>]  <span class="co"># исключаем (Intercept)</span></span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Сравнение отобранных предикторов ----------------------------------------</span></span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Полезно видеть, какие признаки отмечают оба метода (устойчивые кандидаты).</span></span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Boruta selected:"</span>, <span class="fu">length</span>(selected_vars), <span class="st">"variables</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(selected_vars)</span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">LASSO selected:"</span>, <span class="fu">length</span>(lasso_vars), <span class="st">"variables</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lasso_vars)</span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Финальный набор предикторов (объединение результатов) -------------------</span></span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a><span class="co"># Логика: объединяем списки, добавляем биологически важные переменные вручную.</span></span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>final_vars <span class="ot">&lt;-</span> <span class="fu">union</span>(selected_vars, lasso_vars) </span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Добавляем обязательные переменные по биологической логике</span></span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a>mandatory <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"haddock68"</span>)</span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>final_vars <span class="ot">&lt;-</span> <span class="fu">union</span>(final_vars, mandatory) <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Мы объединяем результаты двух методов отбора признаков для большей надежности.</span></span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a><span class="co"># Также добавляем переменную haddock68 (нерестовый запас), так как биологически </span></span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a><span class="co"># логично, что пополнение запаса напрямую зависит от численности производителей. </span></span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Это пример интеграции экспертных знаний в статистический анализ - важный принцип </span></span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a><span class="co"># при работе с данными в биологических науках.</span></span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Проверка значимости -----------------------------------------------------</span></span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Быстрая оценка значимости с LM: не как окончательный вывод, а как sanity-check.</span></span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a>final_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(response <span class="sc">~</span> <span class="fu">as.matrix</span>(predictors_filled[, final_vars]))</span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(final_model)</span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Формирование финального датасета ----------------------------------------</span></span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a><span class="co"># Собираем набор с откликом и выбранными предикторами; удалим строки с NA.</span></span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> DATA <span class="sc">%&gt;%</span></span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(R3haddock, <span class="fu">all_of</span>(final_vars)) <span class="sc">%&gt;%</span></span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a><span class="co"># Просмотр структуры финальных данных</span></span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(model_data)</span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-188"><a href="#cb4-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Визуализация важности переменных</span></span>
<span id="cb4-189"><a href="#cb4-189" aria-hidden="true" tabindex="-1"></a><span class="co"># Внимание: важности от RF — относительные; сопоставляйте с предметной логикой.</span></span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a>var_importance <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> model_data, <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(var_importance, <span class="at">main =</span> <span class="st">"Важность предикторов"</span>)</span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a><span class="co"># Перед окончательным выбором модели мы проверяем значимость предикторов с помощью линейной регрессии.</span></span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a><span class="co"># Функция summary() показывает p-значения коэффициентов - если p &lt; 0.05, переменная считается статистически значимой. </span></span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a><span class="co"># Визуализация важности переменных с помощью случайного леса дает дополнительную перспективу,</span></span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a><span class="co"># показывая, какие переменные наиболее информативны для предсказания без предположений о линейности.</span></span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a><span class="co">#  ПОДГОТОВКА ДАННЫХ</span></span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a><span class="co"># Создаём NAOspring, фиксируем финальный набор признаков, сохраняем CSV.</span></span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------------------</span></span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a><span class="co"># Цель блока: стандартизировать набор признаков для дальнейшего сравнения</span></span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a><span class="co"># моделей и обеспечить воспроизводимость (фиксированный CSV с нужными полями).</span></span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.1 Пакеты и окружение</span></span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Примечание: блок повторяет базовую инициализацию для автономного запуска.</span></span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"pacman"</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb4-209"><a href="#cb4-209" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(readxl, tidyverse, caret, corrplot)</span>
<span id="cb4-210"><a href="#cb4-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-211"><a href="#cb4-211" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb4-212"><a href="#cb4-212" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb4-213"><a href="#cb4-213" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"C:/RECRUITMENT/"</span>)</span>
<span id="cb4-214"><a href="#cb4-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-215"><a href="#cb4-215" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.2 Загрузка исходных данных и приведение типов</span></span>
<span id="cb4-216"><a href="#cb4-216" aria-hidden="true" tabindex="-1"></a>DATA <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_excel</span>(<span class="st">"RECRUITMENT.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"RECRUITMENT"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-217"><a href="#cb4-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEAR <span class="sc">&gt;</span> <span class="dv">1989</span> <span class="sc">&amp;</span> YEAR <span class="sc">&lt;</span> <span class="dv">2022</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-218"><a href="#cb4-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-219"><a href="#cb4-219" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"T"</span>), as.numeric),</span>
<span id="cb4-220"><a href="#cb4-220" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"I"</span>), as.numeric),</span>
<span id="cb4-221"><a href="#cb4-221" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"O"</span>), as.numeric),</span>
<span id="cb4-222"><a href="#cb4-222" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">where</span>(is.character), <span class="sc">~</span><span class="fu">na_if</span>(., <span class="st">"NA"</span>))</span>
<span id="cb4-223"><a href="#cb4-223" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-224"><a href="#cb4-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-225"><a href="#cb4-225" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.3 Создаём NAOspring (если есть NAO3, NAO4, NAO5)</span></span>
<span id="cb4-226"><a href="#cb4-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Идея: агрегируем весенний индекс NAO как среднее за месяцы 3–5.</span></span>
<span id="cb4-227"><a href="#cb4-227" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"NAO3"</span>,<span class="st">"NAO4"</span>,<span class="st">"NAO5"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(DATA))) {</span>
<span id="cb4-228"><a href="#cb4-228" aria-hidden="true" tabindex="-1"></a>  DATA <span class="ot">&lt;-</span> DATA <span class="sc">%&gt;%</span></span>
<span id="cb4-229"><a href="#cb4-229" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">NAOspring =</span> <span class="fu">rowMeans</span>(<span class="fu">pick</span>(NAO3, NAO4, NAO5), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-230"><a href="#cb4-230" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>NAO3, <span class="sc">-</span>NAO4, <span class="sc">-</span>NAO5)</span>
<span id="cb4-231"><a href="#cb4-231" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-232"><a href="#cb4-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-233"><a href="#cb4-233" aria-hidden="true" tabindex="-1"></a><span class="co"># NAO (North Atlantic Oscillation) - важный климатический индекс, влияющий описывающий изменения атмосферного давления</span></span>
<span id="cb4-234"><a href="#cb4-234" aria-hidden="true" tabindex="-1"></a><span class="co"># над Северной Атлантикой. В частности, он отражает разницу в атмосферном давлении между Исландской депрессией и</span></span>
<span id="cb4-235"><a href="#cb4-235" aria-hidden="true" tabindex="-1"></a><span class="co"># Азорским максимумом. NAO влияет на силу и направление западных ветров, а также на траектории штормов в Северной Атлантике. </span></span>
<span id="cb4-236"><a href="#cb4-236" aria-hidden="true" tabindex="-1"></a><span class="co"># Мы создаем NAOspring как среднее значение за весенние месяцы (марта, апреля, мая),</span></span>
<span id="cb4-237"><a href="#cb4-237" aria-hidden="true" tabindex="-1"></a><span class="co"># так как именно в этот период происходят ключевые процессы, влияющие на нерест трески. </span></span>
<span id="cb4-238"><a href="#cb4-238" aria-hidden="true" tabindex="-1"></a><span class="co"># Создание составных переменных на основе экспертных знаний часто улучшает качество моделей.</span></span>
<span id="cb4-239"><a href="#cb4-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-240"><a href="#cb4-240" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.4 Финальный учебный набор предикторов (фиксируем)</span></span>
<span id="cb4-241"><a href="#cb4-241" aria-hidden="true" tabindex="-1"></a><span class="co"># Важно: проверяем присутствие нужных колонок и формируем компактный датасет.</span></span>
<span id="cb4-242"><a href="#cb4-242" aria-hidden="true" tabindex="-1"></a>needed <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"codTSB"</span>, <span class="st">"T12"</span>, <span class="st">"I5"</span>, <span class="st">"NAOspring"</span>, <span class="st">"haddock68"</span>)</span>
<span id="cb4-243"><a href="#cb4-243" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(needed <span class="sc">%in%</span> <span class="fu">names</span>(DATA)))</span>
<span id="cb4-244"><a href="#cb4-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-245"><a href="#cb4-245" aria-hidden="true" tabindex="-1"></a><span class="co"># Сохраняем YEAR в CSV (ниже он будет отброшен при обучении, но нужен для графика)</span></span>
<span id="cb4-246"><a href="#cb4-246" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> DATA <span class="sc">%&gt;%</span></span>
<span id="cb4-247"><a href="#cb4-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEAR, <span class="fu">all_of</span>(needed), R3haddock) <span class="sc">%&gt;%</span></span>
<span id="cb4-248"><a href="#cb4-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb4-249"><a href="#cb4-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-250"><a href="#cb4-250" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(model_data, <span class="st">"selected_predictors_dataset.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-251"><a href="#cb4-251" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(model_data)</span>
<span id="cb4-252"><a href="#cb4-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-253"><a href="#cb4-253" aria-hidden="true" tabindex="-1"></a><span class="co"># (необязательно) Глянуть попарные связи и корреляции</span></span>
<span id="cb4-254"><a href="#cb4-254" aria-hidden="true" tabindex="-1"></a><span class="co"># ggpairs может быть медленным, оставим по желанию</span></span>
<span id="cb4-255"><a href="#cb4-255" aria-hidden="true" tabindex="-1"></a> <span class="fu">ggpairs</span>(model_data, <span class="at">columns =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>,</span>
<span id="cb4-256"><a href="#cb4-256" aria-hidden="true" tabindex="-1"></a>         <span class="at">lower =</span> <span class="fu">list</span>(<span class="at">continuous =</span> <span class="fu">wrap</span>(<span class="st">"smooth"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="fl">0.5</span>)),</span>
<span id="cb4-257"><a href="#cb4-257" aria-hidden="true" tabindex="-1"></a>         <span class="at">upper =</span> <span class="fu">list</span>(<span class="at">cor =</span> <span class="fu">wrap</span>(<span class="st">"cor"</span>, <span class="at">size =</span> <span class="dv">3</span>)))</span>
<span id="cb4-258"><a href="#cb4-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-259"><a href="#cb4-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-260"><a href="#cb4-260" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb4-261"><a href="#cb4-261" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) БАЗОВОЕ СРАВНЕНИЕ МОДЕЛЕЙ (5-FOLD CV + HOLDOUT)</span></span>
<span id="cb4-262"><a href="#cb4-262" aria-hidden="true" tabindex="-1"></a><span class="co"># Единые фолды CV, тренировочно-тестовое разбиение, сводка метрик.</span></span>
<span id="cb4-263"><a href="#cb4-263" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------------------</span></span>
<span id="cb4-264"><a href="#cb4-264" aria-hidden="true" tabindex="-1"></a><span class="co"># Идея блока: быстрая «панель» сравнения разных семейств моделей на одинаковых</span></span>
<span id="cb4-265"><a href="#cb4-265" aria-hidden="true" tabindex="-1"></a><span class="co"># условиях (одинаковые фолды CV) и внешний тест (holdout). Это помогает увидеть</span></span>
<span id="cb4-266"><a href="#cb4-266" aria-hidden="true" tabindex="-1"></a><span class="co"># уровни ошибок и выбрать несколько лидеров для более строгой проверки далее.</span></span>
<span id="cb4-267"><a href="#cb4-267" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb4-268"><a href="#cb4-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-269"><a href="#cb4-269" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.1 Пакеты и данные</span></span>
<span id="cb4-270"><a href="#cb4-270" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(mgcv, randomForest, xgboost, nnet, earth, kernlab, pls, Cubist, ranger, gbm, lattice)</span>
<span id="cb4-271"><a href="#cb4-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-272"><a href="#cb4-272" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"selected_predictors_dataset.csv"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-273"><a href="#cb4-273" aria-hidden="true" tabindex="-1"></a><span class="co"># Если YEAR отсутствует (на всякий случай), создадим</span></span>
<span id="cb4-274"><a href="#cb4-274" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="st">"YEAR"</span> <span class="sc">%in%</span> <span class="fu">names</span>(model_data)) {</span>
<span id="cb4-275"><a href="#cb4-275" aria-hidden="true" tabindex="-1"></a>  model_data<span class="sc">$</span>YEAR <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1990</span>, <span class="at">by =</span> <span class="dv">1</span>, <span class="at">length.out =</span> <span class="fu">nrow</span>(model_data))</span>
<span id="cb4-276"><a href="#cb4-276" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-277"><a href="#cb4-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-278"><a href="#cb4-278" aria-hidden="true" tabindex="-1"></a><span class="co"># Используем только предикторы и отклик (YEAR исключаем)</span></span>
<span id="cb4-279"><a href="#cb4-279" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> model_data <span class="sc">%&gt;%</span></span>
<span id="cb4-280"><a href="#cb4-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(codTSB, T12, I5, NAOspring, haddock68, R3haddock) <span class="sc">%&gt;%</span></span>
<span id="cb4-281"><a href="#cb4-281" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>()</span>
<span id="cb4-282"><a href="#cb4-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-283"><a href="#cb4-283" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.2 Holdout и CV-контроллер</span></span>
<span id="cb4-284"><a href="#cb4-284" aria-hidden="true" tabindex="-1"></a><span class="co"># Пропорция 80/20 обеспечивает внешний тест; внутри train — 5-fold CV для</span></span>
<span id="cb4-285"><a href="#cb4-285" aria-hidden="true" tabindex="-1"></a><span class="co"># корректной настройки моделей и оценки средней ошибки.</span></span>
<span id="cb4-286"><a href="#cb4-286" aria-hidden="true" tabindex="-1"></a>train_idx <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">createDataPartition</span>(model_data<span class="sc">$</span>R3haddock, <span class="at">p =</span> <span class="fl">0.8</span>, <span class="at">list =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-287"><a href="#cb4-287" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> model_data[train_idx, ]</span>
<span id="cb4-288"><a href="#cb4-288" aria-hidden="true" tabindex="-1"></a>test  <span class="ot">&lt;-</span> model_data[<span class="sc">-</span>train_idx, ]</span>
<span id="cb4-289"><a href="#cb4-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-290"><a href="#cb4-290" aria-hidden="true" tabindex="-1"></a>ctrl <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>, <span class="at">number =</span> <span class="dv">5</span>, <span class="at">savePredictions =</span> <span class="st">"final"</span>)</span>
<span id="cb4-291"><a href="#cb4-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-292"><a href="#cb4-292" aria-hidden="true" tabindex="-1"></a><span class="co"># Holdout-метод: мы делим данные на обучающую (80%) и тестовую (20%) выборки.</span></span>
<span id="cb4-293"><a href="#cb4-293" aria-hidden="true" tabindex="-1"></a><span class="co"># Кросс-валидация (5-fold CV): данные разбиваются на 5 частей, модель обучается на 4 частях и тестируется на 5-й, </span></span>
<span id="cb4-294"><a href="#cb4-294" aria-hidden="true" tabindex="-1"></a><span class="co"># и этот процесс повторяется 5 раз. Это дает более надежную оценку качества модели, чем одно разбиение. </span></span>
<span id="cb4-295"><a href="#cb4-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-296"><a href="#cb4-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-297"><a href="#cb4-297" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.3 Кастомный GAM (mgcv) для caret (bs="tp", REML, select=TRUE)</span></span>
<span id="cb4-298"><a href="#cb4-298" aria-hidden="true" tabindex="-1"></a><span class="co"># GAM даёт гладкие нелинейности по каждому признаку; REML стабилизирует оценку.</span></span>
<span id="cb4-299"><a href="#cb4-299" aria-hidden="true" tabindex="-1"></a>gam_spec <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-300"><a href="#cb4-300" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"Regression"</span>, <span class="at">library =</span> <span class="st">"mgcv"</span>, <span class="at">loop =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-301"><a href="#cb4-301" aria-hidden="true" tabindex="-1"></a>  <span class="at">parameters =</span> <span class="fu">data.frame</span>(<span class="at">parameter =</span> <span class="st">"none"</span>, <span class="at">class =</span> <span class="st">"character"</span>, <span class="at">label =</span> <span class="st">"none"</span>),</span>
<span id="cb4-302"><a href="#cb4-302" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid =</span> <span class="cf">function</span>(x,y,<span class="at">len=</span><span class="cn">NULL</span>,<span class="at">search=</span><span class="st">"grid"</span>) <span class="fu">data.frame</span>(<span class="at">none =</span> <span class="cn">NA</span>),</span>
<span id="cb4-303"><a href="#cb4-303" aria-hidden="true" tabindex="-1"></a>  <span class="at">fit =</span> <span class="cf">function</span>(x,y,...) {</span>
<span id="cb4-304"><a href="#cb4-304" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> x; df<span class="sc">$</span>R3haddock <span class="ot">&lt;-</span> y</span>
<span id="cb4-305"><a href="#cb4-305" aria-hidden="true" tabindex="-1"></a>    mgcv<span class="sc">::</span><span class="fu">gam</span>(</span>
<span id="cb4-306"><a href="#cb4-306" aria-hidden="true" tabindex="-1"></a>      R3haddock <span class="sc">~</span> <span class="fu">s</span>(codTSB,<span class="at">bs=</span><span class="st">"tp"</span>) <span class="sc">+</span> <span class="fu">s</span>(T12,<span class="at">bs=</span><span class="st">"tp"</span>) <span class="sc">+</span> <span class="fu">s</span>(I5,<span class="at">bs=</span><span class="st">"tp"</span>) <span class="sc">+</span></span>
<span id="cb4-307"><a href="#cb4-307" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">s</span>(NAOspring,<span class="at">bs=</span><span class="st">"tp"</span>) <span class="sc">+</span> <span class="fu">s</span>(haddock68,<span class="at">bs=</span><span class="st">"tp"</span>),</span>
<span id="cb4-308"><a href="#cb4-308" aria-hidden="true" tabindex="-1"></a>      <span class="at">data=</span>df, <span class="at">method=</span><span class="st">"REML"</span>, <span class="at">select=</span><span class="cn">TRUE</span>, ...</span>
<span id="cb4-309"><a href="#cb4-309" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-310"><a href="#cb4-310" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb4-311"><a href="#cb4-311" aria-hidden="true" tabindex="-1"></a>  <span class="at">predict =</span> <span class="cf">function</span>(modelFit, newdata, <span class="at">submodels =</span> <span class="cn">NULL</span>) {</span>
<span id="cb4-312"><a href="#cb4-312" aria-hidden="true" tabindex="-1"></a>    <span class="fu">predict</span>(modelFit, <span class="at">newdata =</span> newdata, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb4-313"><a href="#cb4-313" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb4-314"><a href="#cb4-314" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob =</span> <span class="cn">NULL</span>, <span class="at">sort =</span> <span class="cf">function</span>(x) x</span>
<span id="cb4-315"><a href="#cb4-315" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-316"><a href="#cb4-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-317"><a href="#cb4-317" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.4 Обучение моделей</span></span>
<span id="cb4-318"><a href="#cb4-318" aria-hidden="true" tabindex="-1"></a><span class="co"># Подсказка: разные методы по-разному чувствительны к масштабу, числу признаков</span></span>
<span id="cb4-319"><a href="#cb4-319" aria-hidden="true" tabindex="-1"></a><span class="co"># и мультиколлинеарности. Мы применяем одинаковые фолды CV для честного сравнения.</span></span>
<span id="cb4-320"><a href="#cb4-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-321"><a href="#cb4-321" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Линейная регрессия (LM)</span></span>
<span id="cb4-322"><a href="#cb4-322" aria-hidden="true" tabindex="-1"></a><span class="co"># Учебный смысл: базовая линейная модель; ориентир для сравнения.</span></span>
<span id="cb4-323"><a href="#cb4-323" aria-hidden="true" tabindex="-1"></a><span class="co"># ПОЯСНЕНИЕ: LM предполагает линейную зависимость между предикторами и откликом.</span></span>
<span id="cb4-324"><a href="#cb4-324" aria-hidden="true" tabindex="-1"></a><span class="co"># Это простая модель, которая служит "нижней планкой" - более сложные модели могут быть лучше LM. </span></span>
<span id="cb4-325"><a href="#cb4-325" aria-hidden="true" tabindex="-1"></a>lm_model    <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> train, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">trControl =</span> ctrl)</span>
<span id="cb4-326"><a href="#cb4-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-327"><a href="#cb4-327" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Обобщённая линейная модель (GLM: Gamma с лог-ссылкой)</span></span>
<span id="cb4-328"><a href="#cb4-328" aria-hidden="true" tabindex="-1"></a><span class="co"># Учебный смысл: модель для положительных откликов; допускает нелинейность в шкале log.</span></span>
<span id="cb4-329"><a href="#cb4-329" aria-hidden="true" tabindex="-1"></a><span class="co"># ПОЯСНЕНИЕ: GLM с Gamma-распределением подходит для положительных непрерывных данных </span></span>
<span id="cb4-330"><a href="#cb4-330" aria-hidden="true" tabindex="-1"></a><span class="co"># (как размер популяции), где дисперсия зависит от среднего значения.</span></span>
<span id="cb4-331"><a href="#cb4-331" aria-hidden="true" tabindex="-1"></a>glm_model   <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> train, <span class="at">method =</span> <span class="st">"glm"</span>,</span>
<span id="cb4-332"><a href="#cb4-332" aria-hidden="true" tabindex="-1"></a>                            <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">trControl =</span> ctrl)</span>
<span id="cb4-333"><a href="#cb4-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-334"><a href="#cb4-334" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Обобщённая аддитивная модель (GAM, mgcv: bs="tp", REML, select=TRUE)</span></span>
<span id="cb4-335"><a href="#cb4-335" aria-hidden="true" tabindex="-1"></a><span class="co"># Учебный смысл: гибкие гладкие нелинейности по каждому предиктору.</span></span>
<span id="cb4-336"><a href="#cb4-336" aria-hidden="true" tabindex="-1"></a><span class="co"># ПОЯСНЕНИЕ: GAM позволяет моделировать нелинейные зависимости с помощью гладких функций (splines),</span></span>
<span id="cb4-337"><a href="#cb4-337" aria-hidden="true" tabindex="-1"></a><span class="co"># сохраняя интерпретируемость отдельных эффектов. Это компромисс между простотой LM и сложностью ML.</span></span>
<span id="cb4-338"><a href="#cb4-338" aria-hidden="true" tabindex="-1"></a>gam_model   <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(<span class="at">x =</span> train[, <span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(train)<span class="sc">==</span><span class="st">"R3haddock"</span>)],</span>
<span id="cb4-339"><a href="#cb4-339" aria-hidden="true" tabindex="-1"></a>                            <span class="at">y =</span> train<span class="sc">$</span>R3haddock, <span class="at">method =</span> gam_spec, <span class="at">trControl =</span> ctrl)</span>
<span id="cb4-340"><a href="#cb4-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-341"><a href="#cb4-341" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4. Random Forest (rf: ntree=1000, mtry=1)</span></span>
<span id="cb4-342"><a href="#cb4-342" aria-hidden="true" tabindex="-1"></a><span class="co"># Учебный смысл: ансамбль деревьев; устойчив к шуму; нелинейности/взаимодействия "из коробки".</span></span>
<span id="cb4-343"><a href="#cb4-343" aria-hidden="true" tabindex="-1"></a><span class="co"># ПОЯСНЕНИЕ: Random Forest строит множество деревьев решений и усредняет их результаты.</span></span>
<span id="cb4-344"><a href="#cb4-344" aria-hidden="true" tabindex="-1"></a><span class="co"># Это мощный метод, который автоматически улавливает нелинейные зависимости и взаимодействия. </span></span>
<span id="cb4-345"><a href="#cb4-345" aria-hidden="true" tabindex="-1"></a>rf_model    <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> train, <span class="at">method =</span> <span class="st">"rf"</span>, <span class="at">trControl =</span> ctrl,</span>
<span id="cb4-346"><a href="#cb4-346" aria-hidden="true" tabindex="-1"></a>                            <span class="at">ntree =</span> <span class="dv">1000</span>, <span class="at">tuneGrid =</span> <span class="fu">data.frame</span>(<span class="at">mtry =</span> <span class="dv">1</span>), <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-347"><a href="#cb4-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-348"><a href="#cb4-348" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 5. XGBoost (xgbTree) </span></span>
<span id="cb4-349"><a href="#cb4-349" aria-hidden="true" tabindex="-1"></a><span class="co"># Учебный смысл: бустинг деревьев; сильная ML-модель, легко переобучается без валидации.</span></span>
<span id="cb4-350"><a href="#cb4-350" aria-hidden="true" tabindex="-1"></a><span class="co"># ПОЯСНЕНИЕ: XGBoost - это градиентный бустинг над деревьями решений, который последовательно </span></span>
<span id="cb4-351"><a href="#cb4-351" aria-hidden="true" tabindex="-1"></a><span class="co"># строит деревья, исправляя ошибки предыдущих. Требует тщательной настройки параметров.</span></span>
<span id="cb4-352"><a href="#cb4-352" aria-hidden="true" tabindex="-1"></a>xgb_grid    <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">nrounds=</span><span class="dv">100</span>, <span class="at">max_depth=</span><span class="dv">4</span>, <span class="at">eta=</span><span class="fl">0.1</span>, <span class="at">gamma=</span><span class="dv">0</span>,</span>
<span id="cb4-353"><a href="#cb4-353" aria-hidden="true" tabindex="-1"></a>                           <span class="at">colsample_bytree=</span><span class="fl">0.8</span>, <span class="at">min_child_weight=</span><span class="dv">1</span>, <span class="at">subsample=</span><span class="fl">0.8</span>)</span>
<span id="cb4-354"><a href="#cb4-354" aria-hidden="true" tabindex="-1"></a>xgb_model   <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> train, <span class="at">method =</span> <span class="st">"xgbTree"</span>,</span>
<span id="cb4-355"><a href="#cb4-355" aria-hidden="true" tabindex="-1"></a>                            <span class="at">trControl =</span> ctrl, <span class="at">tuneGrid =</span> xgb_grid, <span class="at">verbose =</span> <span class="dv">0</span>)</span>
<span id="cb4-356"><a href="#cb4-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-357"><a href="#cb4-357" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 6. Нейросеть (MLP, nnet: линейный выход, стандартизация)</span></span>
<span id="cb4-358"><a href="#cb4-358" aria-hidden="true" tabindex="-1"></a><span class="co"># Учебный смысл: универсальный аппроксиматор; чувствителен к масштабу; требует регуляризации.</span></span>
<span id="cb4-359"><a href="#cb4-359" aria-hidden="true" tabindex="-1"></a><span class="co"># ПОЯСНЕНИЕ: Нейронные сети могут моделировать сложные нелинейные отношения. </span></span>
<span id="cb4-360"><a href="#cb4-360" aria-hidden="true" tabindex="-1"></a><span class="co"># Используемая архитектура (1 скрытый слой) - компромисс между гибкостью и риском переобучения.</span></span>
<span id="cb4-361"><a href="#cb4-361" aria-hidden="true" tabindex="-1"></a><span class="co"># Линейный выходной слой подходит для регрессии.</span></span>
<span id="cb4-362"><a href="#cb4-362" aria-hidden="true" tabindex="-1"></a>nnet_model  <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> train, <span class="at">method =</span> <span class="st">"nnet"</span>,</span>
<span id="cb4-363"><a href="#cb4-363" aria-hidden="true" tabindex="-1"></a>                            <span class="at">trControl =</span> ctrl, <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">"center"</span>,<span class="st">"scale"</span>),</span>
<span id="cb4-364"><a href="#cb4-364" aria-hidden="true" tabindex="-1"></a>                            <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(<span class="at">size =</span> <span class="dv">5</span>, <span class="at">decay =</span> <span class="fl">0.1</span>),</span>
<span id="cb4-365"><a href="#cb4-365" aria-hidden="true" tabindex="-1"></a>                            <span class="at">linout =</span> <span class="cn">TRUE</span>, <span class="at">trace =</span> <span class="cn">FALSE</span>, <span class="at">MaxNWts =</span> <span class="dv">5000</span>)</span>
<span id="cb4-366"><a href="#cb4-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-367"><a href="#cb4-367" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 7. Elastic Net (glmnet)</span></span>
<span id="cb4-368"><a href="#cb4-368" aria-hidden="true" tabindex="-1"></a><span class="co"># Учебный смысл: регуляризация (L1/L2), борьба с мультиколлинеарностью, частичный отбор признаков.</span></span>
<span id="cb4-369"><a href="#cb4-369" aria-hidden="true" tabindex="-1"></a><span class="co"># ПОЯСНЕНИЕ: Комбинирует L1 (лассо) и L2 (ридж) регуляризации. Автоматически отбирает признаки </span></span>
<span id="cb4-370"><a href="#cb4-370" aria-hidden="true" tabindex="-1"></a><span class="co"># и уменьшает влияние мультиколлинеарности. Параметр alpha балансирует между лассо и риджем.</span></span>
<span id="cb4-371"><a href="#cb4-371" aria-hidden="true" tabindex="-1"></a>glmnet_model<span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> train, <span class="at">method =</span> <span class="st">"glmnet"</span>,</span>
<span id="cb4-372"><a href="#cb4-372" aria-hidden="true" tabindex="-1"></a>                            <span class="at">trControl =</span> ctrl, <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">"center"</span>,<span class="st">"scale"</span>), <span class="at">tuneLength =</span> <span class="dv">10</span>)</span>
<span id="cb4-373"><a href="#cb4-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-374"><a href="#cb4-374" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 8. MARS (earth)</span></span>
<span id="cb4-375"><a href="#cb4-375" aria-hidden="true" tabindex="-1"></a><span class="co"># Учебный смысл: кусочно-линейные сплайны + простые взаимодействия; гибкая интерпретация.</span></span>
<span id="cb4-376"><a href="#cb4-376" aria-hidden="true" tabindex="-1"></a><span class="co"># ПОЯСНЕНИЕ: Многомерные адаптивные регрессионные сплайны (MARS) строят кусочно-линейные модели </span></span>
<span id="cb4-377"><a href="#cb4-377" aria-hidden="true" tabindex="-1"></a><span class="co"># с автоматическим выбором точек излома. Поддерживает взаимодействия ограниченного порядка.</span></span>
<span id="cb4-378"><a href="#cb4-378" aria-hidden="true" tabindex="-1"></a>earth_model <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> train, <span class="at">method =</span> <span class="st">"earth"</span>,</span>
<span id="cb4-379"><a href="#cb4-379" aria-hidden="true" tabindex="-1"></a>                            <span class="at">trControl =</span> ctrl, <span class="at">tuneLength =</span> <span class="dv">10</span>)</span>
<span id="cb4-380"><a href="#cb4-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-381"><a href="#cb4-381" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 9. SVM с радиальным ядром (svmRadial)</span></span>
<span id="cb4-382"><a href="#cb4-382" aria-hidden="true" tabindex="-1"></a><span class="co"># Учебный смысл: ядровой метод; улавливает сложные нелинейности; важна стандартизация.</span></span>
<span id="cb4-383"><a href="#cb4-383" aria-hidden="true" tabindex="-1"></a><span class="co"># ПОЯСНЕНИЕ: Метод опорных векторов с радиальным ядром проецирует данные в пространство </span></span>
<span id="cb4-384"><a href="#cb4-384" aria-hidden="true" tabindex="-1"></a><span class="co"># высокой размерности, где становится возможным линейное разделение. Параметр gamma управляет </span></span>
<span id="cb4-385"><a href="#cb4-385" aria-hidden="true" tabindex="-1"></a><span class="co"># гибкостью границы решения.</span></span>
<span id="cb4-386"><a href="#cb4-386" aria-hidden="true" tabindex="-1"></a>svm_model   <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> train, <span class="at">method =</span> <span class="st">"svmRadial"</span>,</span>
<span id="cb4-387"><a href="#cb4-387" aria-hidden="true" tabindex="-1"></a>                            <span class="at">trControl =</span> ctrl, <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">"center"</span>,<span class="st">"scale"</span>), <span class="at">tuneLength =</span> <span class="dv">8</span>)</span>
<span id="cb4-388"><a href="#cb4-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-389"><a href="#cb4-389" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 10. k-ближайших соседей (kNN)</span></span>
<span id="cb4-390"><a href="#cb4-390" aria-hidden="true" tabindex="-1"></a><span class="co"># Учебный смысл: простая интуитивная нелинейная модель на расстояниях; чувствительна к масштабу.</span></span>
<span id="cb4-391"><a href="#cb4-391" aria-hidden="true" tabindex="-1"></a><span class="co"># ПОЯСНЕНИЕ: Предсказание основано на усреднении значений k ближайших наблюдений. </span></span>
<span id="cb4-392"><a href="#cb4-392" aria-hidden="true" tabindex="-1"></a><span class="co"># Требует вычисления попарных расстояний, что может быть ресурсоемким при больших данных.</span></span>
<span id="cb4-393"><a href="#cb4-393" aria-hidden="true" tabindex="-1"></a>knn_model   <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> train, <span class="at">method =</span> <span class="st">"knn"</span>,</span>
<span id="cb4-394"><a href="#cb4-394" aria-hidden="true" tabindex="-1"></a>                            <span class="at">trControl =</span> ctrl, <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">"center"</span>,<span class="st">"scale"</span>), <span class="at">tuneLength =</span> <span class="dv">15</span>)</span>
<span id="cb4-395"><a href="#cb4-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-396"><a href="#cb4-396" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 11. Ranger (быстрый Random Forest)</span></span>
<span id="cb4-397"><a href="#cb4-397" aria-hidden="true" tabindex="-1"></a><span class="co"># Учебный смысл: альтернативная/быстрая реализация леса; сравнить с randomForest.</span></span>
<span id="cb4-398"><a href="#cb4-398" aria-hidden="true" tabindex="-1"></a><span class="co"># ПОЯСНЕНИЕ: Оптимизированная реализация Random Forest на C++. Поддерживает распараллеливание </span></span>
<span id="cb4-399"><a href="#cb4-399" aria-hidden="true" tabindex="-1"></a><span class="co"># и эффективную работу с категориальными переменными. Важен параметр mtry (число признаков в узле).</span></span>
<span id="cb4-400"><a href="#cb4-400" aria-hidden="true" tabindex="-1"></a>ranger_model<span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> train, <span class="at">method =</span> <span class="st">"ranger"</span>,</span>
<span id="cb4-401"><a href="#cb4-401" aria-hidden="true" tabindex="-1"></a>                            <span class="at">trControl =</span> ctrl, <span class="at">tuneLength =</span> <span class="dv">3</span>, <span class="at">importance =</span> <span class="st">"impurity"</span>)</span>
<span id="cb4-402"><a href="#cb4-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-403"><a href="#cb4-403" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 12. GBM (классический градиентный бустинг)</span></span>
<span id="cb4-404"><a href="#cb4-404" aria-hidden="true" tabindex="-1"></a><span class="co"># Учебный смысл: другой бустинг деревьев; полезно сравнить с XGBoost.</span></span>
<span id="cb4-405"><a href="#cb4-405" aria-hidden="true" tabindex="-1"></a><span class="co"># ПОЯСНЕНИЕ: Градиентный бустинг строит деревья последовательно, где каждое новое дерево </span></span>
<span id="cb4-406"><a href="#cb4-406" aria-hidden="true" tabindex="-1"></a><span class="co"># корректирует ошибки предыдущих. Параметр shrinkage (темп обучения) контролирует скорость обучения.</span></span>
<span id="cb4-407"><a href="#cb4-407" aria-hidden="true" tabindex="-1"></a>gbm_model   <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> train, <span class="at">method =</span> <span class="st">"gbm"</span>,</span>
<span id="cb4-408"><a href="#cb4-408" aria-hidden="true" tabindex="-1"></a>                            <span class="at">trControl =</span> ctrl,</span>
<span id="cb4-409"><a href="#cb4-409" aria-hidden="true" tabindex="-1"></a>                            <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(<span class="at">n.trees=</span><span class="dv">100</span>, <span class="at">interaction.depth=</span><span class="dv">1</span>,</span>
<span id="cb4-410"><a href="#cb4-410" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">shrinkage=</span><span class="fl">0.1</span>, <span class="at">n.minobsinnode=</span><span class="dv">2</span>),</span>
<span id="cb4-411"><a href="#cb4-411" aria-hidden="true" tabindex="-1"></a>                            <span class="at">distribution =</span> <span class="st">"gaussian"</span>, <span class="at">bag.fraction =</span> <span class="dv">1</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-412"><a href="#cb4-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-413"><a href="#cb4-413" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 13. PLS (Partial Least Squares)</span></span>
<span id="cb4-414"><a href="#cb4-414" aria-hidden="true" tabindex="-1"></a><span class="co"># Учебный смысл: проекция на скрытые компоненты с учетом отклика; решает мультиколлинеарность.</span></span>
<span id="cb4-415"><a href="#cb4-415" aria-hidden="true" tabindex="-1"></a><span class="co"># ПОЯСНЕНИЕ: Частные наименьшие квадраты (PLS) проецируют предикторы в латентное пространство, </span></span>
<span id="cb4-416"><a href="#cb4-416" aria-hidden="true" tabindex="-1"></a><span class="co"># максимизируя ковариацию с откликом. Эффективен при высокой корреляции признаков.</span></span>
<span id="cb4-417"><a href="#cb4-417" aria-hidden="true" tabindex="-1"></a>pls_model   <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> train, <span class="at">method =</span> <span class="st">"pls"</span>,</span>
<span id="cb4-418"><a href="#cb4-418" aria-hidden="true" tabindex="-1"></a>                            <span class="at">trControl =</span> ctrl, <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">"center"</span>,<span class="st">"scale"</span>), <span class="at">tuneLength =</span> <span class="dv">10</span>)</span>
<span id="cb4-419"><a href="#cb4-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-420"><a href="#cb4-420" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 14. Cubist (правила + деревья)</span></span>
<span id="cb4-421"><a href="#cb4-421" aria-hidden="true" tabindex="-1"></a><span class="co"># Учебный смысл: интерпретируемые правила с комитетами; часто силен на табличных данных.</span></span>
<span id="cb4-422"><a href="#cb4-422" aria-hidden="true" tabindex="-1"></a><span class="co"># ПОЯСНЕНИЕ: Cubist объединяет деревья решений с линейными моделями в листьях. Генерирует </span></span>
<span id="cb4-423"><a href="#cb4-423" aria-hidden="true" tabindex="-1"></a><span class="co"># набор правил "если-то", что улучшает интерпретируемость. Комитеты (комитеты) уменьшают дисперсию.</span></span>
<span id="cb4-424"><a href="#cb4-424" aria-hidden="true" tabindex="-1"></a>cubist_model<span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(R3haddock <span class="sc">~</span> ., <span class="at">data =</span> train, <span class="at">method =</span> <span class="st">"cubist"</span>,</span>
<span id="cb4-425"><a href="#cb4-425" aria-hidden="true" tabindex="-1"></a>                            <span class="at">trControl =</span> ctrl, <span class="at">tuneLength =</span> <span class="dv">5</span>)</span>
<span id="cb4-426"><a href="#cb4-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-427"><a href="#cb4-427" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.5 Метрики и оценка на тесте</span></span>
<span id="cb4-428"><a href="#cb4-428" aria-hidden="true" tabindex="-1"></a><span class="co"># Замечание: RMSE/MAE — абсолютные ошибки; R2 — доля объяснённой вариации;</span></span>
<span id="cb4-429"><a href="#cb4-429" aria-hidden="true" tabindex="-1"></a><span class="co"># MAPE/sMAPE — относительные ошибки (осторожно при малых значениях отклика).</span></span>
<span id="cb4-430"><a href="#cb4-430" aria-hidden="true" tabindex="-1"></a>rmse  <span class="ot">&lt;-</span> <span class="cf">function</span>(a, p) <span class="fu">sqrt</span>(<span class="fu">mean</span>((a <span class="sc">-</span> p)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-431"><a href="#cb4-431" aria-hidden="true" tabindex="-1"></a>mae   <span class="ot">&lt;-</span> <span class="cf">function</span>(a, p) <span class="fu">mean</span>(<span class="fu">abs</span>(a <span class="sc">-</span> p), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-432"><a href="#cb4-432" aria-hidden="true" tabindex="-1"></a>r2    <span class="ot">&lt;-</span> <span class="cf">function</span>(a, p) <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>((a <span class="sc">-</span> p)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sum</span>((a <span class="sc">-</span> <span class="fu">mean</span>(a))<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-433"><a href="#cb4-433" aria-hidden="true" tabindex="-1"></a>mape  <span class="ot">&lt;-</span> <span class="cf">function</span>(a, p) <span class="fu">mean</span>(<span class="fu">abs</span>((a <span class="sc">-</span> p) <span class="sc">/</span> a), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb4-434"><a href="#cb4-434" aria-hidden="true" tabindex="-1"></a>smape <span class="ot">&lt;-</span> <span class="cf">function</span>(a, p) <span class="fu">mean</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="fu">abs</span>(p <span class="sc">-</span> a) <span class="sc">/</span> (<span class="fu">abs</span>(a) <span class="sc">+</span> <span class="fu">abs</span>(p)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb4-435"><a href="#cb4-435" aria-hidden="true" tabindex="-1"></a>metrics_vec <span class="ot">&lt;-</span> <span class="cf">function</span>(y, pred) <span class="fu">c</span>(<span class="at">RMSE=</span><span class="fu">rmse</span>(y,pred), <span class="at">MAE=</span><span class="fu">mae</span>(y,pred), <span class="at">R2=</span><span class="fu">r2</span>(y,pred),</span>
<span id="cb4-436"><a href="#cb4-436" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">MAPE=</span><span class="fu">mape</span>(y,pred), <span class="at">sMAPE=</span><span class="fu">smape</span>(y,pred))</span>
<span id="cb4-437"><a href="#cb4-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-438"><a href="#cb4-438" aria-hidden="true" tabindex="-1"></a><span class="co"># Для оценки качества моделей мы используем несколько метрик:</span></span>
<span id="cb4-439"><a href="#cb4-439" aria-hidden="true" tabindex="-1"></a><span class="co">#   - RMSE (Root Mean Square Error): среднеквадратичная ошибка (чувствительна к выбросам)</span></span>
<span id="cb4-440"><a href="#cb4-440" aria-hidden="true" tabindex="-1"></a><span class="co">#   - MAE (Mean Absolute Error): средняя абсолютная ошибка (более интерпретируема)</span></span>
<span id="cb4-441"><a href="#cb4-441" aria-hidden="true" tabindex="-1"></a><span class="co">#   - R²: коэффициент детерминации (доля объясненной дисперсии)</span></span>
<span id="cb4-442"><a href="#cb4-442" aria-hidden="true" tabindex="-1"></a><span class="co">#   - MAPE: средняя абсолютная процентная ошибка (в процентах от фактического значения)</span></span>
<span id="cb4-443"><a href="#cb4-443" aria-hidden="true" tabindex="-1"></a><span class="co">#   - sMAPE: симметричная MAPE (устраняет проблему деления на ноль) </span></span>
<span id="cb4-444"><a href="#cb4-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-445"><a href="#cb4-445" aria-hidden="true" tabindex="-1"></a>y_test <span class="ot">&lt;-</span> test<span class="sc">$</span>R3haddock</span>
<span id="cb4-446"><a href="#cb4-446" aria-hidden="true" tabindex="-1"></a>preds_test <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-447"><a href="#cb4-447" aria-hidden="true" tabindex="-1"></a>  <span class="at">LM=</span><span class="fu">predict</span>(lm_model,test), <span class="at">GLM=</span><span class="fu">predict</span>(glm_model,test), <span class="at">GAM=</span><span class="fu">predict</span>(gam_model,test),</span>
<span id="cb4-448"><a href="#cb4-448" aria-hidden="true" tabindex="-1"></a>  <span class="at">RF=</span><span class="fu">predict</span>(rf_model,test), <span class="at">XGB=</span><span class="fu">predict</span>(xgb_model,test), <span class="at">NNET=</span><span class="fu">predict</span>(nnet_model,test),</span>
<span id="cb4-449"><a href="#cb4-449" aria-hidden="true" tabindex="-1"></a>  <span class="at">ENet=</span><span class="fu">predict</span>(glmnet_model,test), <span class="at">MARS=</span><span class="fu">predict</span>(earth_model,test), <span class="at">SVM=</span><span class="fu">predict</span>(svm_model,test),</span>
<span id="cb4-450"><a href="#cb4-450" aria-hidden="true" tabindex="-1"></a>  <span class="at">kNN=</span><span class="fu">predict</span>(knn_model,test), <span class="at">RANGER=</span><span class="fu">predict</span>(ranger_model,test), <span class="at">GBM=</span><span class="fu">predict</span>(gbm_model,test),</span>
<span id="cb4-451"><a href="#cb4-451" aria-hidden="true" tabindex="-1"></a>  <span class="at">PLS=</span><span class="fu">predict</span>(pls_model,test), <span class="at">CUBIST=</span><span class="fu">predict</span>(cubist_model,test)</span>
<span id="cb4-452"><a href="#cb4-452" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-453"><a href="#cb4-453" aria-hidden="true" tabindex="-1"></a>metrics_table <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="fu">names</span>(preds_test), <span class="cf">function</span>(nm){</span>
<span id="cb4-454"><a href="#cb4-454" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Model =</span> nm, <span class="fu">t</span>(<span class="fu">metrics_vec</span>(y_test, preds_test[[nm]])), <span class="at">row.names =</span> <span class="cn">NULL</span>)</span>
<span id="cb4-455"><a href="#cb4-455" aria-hidden="true" tabindex="-1"></a>})) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(RMSE, MAE)</span>
<span id="cb4-456"><a href="#cb4-456" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">round</span>(metrics_table, <span class="dv">2</span>))</span>
<span id="cb4-457"><a href="#cb4-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-458"><a href="#cb4-458" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb4-459"><a href="#cb4-459" aria-hidden="true" tabindex="-1"></a>  metrics_table <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(.x, <span class="dv">2</span>))),</span>
<span id="cb4-460"><a href="#cb4-460" aria-hidden="true" tabindex="-1"></a>  <span class="at">caption =</span> <span class="st">"Holdout-метрики (округлено до 2 знаков)"</span></span>
<span id="cb4-461"><a href="#cb4-461" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-462"><a href="#cb4-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-463"><a href="#cb4-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-464"><a href="#cb4-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-465"><a href="#cb4-465" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.6 CV-резюме</span></span>
<span id="cb4-466"><a href="#cb4-466" aria-hidden="true" tabindex="-1"></a><span class="co"># Сводим результаты CV по всем моделям и смотрим распределения ошибок.</span></span>
<span id="cb4-467"><a href="#cb4-467" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">resamples</span>(<span class="fu">list</span>(</span>
<span id="cb4-468"><a href="#cb4-468" aria-hidden="true" tabindex="-1"></a>  <span class="at">LM=</span>lm_model, <span class="at">GLM=</span>glm_model, <span class="at">GAM=</span>gam_model, <span class="at">RF=</span>rf_model, <span class="at">XGB=</span>xgb_model, <span class="at">NNET=</span>nnet_model,</span>
<span id="cb4-469"><a href="#cb4-469" aria-hidden="true" tabindex="-1"></a>  <span class="at">ENet=</span>glmnet_model, <span class="at">MARS=</span>earth_model, <span class="at">SVM=</span>svm_model, <span class="at">kNN=</span>knn_model, <span class="at">RANGER=</span>ranger_model,</span>
<span id="cb4-470"><a href="#cb4-470" aria-hidden="true" tabindex="-1"></a>  <span class="at">GBM=</span>gbm_model, <span class="at">PLS=</span>pls_model, <span class="at">CUBIST=</span>cubist_model</span>
<span id="cb4-471"><a href="#cb4-471" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb4-472"><a href="#cb4-472" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(results)</span>
<span id="cb4-473"><a href="#cb4-473" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">dotplot</span>(results, <span class="at">metric =</span> <span class="st">"RMSE"</span>)</span>
<span id="cb4-474"><a href="#cb4-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-475"><a href="#cb4-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-476"><a href="#cb4-476" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb4-477"><a href="#cb4-477" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) ВЫБОР ЛУЧШЕЙ ПРОГНОСТИЧЕСКОЙ МОДЕЛИ (TIME-SLICE CV НА 3 ГОДА + ХРОНО-ТЕСТ)</span></span>
<span id="cb4-478"><a href="#cb4-478" aria-hidden="true" tabindex="-1"></a><span class="co"># Делим последние годы в тест, внутри train — скользящее окно, h=3.</span></span>
<span id="cb4-479"><a href="#cb4-479" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------------------</span></span>
<span id="cb4-480"><a href="#cb4-480" aria-hidden="true" tabindex="-1"></a><span class="co"># Почему time-slice: временные данные нельзя случайно перемешивать, иначе мы</span></span>
<span id="cb4-481"><a href="#cb4-481" aria-hidden="true" tabindex="-1"></a><span class="co"># «подсматриваем в будущее». Создаём серии обучающих/валидационных окон,</span></span>
<span id="cb4-482"><a href="#cb4-482" aria-hidden="true" tabindex="-1"></a><span class="co"># увеличивая тренировочный период, и тестируем на ближайшем горизонте (3 года).</span></span>
<span id="cb4-483"><a href="#cb4-483" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb4-484"><a href="#cb4-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-485"><a href="#cb4-485" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.1 Данные для time-slice (с YEAR)</span></span>
<span id="cb4-486"><a href="#cb4-486" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"selected_predictors_dataset.csv"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-487"><a href="#cb4-487" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="st">"YEAR"</span> <span class="sc">%in%</span> <span class="fu">names</span>(model_data)) {</span>
<span id="cb4-488"><a href="#cb4-488" aria-hidden="true" tabindex="-1"></a>  model_data<span class="sc">$</span>YEAR <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1990</span>, <span class="at">by =</span> <span class="dv">1</span>, <span class="at">length.out =</span> <span class="fu">nrow</span>(model_data))</span>
<span id="cb4-489"><a href="#cb4-489" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-490"><a href="#cb4-490" aria-hidden="true" tabindex="-1"></a><span class="co"># Хронологический порядок</span></span>
<span id="cb4-491"><a href="#cb4-491" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> model_data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(YEAR)</span>
<span id="cb4-492"><a href="#cb4-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-493"><a href="#cb4-493" aria-hidden="true" tabindex="-1"></a><span class="co"># Для временных рядов обычные методы кросс-валидации (случайное разбиение) неприменимы,</span></span>
<span id="cb4-494"><a href="#cb4-494" aria-hidden="true" tabindex="-1"></a><span class="co"># так как это приведет к утечке информации из будущего в прошлое. [[1]]</span></span>
<span id="cb4-495"><a href="#cb4-495" aria-hidden="true" tabindex="-1"></a><span class="co"># Time-slice CV (скользящее окно) имитирует реальную ситуацию прогнозирования:</span></span>
<span id="cb4-496"><a href="#cb4-496" aria-hidden="true" tabindex="-1"></a><span class="co">#   - Мы обучаемся на данных из прошлого</span></span>
<span id="cb4-497"><a href="#cb4-497" aria-hidden="true" tabindex="-1"></a><span class="co">#   - Прогнозируем на несколько шагов вперед</span></span>
<span id="cb4-498"><a href="#cb4-498" aria-hidden="true" tabindex="-1"></a><span class="co">#   - Последовательно сдвигаем окно обучения вперед</span></span>
<span id="cb4-499"><a href="#cb4-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-500"><a href="#cb4-500" aria-hidden="true" tabindex="-1"></a><span class="co"># Исходные фичи (исключаем YEAR)</span></span>
<span id="cb4-501"><a href="#cb4-501" aria-hidden="true" tabindex="-1"></a>md_for_fit <span class="ot">&lt;-</span> model_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(codTSB, T12, I5, NAOspring, haddock68, R3haddock)</span>
<span id="cb4-502"><a href="#cb4-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-503"><a href="#cb4-503" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.2 Хронологический holdout (последние годы)</span></span>
<span id="cb4-504"><a href="#cb4-504" aria-hidden="true" tabindex="-1"></a><span class="co"># Идея: отложим ~20% последних лет как полностью внешний тест будущего качества.</span></span>
<span id="cb4-505"><a href="#cb4-505" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(md_for_fit)</span>
<span id="cb4-506"><a href="#cb4-506" aria-hidden="true" tabindex="-1"></a>holdout_frac <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb4-507"><a href="#cb4-507" aria-hidden="true" tabindex="-1"></a>n_test <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">4</span>, <span class="fu">ceiling</span>(n <span class="sc">*</span> holdout_frac))</span>
<span id="cb4-508"><a href="#cb4-508" aria-hidden="true" tabindex="-1"></a>train_ts <span class="ot">&lt;-</span> <span class="fu">head</span>(md_for_fit, n <span class="sc">-</span> n_test)</span>
<span id="cb4-509"><a href="#cb4-509" aria-hidden="true" tabindex="-1"></a>test_ts  <span class="ot">&lt;-</span> <span class="fu">tail</span>(md_for_fit, n_test)</span>
<span id="cb4-510"><a href="#cb4-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-511"><a href="#cb4-511" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.3 Time-slice CV (h=3, expanding window рекомендован: fixedWindow=FALSE)</span></span>
<span id="cb4-512"><a href="#cb4-512" aria-hidden="true" tabindex="-1"></a><span class="co"># initialWindow — размер первого «обучающего» фрагмента; horizon — горизонт</span></span>
<span id="cb4-513"><a href="#cb4-513" aria-hidden="true" tabindex="-1"></a><span class="co"># валидации (здесь 3 года). Далее окно расширяется.</span></span>
<span id="cb4-514"><a href="#cb4-514" aria-hidden="true" tabindex="-1"></a>n_train <span class="ot">&lt;-</span> <span class="fu">nrow</span>(train_ts)</span>
<span id="cb4-515"><a href="#cb4-515" aria-hidden="true" tabindex="-1"></a>initial_frac <span class="ot">&lt;-</span> <span class="fl">0.6</span></span>
<span id="cb4-516"><a href="#cb4-516" aria-hidden="true" tabindex="-1"></a>horizon      <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb4-517"><a href="#cb4-517" aria-hidden="true" tabindex="-1"></a>initialWindow <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">10</span>, <span class="fu">floor</span>(initial_frac <span class="sc">*</span> n_train))</span>
<span id="cb4-518"><a href="#cb4-518" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (initialWindow <span class="sc">+</span> horizon <span class="sc">&gt;</span> n_train) initialWindow <span class="ot">&lt;-</span> n_train <span class="sc">-</span> horizon</span>
<span id="cb4-519"><a href="#cb4-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-520"><a href="#cb4-520" aria-hidden="true" tabindex="-1"></a>slices <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">createTimeSlices</span>(<span class="dv">1</span><span class="sc">:</span>n_train, <span class="at">initialWindow =</span> initialWindow,</span>
<span id="cb4-521"><a href="#cb4-521" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">horizon =</span> horizon, <span class="at">fixedWindow =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-522"><a href="#cb4-522" aria-hidden="true" tabindex="-1"></a>ctrl_ts <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>, <span class="at">index =</span> slices<span class="sc">$</span>train, <span class="at">indexOut =</span> slices<span class="sc">$</span>test,</span>
<span id="cb4-523"><a href="#cb4-523" aria-hidden="true" tabindex="-1"></a>                               <span class="at">savePredictions =</span> <span class="st">"final"</span>)</span>
<span id="cb4-524"><a href="#cb4-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-525"><a href="#cb4-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-526"><a href="#cb4-526" aria-hidden="true" tabindex="-1"></a><span class="co"># В нашем случае:</span></span>
<span id="cb4-527"><a href="#cb4-527" aria-hidden="true" tabindex="-1"></a><span class="co">#   - horizon = 3: прогнозируем на 3 года вперед</span></span>
<span id="cb4-528"><a href="#cb4-528" aria-hidden="true" tabindex="-1"></a><span class="co">#   - expanding window: размер обучающей выборки увеличивается с каждым шагом</span></span>
<span id="cb4-529"><a href="#cb4-529" aria-hidden="true" tabindex="-1"></a><span class="co">#   - initialWindow: начальный размер обучающей выборки (60% от данных)</span></span>
<span id="cb4-530"><a href="#cb4-530" aria-hidden="true" tabindex="-1"></a><span class="co"># Этот подход наиболее реалистичен для задач прогнозирования временных рядов в гидробиологии.</span></span>
<span id="cb4-531"><a href="#cb4-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-532"><a href="#cb4-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-533"><a href="#cb4-533" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.4 Обучение (ядро набора, без GBM — он нестабилен на малом n в timeslice)</span></span>
<span id="cb4-534"><a href="#cb4-534" aria-hidden="true" tabindex="-1"></a><span class="co"># Примечание: используем ту же рецептуру, что и в базовом сравнении, но с</span></span>
<span id="cb4-535"><a href="#cb4-535" aria-hidden="true" tabindex="-1"></a><span class="co"># хронологическими срезами.</span></span>
<span id="cb4-536"><a href="#cb4-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-537"><a href="#cb4-537" aria-hidden="true" tabindex="-1"></a>fit_ts <span class="ot">&lt;-</span> <span class="cf">function</span>(method, form, data, ctrl, ...) {</span>
<span id="cb4-538"><a href="#cb4-538" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">try</span>(caret<span class="sc">::</span><span class="fu">train</span>(form, <span class="at">data =</span> data, <span class="at">method =</span> method, <span class="at">trControl =</span> ctrl, ...), <span class="cn">TRUE</span>)</span>
<span id="cb4-539"><a href="#cb4-539" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">inherits</span>(out,<span class="st">"try-error"</span>)) <span class="cn">NULL</span> <span class="cf">else</span> out</span>
<span id="cb4-540"><a href="#cb4-540" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-541"><a href="#cb4-541" aria-hidden="true" tabindex="-1"></a>lm_ts   <span class="ot">&lt;-</span> <span class="fu">fit_ts</span>(<span class="st">"lm"</span>,        R3haddock <span class="sc">~</span> ., train_ts, ctrl_ts)</span>
<span id="cb4-542"><a href="#cb4-542" aria-hidden="true" tabindex="-1"></a>glm_ts  <span class="ot">&lt;-</span> <span class="fu">fit_ts</span>(<span class="st">"glm"</span>,       R3haddock <span class="sc">~</span> ., train_ts, ctrl_ts, <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link=</span><span class="st">"log"</span>))</span>
<span id="cb4-543"><a href="#cb4-543" aria-hidden="true" tabindex="-1"></a>gam_ts  <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(<span class="at">x =</span> train_ts[, <span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(train_ts)<span class="sc">==</span><span class="st">"R3haddock"</span>)],</span>
<span id="cb4-544"><a href="#cb4-544" aria-hidden="true" tabindex="-1"></a>                        <span class="at">y =</span> train_ts<span class="sc">$</span>R3haddock, <span class="at">method =</span> gam_spec, <span class="at">trControl =</span> ctrl_ts)</span>
<span id="cb4-545"><a href="#cb4-545" aria-hidden="true" tabindex="-1"></a>rf_ts   <span class="ot">&lt;-</span> <span class="fu">fit_ts</span>(<span class="st">"rf"</span>,        R3haddock <span class="sc">~</span> ., train_ts, ctrl_ts, <span class="at">ntree=</span><span class="dv">1000</span>, <span class="at">tuneGrid=</span><span class="fu">data.frame</span>(<span class="at">mtry=</span><span class="dv">1</span>))</span>
<span id="cb4-546"><a href="#cb4-546" aria-hidden="true" tabindex="-1"></a>xgb_ts  <span class="ot">&lt;-</span> <span class="fu">fit_ts</span>(<span class="st">"xgbTree"</span>,   R3haddock <span class="sc">~</span> ., train_ts, ctrl_ts, <span class="at">tuneGrid =</span> xgb_grid, <span class="at">verbose =</span> <span class="dv">0</span>)</span>
<span id="cb4-547"><a href="#cb4-547" aria-hidden="true" tabindex="-1"></a>rgr_ts  <span class="ot">&lt;-</span> <span class="fu">fit_ts</span>(<span class="st">"ranger"</span>,    R3haddock <span class="sc">~</span> ., train_ts, ctrl_ts, <span class="at">tuneLength=</span><span class="dv">3</span>)</span>
<span id="cb4-548"><a href="#cb4-548" aria-hidden="true" tabindex="-1"></a>nnet_ts <span class="ot">&lt;-</span> <span class="fu">fit_ts</span>(<span class="st">"nnet"</span>,      R3haddock <span class="sc">~</span> ., train_ts, ctrl_ts,</span>
<span id="cb4-549"><a href="#cb4-549" aria-hidden="true" tabindex="-1"></a>                  <span class="at">preProcess=</span><span class="fu">c</span>(<span class="st">"center"</span>,<span class="st">"scale"</span>),</span>
<span id="cb4-550"><a href="#cb4-550" aria-hidden="true" tabindex="-1"></a>                  <span class="at">tuneGrid=</span><span class="fu">expand.grid</span>(<span class="at">size=</span><span class="dv">5</span>,<span class="at">decay=</span><span class="fl">0.1</span>), <span class="at">linout=</span><span class="cn">TRUE</span>, <span class="at">trace=</span><span class="cn">FALSE</span>, <span class="at">MaxNWts=</span><span class="dv">5000</span>)</span>
<span id="cb4-551"><a href="#cb4-551" aria-hidden="true" tabindex="-1"></a>svm_ts  <span class="ot">&lt;-</span> <span class="fu">fit_ts</span>(<span class="st">"svmRadial"</span>, R3haddock <span class="sc">~</span> ., train_ts, ctrl_ts, <span class="at">preProcess=</span><span class="fu">c</span>(<span class="st">"center"</span>,<span class="st">"scale"</span>), <span class="at">tuneLength=</span><span class="dv">8</span>)</span>
<span id="cb4-552"><a href="#cb4-552" aria-hidden="true" tabindex="-1"></a>knn_ts  <span class="ot">&lt;-</span> <span class="fu">fit_ts</span>(<span class="st">"knn"</span>,       R3haddock <span class="sc">~</span> ., train_ts, ctrl_ts, <span class="at">preProcess=</span><span class="fu">c</span>(<span class="st">"center"</span>,<span class="st">"scale"</span>), <span class="at">tuneLength=</span><span class="dv">15</span>)</span>
<span id="cb4-553"><a href="#cb4-553" aria-hidden="true" tabindex="-1"></a>enet_ts <span class="ot">&lt;-</span> <span class="fu">fit_ts</span>(<span class="st">"glmnet"</span>,    R3haddock <span class="sc">~</span> ., train_ts, ctrl_ts, <span class="at">preProcess=</span><span class="fu">c</span>(<span class="st">"center"</span>,<span class="st">"scale"</span>), <span class="at">tuneLength=</span><span class="dv">10</span>)</span>
<span id="cb4-554"><a href="#cb4-554" aria-hidden="true" tabindex="-1"></a>mars_ts <span class="ot">&lt;-</span> <span class="fu">fit_ts</span>(<span class="st">"earth"</span>,     R3haddock <span class="sc">~</span> ., train_ts, ctrl_ts, <span class="at">tuneLength=</span><span class="dv">10</span>)</span>
<span id="cb4-555"><a href="#cb4-555" aria-hidden="true" tabindex="-1"></a>pls_ts  <span class="ot">&lt;-</span> <span class="fu">fit_ts</span>(<span class="st">"pls"</span>,       R3haddock <span class="sc">~</span> ., train_ts, ctrl_ts, <span class="at">preProcess=</span><span class="fu">c</span>(<span class="st">"center"</span>,<span class="st">"scale"</span>), <span class="at">tuneLength=</span><span class="dv">10</span>)</span>
<span id="cb4-556"><a href="#cb4-556" aria-hidden="true" tabindex="-1"></a>cub_ts  <span class="ot">&lt;-</span> <span class="fu">fit_ts</span>(<span class="st">"cubist"</span>,    R3haddock <span class="sc">~</span> ., train_ts, ctrl_ts, <span class="at">tuneLength=</span><span class="dv">5</span>)</span>
<span id="cb4-557"><a href="#cb4-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-558"><a href="#cb4-558" aria-hidden="true" tabindex="-1"></a>models_ts <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">LM=</span>lm_ts, <span class="at">GLM=</span>glm_ts, <span class="at">GAM=</span>gam_ts, <span class="at">RF=</span>rf_ts, <span class="at">XGB=</span>xgb_ts, <span class="at">RANGER=</span>rgr_ts,</span>
<span id="cb4-559"><a href="#cb4-559" aria-hidden="true" tabindex="-1"></a>                  <span class="at">NNET=</span>nnet_ts, <span class="at">SVM=</span>svm_ts, <span class="at">kNN=</span>knn_ts, <span class="at">ENet=</span>enet_ts, <span class="at">MARS=</span>mars_ts, <span class="at">PLS=</span>pls_ts, <span class="at">CUBIST=</span>cub_ts)</span>
<span id="cb4-560"><a href="#cb4-560" aria-hidden="true" tabindex="-1"></a>models_ts <span class="ot">&lt;-</span> models_ts[<span class="sc">!</span><span class="fu">vapply</span>(models_ts, is.null, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb4-561"><a href="#cb4-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-562"><a href="#cb4-562" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.5 Ранжирование по time-slice CV и по хронологическому тесту</span></span>
<span id="cb4-563"><a href="#cb4-563" aria-hidden="true" tabindex="-1"></a><span class="co"># Сначала ранжируем по средним ошибкам на валидационных срезах, затем — по внешнему тесту.</span></span>
<span id="cb4-564"><a href="#cb4-564" aria-hidden="true" tabindex="-1"></a>cv_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(m) {</span>
<span id="cb4-565"><a href="#cb4-565" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(m<span class="sc">$</span>pred) <span class="sc">||</span> <span class="sc">!</span><span class="st">"Resample"</span> <span class="sc">%in%</span> <span class="fu">names</span>(m<span class="sc">$</span>pred)) <span class="fu">return</span>(<span class="fu">c</span>(<span class="at">RMSE=</span><span class="cn">NA</span>, <span class="at">MAE=</span><span class="cn">NA</span>))</span>
<span id="cb4-566"><a href="#cb4-566" aria-hidden="true" tabindex="-1"></a>  by_slice <span class="ot">&lt;-</span> m<span class="sc">$</span>pred <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Resample) <span class="sc">%&gt;%</span></span>
<span id="cb4-567"><a href="#cb4-567" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">RMSE=</span><span class="fu">rmse</span>(obs,pred), <span class="at">MAE=</span><span class="fu">mae</span>(obs,pred), <span class="at">.groups=</span><span class="st">"drop"</span>)</span>
<span id="cb4-568"><a href="#cb4-568" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">RMSE =</span> <span class="fu">mean</span>(by_slice<span class="sc">$</span>RMSE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">MAE =</span> <span class="fu">mean</span>(by_slice<span class="sc">$</span>MAE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-569"><a href="#cb4-569" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-570"><a href="#cb4-570" aria-hidden="true" tabindex="-1"></a>cv_rank <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(models_ts, cv_metrics)) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb4-571"><a href="#cb4-571" aria-hidden="true" tabindex="-1"></a>cv_rank<span class="sc">$</span>Model <span class="ot">&lt;-</span> <span class="fu">rownames</span>(cv_rank)</span>
<span id="cb4-572"><a href="#cb4-572" aria-hidden="true" tabindex="-1"></a>cv_rank <span class="ot">&lt;-</span> cv_rank[<span class="fu">is.finite</span>(cv_rank<span class="sc">$</span>RMSE), ] <span class="sc">%&gt;%</span> <span class="fu">relocate</span>(Model) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(RMSE, MAE)</span>
<span id="cb4-573"><a href="#cb4-573" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Time-slice CV (h=3), средние RMSE/MAE:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(cv_rank)</span>
<span id="cb4-574"><a href="#cb4-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-575"><a href="#cb4-575" aria-hidden="true" tabindex="-1"></a>preds_ts <span class="ot">&lt;-</span> <span class="fu">lapply</span>(models_ts, <span class="cf">function</span>(m) <span class="fu">try</span>(<span class="fu">predict</span>(m, <span class="at">newdata =</span> test_ts), <span class="cn">TRUE</span>))</span>
<span id="cb4-576"><a href="#cb4-576" aria-hidden="true" tabindex="-1"></a>keep <span class="ot">&lt;-</span> <span class="fu">vapply</span>(preds_ts, <span class="cf">function</span>(p) <span class="fu">is.numeric</span>(p) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(p)<span class="sc">==</span><span class="fu">nrow</span>(test_ts) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(<span class="fu">is.finite</span>(p)), <span class="fu">logical</span>(<span class="dv">1</span>))</span>
<span id="cb4-577"><a href="#cb4-577" aria-hidden="true" tabindex="-1"></a>preds_ts <span class="ot">&lt;-</span> preds_ts[keep]</span>
<span id="cb4-578"><a href="#cb4-578" aria-hidden="true" tabindex="-1"></a>test_rank <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="fu">names</span>(preds_ts), <span class="cf">function</span>(nm){</span>
<span id="cb4-579"><a href="#cb4-579" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Model=</span>nm, <span class="fu">t</span>(<span class="fu">metrics_vec</span>(test_ts<span class="sc">$</span>R3haddock, preds_ts[[nm]])), <span class="at">row.names =</span> <span class="cn">NULL</span>)</span>
<span id="cb4-580"><a href="#cb4-580" aria-hidden="true" tabindex="-1"></a>})) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(RMSE, MAE)</span>
<span id="cb4-581"><a href="#cb4-581" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Хронологический тест (последние годы), RMSE/MAE/R2:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(test_rank)</span>
<span id="cb4-582"><a href="#cb4-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-583"><a href="#cb4-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-584"><a href="#cb4-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-585"><a href="#cb4-585" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb4-586"><a href="#cb4-586" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) ПРОГНОЗ 2022–2024 (АНСАМБЛЬ CUBIST+LM) И ГРАФИК 1990–2024 С ДИ</span></span>
<span id="cb4-587"><a href="#cb4-587" aria-hidden="true" tabindex="-1"></a><span class="co"># Прогнозные линии (медиана и ДИ) — пунктир; исторические — сплошные.</span></span>
<span id="cb4-588"><a href="#cb4-588" aria-hidden="true" tabindex="-1"></a><span class="co"># Можно задать свои сценарии предикторов (user_future); по умолчанию — средние.</span></span>
<span id="cb4-589"><a href="#cb4-589" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------------------</span></span>
<span id="cb4-590"><a href="#cb4-590" aria-hidden="true" tabindex="-1"></a><span class="co"># Логика ансамбля: комбинируем сильную нелинейную модель (Cubist) с простой и</span></span>
<span id="cb4-591"><a href="#cb4-591" aria-hidden="true" tabindex="-1"></a><span class="co"># устойчивой линейной (LM). Веса можно настраивать. Доверительные интервалы</span></span>
<span id="cb4-592"><a href="#cb4-592" aria-hidden="true" tabindex="-1"></a><span class="co"># получаем эмпирически из распределения остатков (простая и наглядная эвристика).</span></span>
<span id="cb4-593"><a href="#cb4-593" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb4-594"><a href="#cb4-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-595"><a href="#cb4-595" aria-hidden="true" tabindex="-1"></a><span class="co"># 4.1 Полные модели для прогноза (на всех данных) и вес ансамбля</span></span>
<span id="cb4-596"><a href="#cb4-596" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"selected_predictors_dataset.csv"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-597"><a href="#cb4-597" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="st">"YEAR"</span> <span class="sc">%in%</span> <span class="fu">names</span>(model_data)) {</span>
<span id="cb4-598"><a href="#cb4-598" aria-hidden="true" tabindex="-1"></a>  model_data<span class="sc">$</span>YEAR <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1990</span>, <span class="at">by =</span> <span class="dv">1</span>, <span class="at">length.out =</span> <span class="fu">nrow</span>(model_data))</span>
<span id="cb4-599"><a href="#cb4-599" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-600"><a href="#cb4-600" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> model_data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(YEAR)</span>
<span id="cb4-601"><a href="#cb4-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-602"><a href="#cb4-602" aria-hidden="true" tabindex="-1"></a>cubist_full <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(R3haddock <span class="sc">~</span> codTSB <span class="sc">+</span> T12 <span class="sc">+</span> I5 <span class="sc">+</span> NAOspring <span class="sc">+</span> haddock68,</span>
<span id="cb4-603"><a href="#cb4-603" aria-hidden="true" tabindex="-1"></a>                            <span class="at">data =</span> model_data, <span class="at">method =</span> <span class="st">"cubist"</span>,</span>
<span id="cb4-604"><a href="#cb4-604" aria-hidden="true" tabindex="-1"></a>                            <span class="at">trControl =</span> caret<span class="sc">::</span><span class="fu">trainControl</span>(<span class="at">method=</span><span class="st">"none"</span>),</span>
<span id="cb4-605"><a href="#cb4-605" aria-hidden="true" tabindex="-1"></a>                            <span class="at">tuneGrid =</span> <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"cubist_model"</span>)) cubist_model<span class="sc">$</span>bestTune <span class="cf">else</span> <span class="cn">NULL</span>,</span>
<span id="cb4-606"><a href="#cb4-606" aria-hidden="true" tabindex="-1"></a>                            <span class="at">tuneLength =</span> <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"cubist_model"</span>)) <span class="dv">1</span> <span class="cf">else</span> <span class="dv">5</span>)</span>
<span id="cb4-607"><a href="#cb4-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-608"><a href="#cb4-608" aria-hidden="true" tabindex="-1"></a>lm_full <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(R3haddock <span class="sc">~</span> codTSB <span class="sc">+</span> T12 <span class="sc">+</span> I5 <span class="sc">+</span> NAOspring <span class="sc">+</span> haddock68,</span>
<span id="cb4-609"><a href="#cb4-609" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> model_data, <span class="at">method =</span> <span class="st">"lm"</span>,</span>
<span id="cb4-610"><a href="#cb4-610" aria-hidden="true" tabindex="-1"></a>                        <span class="at">trControl =</span> caret<span class="sc">::</span><span class="fu">trainControl</span>(<span class="at">method=</span><span class="st">"none"</span>))</span>
<span id="cb4-611"><a href="#cb4-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-612"><a href="#cb4-612" aria-hidden="true" tabindex="-1"></a>alpha_opt <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"alpha_opt"</span>)) alpha_opt <span class="cf">else</span> <span class="fl">0.75</span></span>
<span id="cb4-613"><a href="#cb4-613" aria-hidden="true" tabindex="-1"></a>predict_ensemble <span class="ot">&lt;-</span> <span class="cf">function</span>(newdata, <span class="at">alpha =</span> alpha_opt) {</span>
<span id="cb4-614"><a href="#cb4-614" aria-hidden="true" tabindex="-1"></a>  alpha <span class="sc">*</span> <span class="fu">predict</span>(cubist_full, newdata) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> alpha) <span class="sc">*</span> <span class="fu">predict</span>(lm_full, newdata)</span>
<span id="cb4-615"><a href="#cb4-615" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-616"><a href="#cb4-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-617"><a href="#cb4-617" aria-hidden="true" tabindex="-1"></a><span class="co"># Ансамбль моделей часто дает более точные и устойчивые прогнозы, чем отдельные модели. [[8]]</span></span>
<span id="cb4-618"><a href="#cb4-618" aria-hidden="true" tabindex="-1"></a><span class="co"># В нашем случае:</span></span>
<span id="cb4-619"><a href="#cb4-619" aria-hidden="true" tabindex="-1"></a><span class="co">#   - CUBIST: мощная модель, основанная на правилах, хорошо работающая с табличными данными</span></span>
<span id="cb4-620"><a href="#cb4-620" aria-hidden="true" tabindex="-1"></a><span class="co">#   - LM: простая интерпретируемая модель, устойчивая к шуму</span></span>
<span id="cb4-621"><a href="#cb4-621" aria-hidden="true" tabindex="-1"></a><span class="co">#   - alpha_opt = 0.75: веса ансамбля (75% CUBIST, 25% LM), оптимизированные ранее (см. скрипт "ENS_WEIGHT.R")</span></span>
<span id="cb4-622"><a href="#cb4-622" aria-hidden="true" tabindex="-1"></a><span class="co"># Комбинирование моделей с разными сильными сторонами снижает риск систематических ошибок.</span></span>
<span id="cb4-623"><a href="#cb4-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-624"><a href="#cb4-624" aria-hidden="true" tabindex="-1"></a><span class="co"># 4.2 Остатки для ДИ (из CV, если есть; иначе — по фитам)</span></span>
<span id="cb4-625"><a href="#cb4-625" aria-hidden="true" tabindex="-1"></a><span class="co"># Эмпирические квантилы остатков дают «практические» интервалы прогноза без</span></span>
<span id="cb4-626"><a href="#cb4-626" aria-hidden="true" tabindex="-1"></a><span class="co"># предположения нормальности ошибок (хотя строгий PI требует аккуратности).</span></span>
<span id="cb4-627"><a href="#cb4-627" aria-hidden="true" tabindex="-1"></a>get_residuals_for_pi <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb4-628"><a href="#cb4-628" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"lm_model"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"cubist_model"</span>) <span class="sc">&amp;&amp;</span></span>
<span id="cb4-629"><a href="#cb4-629" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.null</span>(lm_model<span class="sc">$</span>pred) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(cubist_model<span class="sc">$</span>pred)) {</span>
<span id="cb4-630"><a href="#cb4-630" aria-hidden="true" tabindex="-1"></a>    pl <span class="ot">&lt;-</span> lm_model<span class="sc">$</span>pred <span class="sc">%&gt;%</span> <span class="fu">select</span>(Resample,rowIndex,obs,<span class="at">p_lm=</span>pred)</span>
<span id="cb4-631"><a href="#cb4-631" aria-hidden="true" tabindex="-1"></a>    pc <span class="ot">&lt;-</span> cubist_model<span class="sc">$</span>pred <span class="sc">%&gt;%</span> <span class="fu">select</span>(Resample,rowIndex,<span class="at">p_cu=</span>pred)</span>
<span id="cb4-632"><a href="#cb4-632" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(pl, pc, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"Resample"</span>,<span class="st">"rowIndex"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-633"><a href="#cb4-633" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">p_ens =</span> alpha_opt <span class="sc">*</span> p_cu <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> alpha_opt) <span class="sc">*</span> p_lm,</span>
<span id="cb4-634"><a href="#cb4-634" aria-hidden="true" tabindex="-1"></a>             <span class="at">resid =</span> obs <span class="sc">-</span> p_ens) <span class="sc">%&gt;%</span></span>
<span id="cb4-635"><a href="#cb4-635" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pull</span>(resid) <span class="sc">%&gt;%</span> .[<span class="fu">is.finite</span>(.)]</span>
<span id="cb4-636"><a href="#cb4-636" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb4-637"><a href="#cb4-637" aria-hidden="true" tabindex="-1"></a>    model_data<span class="sc">$</span>R3haddock <span class="sc">-</span> <span class="fu">predict_ensemble</span>(model_data)</span>
<span id="cb4-638"><a href="#cb4-638" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-639"><a href="#cb4-639" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-640"><a href="#cb4-640" aria-hidden="true" tabindex="-1"></a>resids <span class="ot">&lt;-</span> <span class="fu">get_residuals_for_pi</span>()</span>
<span id="cb4-641"><a href="#cb4-641" aria-hidden="true" tabindex="-1"></a>q025 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(resids, <span class="fl">0.025</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-642"><a href="#cb4-642" aria-hidden="true" tabindex="-1"></a>q250 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(resids, <span class="fl">0.250</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-643"><a href="#cb4-643" aria-hidden="true" tabindex="-1"></a>q750 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(resids, <span class="fl">0.750</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-644"><a href="#cb4-644" aria-hidden="true" tabindex="-1"></a>q975 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(resids, <span class="fl">0.975</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-645"><a href="#cb4-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-646"><a href="#cb4-646" aria-hidden="true" tabindex="-1"></a><span class="co"># Доверительные интервалы (ДИ) показывают неопределенность прогноза.</span></span>
<span id="cb4-647"><a href="#cb4-647" aria-hidden="true" tabindex="-1"></a><span class="co"># Мы используем квантили остатков из кросс-валидации для построения ДИ:</span></span>
<span id="cb4-648"><a href="#cb4-648" aria-hidden="true" tabindex="-1"></a><span class="co">#   - PI50 (50% интервал): между 25-м и 75-м процентилями</span></span>
<span id="cb4-649"><a href="#cb4-649" aria-hidden="true" tabindex="-1"></a><span class="co">#   - PI95 (95% интервал): между 2.5-м и 97.5-м процентилями</span></span>
<span id="cb4-650"><a href="#cb4-650" aria-hidden="true" tabindex="-1"></a><span class="co"># Это непараметрический подход, не требующий предположений о нормальности ошибок.</span></span>
<span id="cb4-651"><a href="#cb4-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-652"><a href="#cb4-652" aria-hidden="true" tabindex="-1"></a><span class="co"># 4.3 Сценарии будущего (по умолчанию — средние; можно переопределить user_future)</span></span>
<span id="cb4-653"><a href="#cb4-653" aria-hidden="true" tabindex="-1"></a>fc_start <span class="ot">&lt;-</span> <span class="dv">2022</span></span>
<span id="cb4-654"><a href="#cb4-654" aria-hidden="true" tabindex="-1"></a>pred_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"codTSB"</span>,<span class="st">"T12"</span>,<span class="st">"I5"</span>,<span class="st">"NAOspring"</span>,<span class="st">"haddock68"</span>)</span>
<span id="cb4-655"><a href="#cb4-655" aria-hidden="true" tabindex="-1"></a>train_period <span class="ot">&lt;-</span> model_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(YEAR <span class="sc">&gt;</span> <span class="dv">1989</span> <span class="sc">&amp;</span> YEAR <span class="sc">&lt;</span> fc_start)</span>
<span id="cb4-656"><a href="#cb4-656" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> train_period <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(pred_cols), <span class="sc">~</span><span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))) <span class="sc">%&gt;%</span> <span class="fu">as.list</span>()</span>
<span id="cb4-657"><a href="#cb4-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-658"><a href="#cb4-658" aria-hidden="true" tabindex="-1"></a><span class="co"># Пример пользовательского сценария:</span></span>
<span id="cb4-659"><a href="#cb4-659" aria-hidden="true" tabindex="-1"></a><span class="co"># user_future &lt;- tibble::tribble(</span></span>
<span id="cb4-660"><a href="#cb4-660" aria-hidden="true" tabindex="-1"></a><span class="co">#   ~YEAR, ~codTSB, ~T12, ~I5, ~NAOspring, ~haddock68,</span></span>
<span id="cb4-661"><a href="#cb4-661" aria-hidden="true" tabindex="-1"></a><span class="co">#   2022, 2100000, 5.1, 48,  0.3, 120000,</span></span>
<span id="cb4-662"><a href="#cb4-662" aria-hidden="true" tabindex="-1"></a><span class="co">#   2023, 2050000, 4.8, 50, -0.1, 115000,</span></span>
<span id="cb4-663"><a href="#cb4-663" aria-hidden="true" tabindex="-1"></a><span class="co">#   2024, 2150000, 5.0, 47,  0.2, 118000</span></span>
<span id="cb4-664"><a href="#cb4-664" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb4-665"><a href="#cb4-665" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"user_future"</span>)) user_future <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb4-666"><a href="#cb4-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-667"><a href="#cb4-667" aria-hidden="true" tabindex="-1"></a>build_future <span class="ot">&lt;-</span> <span class="cf">function</span>(years, mu, <span class="at">user_df=</span><span class="cn">NULL</span>) {</span>
<span id="cb4-668"><a href="#cb4-668" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">YEAR =</span> years)</span>
<span id="cb4-669"><a href="#cb4-669" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (v <span class="cf">in</span> pred_cols) df[[v]] <span class="ot">&lt;-</span> mu[[v]]</span>
<span id="cb4-670"><a href="#cb4-670" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(user_df)) {</span>
<span id="cb4-671"><a href="#cb4-671" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(user_df))) {</span>
<span id="cb4-672"><a href="#cb4-672" aria-hidden="true" tabindex="-1"></a>      yr <span class="ot">&lt;-</span> user_df<span class="sc">$</span>YEAR[i]</span>
<span id="cb4-673"><a href="#cb4-673" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (yr <span class="sc">%in%</span> years) {</span>
<span id="cb4-674"><a href="#cb4-674" aria-hidden="true" tabindex="-1"></a>        idx <span class="ot">&lt;-</span> <span class="fu">which</span>(df<span class="sc">$</span>YEAR <span class="sc">==</span> yr)</span>
<span id="cb4-675"><a href="#cb4-675" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (v <span class="cf">in</span> <span class="fu">intersect</span>(pred_cols, <span class="fu">names</span>(user_df))) {</span>
<span id="cb4-676"><a href="#cb4-676" aria-hidden="true" tabindex="-1"></a>          val <span class="ot">&lt;-</span> user_df[[v]][i]</span>
<span id="cb4-677"><a href="#cb4-677" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(val)) df[[v]][idx] <span class="ot">&lt;-</span> val</span>
<span id="cb4-678"><a href="#cb4-678" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-679"><a href="#cb4-679" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb4-680"><a href="#cb4-680" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-681"><a href="#cb4-681" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-682"><a href="#cb4-682" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb4-683"><a href="#cb4-683" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-684"><a href="#cb4-684" aria-hidden="true" tabindex="-1"></a>future_years <span class="ot">&lt;-</span> fc_start<span class="sc">:</span><span class="dv">2024</span></span>
<span id="cb4-685"><a href="#cb4-685" aria-hidden="true" tabindex="-1"></a>scenario_future <span class="ot">&lt;-</span> <span class="fu">build_future</span>(future_years, mu, user_future)</span>
<span id="cb4-686"><a href="#cb4-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-687"><a href="#cb4-687" aria-hidden="true" tabindex="-1"></a><span class="co"># 4.4 Прогноз и таблица ДИ</span></span>
<span id="cb4-688"><a href="#cb4-688" aria-hidden="true" tabindex="-1"></a>pred_future <span class="ot">&lt;-</span> <span class="fu">predict_ensemble</span>(scenario_future)</span>
<span id="cb4-689"><a href="#cb4-689" aria-hidden="true" tabindex="-1"></a>forecast_tbl <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb4-690"><a href="#cb4-690" aria-hidden="true" tabindex="-1"></a>  <span class="at">YEAR      =</span> scenario_future<span class="sc">$</span>YEAR,</span>
<span id="cb4-691"><a href="#cb4-691" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_mean =</span> <span class="fu">as.numeric</span>(pred_future),</span>
<span id="cb4-692"><a href="#cb4-692" aria-hidden="true" tabindex="-1"></a>  <span class="at">PI50_low  =</span> pred_future <span class="sc">+</span> q250, <span class="at">PI50_high =</span> pred_future <span class="sc">+</span> q750,</span>
<span id="cb4-693"><a href="#cb4-693" aria-hidden="true" tabindex="-1"></a>  <span class="at">PI95_low  =</span> pred_future <span class="sc">+</span> q025, <span class="at">PI95_high =</span> pred_future <span class="sc">+</span> q975</span>
<span id="cb4-694"><a href="#cb4-694" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-695"><a href="#cb4-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-696"><a href="#cb4-696" aria-hidden="true" tabindex="-1"></a><span class="do">#### Таблица прогноза 2022–2024</span></span>
<span id="cb4-697"><a href="#cb4-697" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(forecast_tbl)</span>
<span id="cb4-698"><a href="#cb4-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-699"><a href="#cb4-699" aria-hidden="true" tabindex="-1"></a><span class="co"># По умолчанию мы используем средние значения предикторов для прогноза.</span></span>
<span id="cb4-700"><a href="#cb4-700" aria-hidden="true" tabindex="-1"></a><span class="co"># Однако вы можете определить собственный сценарий (user_future), указав конкретные значения</span></span>
<span id="cb4-701"><a href="#cb4-701" aria-hidden="true" tabindex="-1"></a><span class="co"># для каждого года и каждого предиктора. Это позволяет моделировать различные экологические сценарии. </span></span>
<span id="cb4-702"><a href="#cb4-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-703"><a href="#cb4-703" aria-hidden="true" tabindex="-1"></a><span class="co"># 4.5 Непрерывный ряд 1990–2024 и график: ленты сплошные; линии медианы/ДИ — сплошные до 2021, пунктир с 2022</span></span>
<span id="cb4-704"><a href="#cb4-704" aria-hidden="true" tabindex="-1"></a>pred_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb4-705"><a href="#cb4-705" aria-hidden="true" tabindex="-1"></a>  model_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(YEAR, <span class="fu">all_of</span>(pred_cols)),</span>
<span id="cb4-706"><a href="#cb4-706" aria-hidden="true" tabindex="-1"></a>  scenario_future</span>
<span id="cb4-707"><a href="#cb4-707" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(YEAR, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(YEAR)</span>
<span id="cb4-708"><a href="#cb4-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-709"><a href="#cb4-709" aria-hidden="true" tabindex="-1"></a>pred_df<span class="sc">$</span>Pred      <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">predict_ensemble</span>(pred_df))</span>
<span id="cb4-710"><a href="#cb4-710" aria-hidden="true" tabindex="-1"></a>pred_df<span class="sc">$</span>PI50_low  <span class="ot">&lt;-</span> pred_df<span class="sc">$</span>Pred <span class="sc">+</span> q250</span>
<span id="cb4-711"><a href="#cb4-711" aria-hidden="true" tabindex="-1"></a>pred_df<span class="sc">$</span>PI50_high <span class="ot">&lt;-</span> pred_df<span class="sc">$</span>Pred <span class="sc">+</span> q750</span>
<span id="cb4-712"><a href="#cb4-712" aria-hidden="true" tabindex="-1"></a>pred_df<span class="sc">$</span>PI95_low  <span class="ot">&lt;-</span> pred_df<span class="sc">$</span>Pred <span class="sc">+</span> q025</span>
<span id="cb4-713"><a href="#cb4-713" aria-hidden="true" tabindex="-1"></a>pred_df<span class="sc">$</span>PI95_high <span class="ot">&lt;-</span> pred_df<span class="sc">$</span>Pred <span class="sc">+</span> q975</span>
<span id="cb4-714"><a href="#cb4-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-715"><a href="#cb4-715" aria-hidden="true" tabindex="-1"></a>hist_df <span class="ot">&lt;-</span> model_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(YEAR, R3haddock)</span>
<span id="cb4-716"><a href="#cb4-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-717"><a href="#cb4-717" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb4-718"><a href="#cb4-718" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> pred_df, <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">ymin =</span> PI95_low, <span class="at">ymax =</span> PI95_high),</span>
<span id="cb4-719"><a href="#cb4-719" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey80"</span>, <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb4-720"><a href="#cb4-720" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> pred_df, <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">ymin =</span> PI50_low, <span class="at">ymax =</span> PI50_high),</span>
<span id="cb4-721"><a href="#cb4-721" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey60"</span>, <span class="at">alpha =</span> <span class="fl">0.35</span>) <span class="sc">+</span></span>
<span id="cb4-722"><a href="#cb4-722" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(pred_df, YEAR <span class="sc">&lt;</span> fc_start), <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">y =</span> PI95_low),</span>
<span id="cb4-723"><a href="#cb4-723" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey45"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb4-724"><a href="#cb4-724" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(pred_df, YEAR <span class="sc">&lt;</span> fc_start), <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">y =</span> PI95_high),</span>
<span id="cb4-725"><a href="#cb4-725" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey45"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb4-726"><a href="#cb4-726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(pred_df, YEAR <span class="sc">&lt;</span> fc_start), <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">y =</span> PI50_low),</span>
<span id="cb4-727"><a href="#cb4-727" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey35"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb4-728"><a href="#cb4-728" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(pred_df, YEAR <span class="sc">&lt;</span> fc_start), <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">y =</span> PI50_high),</span>
<span id="cb4-729"><a href="#cb4-729" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey35"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb4-730"><a href="#cb4-730" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(pred_df, YEAR <span class="sc">&gt;=</span> fc_start<span class="dv">-1</span>), <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">y =</span> PI95_low),</span>
<span id="cb4-731"><a href="#cb4-731" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey45"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb4-732"><a href="#cb4-732" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(pred_df, YEAR <span class="sc">&gt;=</span> fc_start<span class="dv">-1</span>), <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">y =</span> PI95_high),</span>
<span id="cb4-733"><a href="#cb4-733" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey45"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb4-734"><a href="#cb4-734" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(pred_df, YEAR <span class="sc">&gt;=</span> fc_start<span class="dv">-1</span>), <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">y =</span> PI50_low),</span>
<span id="cb4-735"><a href="#cb4-735" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey35"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb4-736"><a href="#cb4-736" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(pred_df, YEAR <span class="sc">&gt;=</span> fc_start<span class="dv">-1</span>), <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">y =</span> PI50_high),</span>
<span id="cb4-737"><a href="#cb4-737" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey35"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb4-738"><a href="#cb4-738" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(pred_df, YEAR <span class="sc">&lt;</span> fc_start), <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">y =</span> Pred),</span>
<span id="cb4-739"><a href="#cb4-739" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"steelblue4"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb4-740"><a href="#cb4-740" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">subset</span>(pred_df, YEAR <span class="sc">&gt;=</span> fc_start<span class="dv">-1</span>), <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">y =</span> Pred),</span>
<span id="cb4-741"><a href="#cb4-741" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"steelblue4"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb4-742"><a href="#cb4-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> hist_df, <span class="fu">aes</span>(<span class="at">x =</span> YEAR, <span class="at">y =</span> R3haddock),</span>
<span id="cb4-743"><a href="#cb4-743" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb4-744"><a href="#cb4-744" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))) <span class="sc">+</span></span>
<span id="cb4-745"><a href="#cb4-745" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-746"><a href="#cb4-746" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Пополнение R3haddock: факт (1990–2021) и прогноз (2022–2024)</span><span class="sc">\n</span><span class="st">Ансамбль CUBIST+LM; непрерывные ДИ, прогноз — пунктир"</span>,</span>
<span id="cb4-747"><a href="#cb4-747" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Год"</span>, <span class="at">y =</span> <span class="st">"R3haddock"</span></span>
<span id="cb4-748"><a href="#cb4-748" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-749"><a href="#cb4-749" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb4-750"><a href="#cb4-750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb4-751"><a href="#cb4-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-752"><a href="#cb4-752" aria-hidden="true" tabindex="-1"></a><span class="co"># На графике:</span></span>
<span id="cb4-753"><a href="#cb4-753" aria-hidden="true" tabindex="-1"></a><span class="co">#   - Черные точки: исторические данные (1990-2021)</span></span>
<span id="cb4-754"><a href="#cb4-754" aria-hidden="true" tabindex="-1"></a><span class="co">#   - Сплошная синяя линия: прогнозные значения (1990-2021)</span></span>
<span id="cb4-755"><a href="#cb4-755" aria-hidden="true" tabindex="-1"></a><span class="co">#   - Пунктирная синяя линия: прогноз на 2022-2024</span></span>
<span id="cb4-756"><a href="#cb4-756" aria-hidden="true" tabindex="-1"></a><span class="co">#   - Серые ленты: 50% и 95% доверительные интервалы</span></span>
<span id="cb4-757"><a href="#cb4-757" aria-hidden="true" tabindex="-1"></a><span class="co"># Такая визуализация позволяет легко интерпретировать как исторические данные, </span></span>
<span id="cb4-758"><a href="#cb4-758" aria-hidden="true" tabindex="-1"></a><span class="co"># так и будущие прогнозы с учетом неопределенности.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./chapter 6.html" class="pagination-link" aria-label="Продукционная модель JABBA">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Продукционная модель JABBA</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./chapter 8.html" class="pagination-link" aria-label="Введение в прогнозирование">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Введение в прогнозирование</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>